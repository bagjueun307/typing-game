<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff1a1a; --blue: #1a75ff; --dark: #050505; --gold: #ffea00; --neon: #00ff41; --gray: #333; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; transition: background 0.3s; }
        
        /* íŒ€ë³„ ë°°ê²½ìƒ‰ ëª¨ë“œ */
        body.team-red { background-color: rgba(255, 26, 26, 0.9); }
        body.team-blue { background-color: rgba(26, 117, 255, 0.9); }

        /* ìƒë‹¨ UI ë ˆì´ì•„ì›ƒ */
        #header { height: 180px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; border-bottom: 4px solid #fff; }
        #main-timer { font-size: 3.5rem; color: var(--gold); margin: 5px 0; }
        
        .territory-container { display: flex; gap: 10px; justify-content: center; width: 98%; }
        .sector-card { background: #222; border: 2px solid #555; padding: 10px; width: 180px; text-align: center; border-radius: 10px; position: relative; color: #fff; }
        .sector-card.won-red { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; background: #600; }
        .sector-card.won-blue { border-color: #004cff; box-shadow: 0 0 15px #004cff; background: #002366; }
        
        .step-icon { font-size: 2rem; margin-bottom: 5px; color: var(--gold); }
        .step-name { font-size: 0.8rem; color: #aaa; }
        .prog-bar { font-size: 1.1rem; font-weight: bold; color: var(--neon); }
        
        .up-btn { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); background: var(--gold); border: 2px solid #000; padding: 5px 15px; font-family: 'DungGeunMo'; font-weight: bold; cursor: pointer; display: none; z-index: 100; animation: blink 0.5s infinite; }

        /* ì…”í”Œ ë°” */
        #shuffle-container { width: 100%; height: 15px; background: #000; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 1s linear; }

        /* ë‹¨ì–´ íŒ (100ê°œ ìŠ¤í¬ë¡¤ ì—†ì´ ë°°ì¹˜) */
        #game-board { height: calc(100vh - 300px); display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); gap: 3px; padding: 10px; box-sizing: border-box; }
        .card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: #fff; transition: 0.2s; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        .card.red { background: var(--red) !important; color: #fff; border: 2px solid #fff; }
        .card.blue { background: var(--blue) !important; color: #fff; border: 2px solid #fff; }

        /* ì…ë ¥ì°½ */
        #footer { height: 100px; display: flex; align-items: center; background: rgba(0,0,0,0.9); }
        #word-input { width: 100%; height: 100%; background: transparent; border: none; font-size: 5rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        /* íŠ¹ìˆ˜ íš¨ê³¼ */
        #bonus-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--gold); color: #000; padding: 30px 60px; font-size: 4rem; z-index: 1000; display: none; border: 10px double #000; }
        #surveillance { position: fixed; inset: 0; background: rgba(255,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; font-size: 6rem; color: #fff; text-shadow: 0 0 20px #000; pointer-events: none; }

        /* ì˜¤ë²„ë ˆì´ ì°½ */
        #lobby, #result-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-big { padding: 30px 80px; font-size: 3rem; background: var(--gold); font-family: 'DungGeunMo'; cursor: pointer; border: none; border-radius: 20px; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body id="main-body">

<div id="lobby">
    <h1 style="font-size: 5rem; color: var(--gold); margin-bottom: 50px;">NATION BUILDER</h1>
    <button class="btn-big" onclick="GAME.requestStart()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="header">
    <div id="main-timer">02:00</div>
    <div class="territory-container" id="territory-container"></div>
</div>
<div id="shuffle-container"><div id="shuffle-bar"></div></div>

<div id="game-board"></div>

<div id="footer">
    <input type="text" id="word-input" autocomplete="off" disabled>
</div>

<div id="bonus-msg">ë³´ë„ˆìŠ¤: <span id="bonus-word"></span></div>
<div id="surveillance">ğŸš¨ ê°ì‹œ ì¤‘! ğŸš¨</div>

<div id="result-screen" style="display:none;">
    <h1 style="font-size: 4rem; color: var(--gold); margin-bottom: 30px;">ë¼ìš´ë“œ í†µê³„</h1>
    <div id="result-content" style="display:flex; gap:30px; margin-bottom:40px;"></div>
    <div style="display:flex; gap:20px;">
        <button class="btn-big" style="font-size:1.5rem;" onclick="GAME.closeResult()">ê²°ê³¼ ë‹«ê¸°</button>
        <button class="btn-big" style="font-size:1.5rem; background:var(--neon);" onclick="GAME.requestStart()">ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</button>
    </div>
</div>

<script>
const CONFIG = {
    sectors: ['ì—ë„ˆì§€', 'ì¸í”„ë¼', 'ìë³¸', 'ê¸°ìˆ ', 'ë¬¸í™”'],
    levels: ['ê³µí„°', 'ë§ˆì„', 'ë„ì‹œ', 'ê°œë°œë„ìƒêµ­', 'ì„ ì§„êµ­'],
    icons: ['fa-seedling', 'fa-home', 'fa-city', 'fa-industry', 'fa-crown'],
    wordPool: {
        'ì—ë„ˆì§€': ['ì„ìœ ','ì „ê¸°','ì›ìë ¥','íƒœì–‘ê´‘','ë°°í„°ë¦¬','ì„íƒ„','ê°€ìŠ¤','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ì†¡ì „','ì „ì••','ë°œì „','íƒ„ì†Œ','ì—°ë£Œ','ê·¸ë¦¬ë“œ','ë³€ì „','ì—”ì§„','ì¶©ì „','ë°©ì‚¬ëŠ¥'],
        'ì¸í”„ë¼': ['ë„ë¡œ','ì² ë„','í•­ë§Œ','ê³µí•­','êµëŸ‰','í„°ë„','ë¹Œë”©','ê°•ì² ','ì‹œë©˜íŠ¸','í¬ë ˆì¸','ìƒìˆ˜ë„','ê±´ì„¤','ë¬¼ë¥˜','ìœ í†µ','ì„¤ê³„','ë„ì‹œ','í†µì‹ ','ë²½ëŒ','ì¤‘ì¥ë¹„','ì •ë¹„'],
        'ìë³¸': ['ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ì€í–‰','ê¸ˆë¦¬','í™˜ìœ¨','ì„¸ê¸ˆ','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','í€ë“œ','ê²½ì œ','í™”í','ë¹„ìš©','ìì‚°','ë¬´ì—­','ì½”ì¸','ë°°ë‹¹','ì¦ì‹œ','ë¶€ì±„'],
        'ê¸°ìˆ ': ['AI','ë¡œë´‡','ì½”ë”©','ë³´ì•ˆ','ì„œë²„','ë°˜ë„ì²´','ë°ì´í„°','ì–‘ì','í•´í‚¹','ë“œë¡ ','ìœ„ì„±','ì„¼ì„œ','ë°±ì‹ ','ëª¨ë°”ì¼','ì¹©','ì†ŒìŠ¤','íšŒë¡œ','ë¨¸ì‹ ','ì¸í„°ë„·','ì›¹'],
        'ë¬¸í™”': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ','ì–¸ì–´','ì‹¬ë¦¬','ë¯¸ë””ì–´','ì˜ˆìˆ ','ì˜í™”','ìŒì•…','ì¶•ì œ','ìœ ì‚°','í•œê¸€','ì¢…êµ','ì „í†µ','ì •ì‹ ']
    }
};

const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_final_v1');

const GAME = {
    team: 'red',
    slot: 'm' + (new URLSearchParams(window.location.search).get('m') || '1'),
    active: false,

    init() {
        this.renderSectors();
        this.listenFirebase();
        this.bindEvents();
    },

    renderSectors() {
        const container = document.getElementById('territory-container');
        container.innerHTML = CONFIG.sectors.map((s, i) => `
            <div class="sector-card" id="sector-${i}">
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE</button>
                <i class="fas ${CONFIG.icons[0]} step-icon" id="icon-${i}"></i>
                <div class="step-name" id="step-name-${i}">ê³µí„°</div>
                <div style="font-weight:bold; font-size:1.2rem; margin:5px 0;">${s}</div>
                <div class="prog-bar" id="prog-${i}">0 / 5</div>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDB();
            this.sync(data);
        });
    },

    resetDB() {
        db.set({
            state: 'READY', timer: 120, shuffle: 10,
            words: Object.values(CONFIG.wordPool).flat().sort(()=>Math.random()-0.5),
            cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1:'red', m2:'red', m3:'blue', m4:'blue' },
            bonus: "", surveillance: false
        });
    },

    sync(data) {
        // 1. ìƒíƒœ ì „í™˜
        document.getElementById('lobby').style.display = (data.state === 'READY') ? 'flex' : 'none';
        document.getElementById('result-screen').style.display = (data.state === 'FINISHED') ? 'flex' : 'none';
        
        // 2. ë°°ê²½ìƒ‰ìœ¼ë¡œ íŒ€ êµ¬ë¶„ (ì „ì²´ ë°°ê²½)
        this.team = data.teams[this.slot];
        const body = document.getElementById('main-body');
        body.className = (this.team === 'red') ? 'team-red' : 'team-blue';
        document.getElementById('word-input').disabled = (data.state !== 'RUNNING');
        
        // 3. íƒ€ì´ë¨¸ ë° ì…”í”Œë°”
        document.getElementById('main-timer').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffle / 10) * 100 + "%";

        // 4. ë‹¨ì–´ ì¹´ë“œ (100ê°œ ê·¸ë¦¬ë“œ)
        const board = document.getElementById('game-board');
        if(board.childElementCount === 0) {
            board.innerHTML = data.words.map(w => `<div class="card" id="card-${w}">${w}</div>`).join('');
        }
        
        const myCounts = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, team]) => {
            const el = document.getElementById(`card-${word}`);
            if(el) el.className = `card ${team}`;
            if(team === this.team) {
                const sIdx = this.getSectorIdx(word);
                if(sIdx !== -1) myCounts[sIdx]++;
            }
        });

        // 5. ì˜í†  ì‹œê°í™” (ì•„ì´ì½˜ ë‹¨ê³„ë³„ ë³€í™”)
        CONFIG.sectors.forEach((_, i) => {
            const rL = data.levels.red[i], bL = data.levels.blue[i], myL = data.levels[this.team][i];
            const sectorEl = document.getElementById(`sector-${i}`);
            
            // ì„ ì§„êµ­ ì ë ¹ ì‹œ
            if(rL === 4) sectorEl.className = "sector-card won-red";
            else if(bL === 4) sectorEl.className = "sector-card won-blue";
            else sectorEl.className = "sector-card";

            const maxL = Math.max(rL, bL);
            document.getElementById(`icon-${i}`).className = `fas ${CONFIG.icons[maxL]} step-icon`;
            document.getElementById(`step-name-${i}`).innerText = CONFIG.levels[maxL];
            document.getElementById(`prog-${i}`).innerText = `${myCounts[i]} / 5 (LV.${myL})`;
            
            const upBtn = document.getElementById(`up-btn-${i}`);
            upBtn.style.display = (myCounts[i] >= 5 && myL < 4 && rL < 4 && bL < 4) ? 'block' : 'none';
        });

        // 6. ë³´ë„ˆìŠ¤ ë° ê°ì‹œ
        document.getElementById('bonus-msg').style.display = data.bonus ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonus;
        document.getElementById('surveillance').style.display = data.surveillance ? 'flex' : 'none';

        // 7. ê²°ê³¼ í™”ë©´ ë°ì´í„°
        if(data.state === 'FINISHED') {
            document.getElementById('result-content').innerHTML = ['red','blue'].map(t => `
                <div style="background:#222; padding:20px; border:4px solid var(--${t}); text-align:center;">
                    <h2 style="color:var(--${t}); font-size:2rem;">${t.toUpperCase()} MAFIA</h2>
                    ${CONFIG.sectors.map((s,i)=>`<div>${s}: ${CONFIG.levels[data.levels[t][i]]} <i class="fas ${CONFIG.icons[data.levels[t][i]]}"></i></div>`).join('')}
                </div>
            `).join('');
        }

        // 8. ë§ˆìŠ¤í„° íƒ€ì´ë¨¸ (m1 ëª¨ë‹ˆí„°ë§Œ ì‹¤í–‰)
        if(this.slot === 'm1' && data.state === 'RUNNING' && !this.active) {
            this.active = true;
            this.runMasterLogic();
        }
    },

    runMasterLogic() {
        let bTick = 20, sTick = 30;
        const interval = setInterval(() => {
            db.once('value', snap => {
                const data = snap.val();
                if(data.state !== 'RUNNING') return clearInterval(interval);

                let upd = { timer: data.timer - 1, shuffle: data.shuffle - 1 };
                bTick--; sTick--;

                if(upd.shuffle <= 0) {
                    upd.shuffle = 10;
                    const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                    upd.teams = { m1:ts[0], m2:ts[1], m3:ts[2], m4:ts[3] };
                }
                if(bTick <= 0) {
                    bTick = 20;
                    const pool = Object.values(CONFIG.wordPool).flat();
                    upd.bonus = pool[Math.floor(Math.random()*pool.length)];
                }
                if(sTick <= 0) {
                    sTick = 30;
                    db.update({ surveillance: true });
                    setTimeout(() => db.update({ surveillance: false }), 2000);
                }
                if(upd.timer <= 0) upd.state = 'FINISHED';
                db.update(upd);
            });
        }, 1000);
    },

    requestStart() {
        db.update({ state: 'RUNNING', timer: 120, shuffle: 10, bonus: "", surveillance: false });
    },

    closeResult() { document.getElementById('result-screen').style.display = 'none'; },

    bindEvents() {
        const inp = document.getElementById('word-input');
        inp.onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = inp.value.trim();
                db.once('value', snap => {
                    const data = snap.val();
                    if(data.surveillance) {
                        const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team);
                        if(mine.length > 0) db.child('cards').child(mine[0]).remove();
                    } else if(val === data.bonus) {
                        const enemy = this.team === 'red' ? 'blue' : 'red';
                        const eCards = Object.keys(data.cards||{}).filter(w => data.cards[w] === enemy);
                        eCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                        db.update({ bonus: "" });
                    } else if(data.words.includes(val)) {
                        db.child('cards').child(val).set(this.team);
                    }
                });
                inp.value = "";
            }
        };
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const words = CONFIG.wordPool[CONFIG.sectors[idx]];
            const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team && words.includes(w));
            if(mine.length >= 5) {
                mine.slice(0,5).forEach(w => db.child('cards').child(w).remove());
                const lvs = data.levels[this.team];
                lvs[idx]++;
                db.child('levels').child(this.team).set(lvs);
                if(lvs.filter(v => v === 4).length >= 3) db.update({ state: 'FINISHED' });
            }
        });
    },

    getSectorIdx(w) { return Object.values(CONFIG.wordPool).findIndex(l => l.includes(w)); },
    formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
};

GAME.init();
</script>
</body>
</html>
