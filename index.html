<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„íŠ¸ íƒ€ì í•™êµ V44</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #2e86de; --yellow: #feca57; --dark: #2f3542; --bg: #a29bfe; }
        body { background: var(--bg); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; image-rendering: pixelated; }
        
        #lobby { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 15px double #fff; }
        .start-btn { padding: 20px 60px; font-size: 2.5rem; background: var(--yellow); border: 8px outset #ffda79; cursor: pointer; border-radius: 0; font-family: 'DungGeunMo'; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: #fff; border-bottom: 6px solid var(--dark); display: flex; justify-content: space-around; align-items: center; z-index: 900; color: var(--dark); }
        #timer-disp { font-size: 2.2rem; color: #ff4757; background: var(--dark); padding: 5px 15px; border: 3px solid #666; }
        
        #main-progress-container { position: fixed; top: 65px; left: 0; right: 0; height: 12px; background: #dfe6e9; z-index: 850; border-bottom: 3px solid var(--dark); }
        #main-progress-bar { width: 100%; height: 100%; background: #55efc4; }

        #bonus-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: #fffa65; border: 10px solid var(--dark); padding: 30px; z-index: 1800; border-radius: 0; text-align: center; color: #000; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bonus-popup.active { transform: translate(-50%, -50%) scale(1); }
        .bonus-word { font-size: 4rem; display: block; margin: 15px 0; background: #fff; border: 5px dashed var(--dark); padding: 10px; }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 20px; padding: 100px 20px 20px; box-sizing: border-box; }
        
        .monitor { border: 8px solid var(--dark); display: flex; flex-direction: column; position: relative; overflow: hidden; transition: 0.3s; background: #fff; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); }
        .monitor.team-red { background: #ffbe76; }
        .monitor.team-blue { background: #81ecec; }
        .monitor.focused { position: fixed !important; inset: 80px 30px 30px 30px; width: auto !important; height: auto !important; z-index: 1500; transform: scale(1); }

        .local-gauge-bg { width: 100%; height: 10px; background: #eee; border-bottom: 3px solid var(--dark); }
        .local-gauge-fill { width: 100%; height: 100%; background: #fdcb6e; }

        .teacher-box { font-size: 2rem; text-align: center; padding: 5px; background: rgba(255,255,255,0.5); border-bottom: 3px solid var(--dark); transition: 0.3s; }
        .teacher-box.alert { background: #ffeaa7; color: #d63031; } /* ì„ ìƒë‹˜ ë‚˜ì˜¤ê¸° ì§ì „ ê²½ê³  */
        .teacher-box.watching { background: #ff7675; animation: shake 0.1s infinite; color: #fff; }

        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; flex: 1; padding: 12px; }
        .card-container { height: 42px; perspective: 600px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border: 2px solid var(--dark); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
        .card-front { background: white; color: #333; }
        .card-back { transform: rotateY(180deg); color: white; }
        .back-red { background: var(--red); }
        .back-blue { background: var(--blue); }

        .input-box { width: 100%; padding: 15px; font-family: 'DungGeunMo'; font-size: 2rem; border: none; border-top: 6px solid var(--dark); text-align: center; outline: none; }
        .blurred { filter: blur(8px); opacity: 0.4; pointer-events: none; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 100% { transform: translate(-1px, -1px); } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 4rem; color: #fff; text-shadow: 5px 5px 0 var(--dark);">ğŸ« ë„íŠ¸ íƒ€ì í•™êµ ğŸ«</h1>
    <p style="font-size: 1.5rem;">ì„ ìƒë‹˜ì€ 20ì´ˆë§ˆë‹¤ ê°ì‹œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!</p>
    <button class="start-btn" onclick="triggerStart()">ìˆ˜ì—… ì‹œì‘!</button>
</div>

<div id="top-bar">
    <div style="color:var(--red); font-size: 1.8rem; font-weight: bold;">RED: <span id="total-red">0</span></div>
    <div id="timer-disp">120.0s</div>
    <div style="color:var(--blue); font-size: 1.8rem; font-weight: bold;">BLUE: <span id="total-blue">0</span></div>
</div>

<div id="main-progress-container"><div id="main-progress-bar"></div></div>

<div id="bonus-popup">
    <h2 style="margin:0;">âœ¨ ê³¨ë“  ë³´ë„ˆìŠ¤ ë‹¨ì–´! âœ¨</h2>
    <span class="bonus-word" id="bonus-word-txt">ìŠˆí¼ì»´í“¨í„°</span>
    <p style="margin:0;">ì¹˜ë©´ ìƒëŒ€ ì¹´ë“œ 2ì¥ ëºìŒ!</p>
</div>

<div id="room-view">
    <div class="monitor team-red" id="mon-1" onclick="focusMon(1)">
        <div class="local-gauge-bg"><div id="gauge-1" class="local-gauge-fill"></div></div>
        <div class="teacher-box" id="teach-1">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-1"></div>
        <input type="text" id="input-1" class="input-box" onkeydown="handleInput(event, 1)" placeholder="í´ë¦­í•´ì„œ í™•ëŒ€!">
    </div>
    <div class="monitor team-blue" id="mon-2" onclick="focusMon(2)">
        <div class="local-gauge-bg"><div id="gauge-2" class="local-gauge-fill"></div></div>
        <div class="teacher-box" id="teach-2">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-2"></div>
        <input type="text" id="input-2" class="input-box" onkeydown="handleInput(event, 2)" placeholder="í´ë¦­í•´ì„œ í™•ëŒ€!">
    </div>
    <div class="monitor team-red" id="mon-3" onclick="focusMon(3)">
        <div class="local-gauge-bg"><div id="gauge-3" class="local-gauge-fill"></div></div>
        <div class="teacher-box" id="teach-3">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-3"></div>
        <input type="text" id="input-3" class="input-box" onkeydown="handleInput(event, 3)" placeholder="í´ë¦­í•´ì„œ í™•ëŒ€!">
    </div>
    <div class="monitor team-blue" id="mon-4" onclick="focusMon(4)">
        <div class="local-gauge-bg"><div id="gauge-4" class="local-gauge-fill"></div></div>
        <div class="teacher-box" id="teach-4">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-4"></div>
        <input type="text" id="input-4" class="input-box" onkeydown="handleInput(event, 4)" placeholder="í´ë¦­í•´ì„œ í™•ëŒ€!">
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_v44');

    const words = ["ë–¡ë³¶ì´", "ê¸‰ì‹", "ìš´ë™ì¥", "ë°©í•™", "ì•Œë¦¼ì¥", "ì§ê¿", "ì¤€ë¹„ë¬¼", "ì‹¤ë‚´í™”", "ë”±ì§€", "ìŠ¬ëŸ¬ì‹œ", "í”¼ì¹´ì¸„", "í•™ì›", "ìˆ™ì œ", "ì²´ìœ¡", "ì†Œí’", "ì‰¬ëŠ”ì‹œê°„", "ì§€ìš°ê°œ", "í•„í†µ", "ë¦¬ì½”ë”", "ë°˜ì¥", "ì¼ê¸°", "ë…ì„œ", "í”¼êµ¬", "íƒœê¶Œë„", "ë¬¸ë°©êµ¬", "êµì‹¤", "ë§¤ì ", "ì¹ íŒ", "ë¶„í•„", "ì •ë¬¸", "êµê°€", "í˜„ì¥í•™ìŠµ", "ê°œí•™", "êµì¥ì‹¤", "ê³¼í•™ì‹¤", "ìŒì•…ì‹¤", "ë³µë„", "ì‹¤ë‚´í™”ê°€ë°©", "ë°›ì•„ì“°ê¸°", "ë°©ê³¼í›„"];
    const bonusWords = ["ìŠˆí¼ì»´í“¨í„°", "ìš°ì£¼ìµœê°•", "ë¬´ì§€ê°œë°˜ì‚¬", "í™©ê¸ˆì˜¬ë¦¬ë¸Œ", "ìŠ¤íŒŒê²Œí‹°", "ì¹˜ì¦ˆë²„ê±°", "ì½”ë”©ì²œì¬", "íƒ€ìì™•"];
    
    let monTeams = { 1: 'red', 2: 'blue', 3: 'red', 4: 'blue' };
    let hasStarted = false, isWatching = false, activeBonus = "";

    for(let i=1; i<=4; i++){
        const board = document.getElementById(`board-${i}`);
        words.forEach(w => {
            const card = document.createElement('div');
            card.className = 'card-container'; card.id = `card-${i}-${w}`;
            card.innerHTML = `<div class="card-inner"><div class="card-front">${w}</div><div class="card-back" id="back-${i}-${w}">${w}</div></div>`;
            board.appendChild(card);
        });
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state==='START' && !hasStarted) { hasStarted=true; document.getElementById('lobby').style.display='none'; gameLoop(); }
        activeBonus = d.bonusWord || "";
        document.getElementById('bonus-popup').classList.toggle('active', !!activeBonus);
        if(activeBonus) document.getElementById('bonus-word-txt').innerText = activeBonus;

        words.forEach(w => {
            const owner = d.cards?.[w]?.team;
            for(let i=1; i<=4; i++){
                const c = document.getElementById(`card-${i}-${w}`);
                const b = document.getElementById(`back-${i}-${w}`);
                if(owner) { c.classList.add('is-flipped'); b.className = `card-back back-${owner}`; }
                else { c.classList.remove('is-flipped'); }
            }
        });
        document.getElementById('total-red').innerText = Object.values(d.cards||{}).filter(v=>v.team==='red').length;
        document.getElementById('total-blue').innerText = Object.values(d.cards||{}).filter(v=>v.team==='blue').length;
    });

    function triggerStart() { db.set({ state: 'START', cards: {}, bonusWord: "" }); }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const myTeam = monTeams[id];
            
            if(activeBonus && val === activeBonus) {
                db.update({ bonusWord: "" });
                applyPenalty(myTeam === 'red' ? 'blue' : 'red', 2);
                e.target.value = ''; return;
            }

            if(isWatching) { applyPenalty(myTeam, 1); e.target.value = ''; return; }

            if(words.includes(val)) { db.child('cards').child(val).set({ team: myTeam, t: Date.now() }); }
            e.target.value = '';
        }
    }

    function applyPenalty(team, count) {
        db.child('cards').once('value', snap => {
            const cards = snap.val(); if(!cards) return;
            let targets = Object.keys(cards).filter(k => cards[k].team === team);
            targets.sort((a,b) => cards[b].t - cards[a].t);
            for(let i=0; i<count && i<targets.length; i++) db.child('cards').child(targets[i]).remove();
        });
    }

    function gameLoop() {
        let timeLeft = 1200; // 120ì´ˆ
        setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                document.getElementById('timer-disp').innerText = (timeLeft/10).toFixed(1) + "s";
                document.getElementById('main-progress-bar').style.width = (timeLeft / 1200 * 100) + "%";
                
                const cyclePos = (1200 - timeLeft) % 100; // 10ì´ˆ íŒ€ êµì²´ ì£¼ê¸°
                const watchCycle = (1200 - timeLeft) % 200; // 20ì´ˆ ì„ ìƒë‹˜ ê°ì‹œ ì£¼ê¸°

                // 10ì´ˆë§ˆë‹¤ íŒ€ êµì²´
                if(cyclePos === 0) {
                    for(let i=1; i<=4; i++) {
                        monTeams[i] = (monTeams[i] === 'red') ? 'blue' : 'red';
                        const mon = document.getElementById(`mon-${i}`);
                        mon.className = `monitor team-${monTeams[i]} ` + (mon.classList.contains('focused') ? 'focused' : '');
                    }
                }

                // 20ì´ˆ ì£¼ê¸° ì„ ìƒë‹˜ ê°ì‹œ ë¡œì§ (17~20ì´ˆ ì‚¬ì´)
                isWatching = (watchCycle >= 170); // ë§ˆì§€ë§‰ 3ì´ˆ ê°ì‹œ
                let isAlert = (watchCycle >= 150 && watchCycle < 170); // ê°ì‹œ 2ì´ˆ ì „ ê²½ê³ 

                for(let i=1; i<=4; i++) {
                    const gauge = document.getElementById(`gauge-${i}`);
                    const teach = document.getElementById(`teach-${i}`);
                    gauge.style.width = (100 - cyclePos) + "%";
                    
                    if(isWatching) {
                        teach.innerText = "ğŸš¨!!ê°ì‹œ!!ğŸš¨";
                        teach.className = "teacher-box watching";
                    } else if(isAlert) {
                        teach.innerText = "ğŸ‘€...?!";
                        teach.className = "teacher-box alert";
                    } else {
                        teach.innerText = "ğŸ‘¨â€ğŸ« (ì•ˆë³´ëŠ” ì¤‘)";
                        teach.className = "teacher-box";
                    }
                }

                if(timeLeft % 300 === 0 && timeLeft < 1200) {
                    db.update({ bonusWord: bonusWords[Math.floor(Math.random()*bonusWords.length)] });
                    setTimeout(() => db.update({ bonusWord: "" }), 6000);
                }
            }
        }, 100);
    }

    function focusMon(id) {
        const mon = document.getElementById(`mon-${id}`);
        if(mon.classList.contains('focused')) return;
        document.querySelectorAll('.monitor').forEach(m => m.classList.add('blurred'));
        mon.classList.remove('blurred'); mon.classList.add('focused');
        setTimeout(() => document.getElementById(`input-${id}`).focus(), 150);
    }

    function unfocus() { document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused', 'blurred')); }
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') unfocus(); });
</script>
</body>
</html>
