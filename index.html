<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER v22.1 - ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark: #000; --red: #ff0000; --blue: #0044ff; --yellow: #ffff00; --neon: #00ff00; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo'; margin: 0; overflow: hidden; }
        
        /* 상단 영역: 미등록 텍스트 제거 및 아이콘 강조 */
        #top-bar { height: 90px; background: #0a0a0a; display: flex; align-items: center; justify-content: space-between; padding: 0 50px; border-bottom: 2px solid #333; }
        #timer-disp { font-size: 3.5rem; color: var(--yellow); font-weight: bold; }
        .top-icons { display: flex; gap: 40px; }
        .top-icons i { font-size: 2.8rem; color: #333; transition: 0.3s; }
        
        /* 10초 팀 전환 막대 바 */
        #progress-container { position: absolute; top: 88px; left: 0; width: 100%; height: 10px; background: #222; z-index: 1000; }
        #progress-bar { width: 100%; height: 100%; background: var(--neon); transition: width 0.1s linear; }

        /* 보너스 단어 */
        #bonus-zone { position: fixed; top: 110px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; color: var(--yellow); z-index: 2000; display: none; text-shadow: 0 0 15px #000; font-weight: bold; animation: pulse 0.5s infinite; }

        /* 모니터 및 팀 컬러 연출 (과하게) */
        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 15px; height: calc(100vh - 110px); }
        .monitor { position: relative; border: 8px solid #333; background: #000; transition: 0.2s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 105px 15px 15px 15px; z-index: 5000; border-width: 15px; }
        
        /* 현재 소속 팀 강조 (눈에 띄게) */
        .my-team-red { border-color: var(--red) !important; box-shadow: inset 0 0 150px rgba(255,0,0,0.6); }
        .my-team-blue { border-color: var(--blue) !important; box-shadow: inset 0 0 150px rgba(0,68,255,0.6); }
        .team-label { position: absolute; top: 10px; right: 10px; font-size: 2rem; font-weight: bold; padding: 5px 20px; border-radius: 5px; z-index: 5001; }

        /* 내부 카운트다운 */
        .local-cd { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 9000; display: none; align-items: center; justify-content: center; font-size: 15rem; color: var(--yellow); }

        /* 감시 모드 (30초마다 2초) */
        .radar-overlay { position: absolute; inset: 0; background: rgba(0,255,0,0.1); border: 10px solid var(--neon); z-index: 6000; display: none; align-items: center; justify-content: center; font-size: 4rem; color: var(--neon); pointer-events: none; }

        /* 카드 그리드 */
        .board { flex: 1; display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; padding: 10px; }
        .card { background: #111; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; border: 1px solid #222; color: #444; height: 100%; border-radius: 3px; }
        .card.owned-red { background: var(--red) !important; color: white; border: none; box-shadow: 0 0 5px var(--red); }
        .card.owned-blue { background: var(--blue) !important; color: white; border: none; box-shadow: 0 0 5px var(--blue); }

        .input-wrap { height: 100px; border-top: 5px solid #333; display: flex; }
        .input-box { flex: 1; background: transparent; border: none; font-size: 5rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        #result-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .up-btn { background: var(--neon); border: none; font-family: 'DungGeunMo'; font-size: 0.9rem; cursor: pointer; display: none; padding: 5px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="timer-disp">02:00</div>
    <div class="top-icons">
        <i class="fas fa-bolt" id="ti-0"></i>
        <i class="fas fa-industry" id="ti-1"></i>
        <i class="fas fa-coins" id="ti-2"></i>
        <i class="fas fa-microchip" id="ti-3"></i>
        <i class="fas fa-book" id="ti-4"></i>
    </div>
    <div style="font-size:1.5rem; color:var(--neon)">CYBER_WAR_V22</div>
</div>
<div id="progress-container"><div id="progress-bar"></div></div>
<div id="bonus-zone">BONUS: <span id="bw">---</span></div>

<div id="room-view">
    <script>
        const cityNames = ['발전','강철','자본','미래','지혜'];
        const rankIcons = ['fa-microchip','fa-database','fa-server','fa-shield-virus','fa-globe'];
        const fullWordList = Array.from({length: 100}, (_, i) => `데이터${i+1}`); // 실제 단어 세트로 교체 가능

        for(let i=1; i<=4; i++){
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="local-cd" id="cd-${i}">3</div>
                    <div class="radar-overlay" id="radar-${i}">[ALERT: RADAR SCANNING]</div>
                    <div id="label-${i}" class="team-label"></div>
                    <div class="gate" id="gate-${i}" style="position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:100; display:flex; align-items:center; justify-content:center;">
                        <button onclick="localStart(event, ${i})" style="padding:25px 50px; font-size:2.5rem; font-family:'DungGeunMo'; background:var(--yellow); border:none; cursor:pointer;">CONNECT</button>
                    </div>
                    <div style="display:flex; justify-content:space-around; background:#050505; padding:15px; border-bottom:2px solid #333; margin-top:40px;">
                        ${cityNames.map((c, idx) => `
                            <div style="text-align:center">
                                <i class="fas ${rankIcons[0]}" id="icon-${i}-${idx}" style="font-size:2rem; color:#222"></i><br>
                                <button id="up-${i}-${idx}" class="up-btn" onclick="upgrade(event, ${i}, ${idx})">UP</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="..." disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<div id="result-screen">
    <h1 style="color:var(--yellow); font-size:5rem;">ROUND END</h1>
    <div style="width:600px; height:600px; background:rgba(255,255,255,0.05); padding:20px; border-radius:50%;">
        <canvas id="radarChart"></canvas>
    </div>
    <button onclick="location.reload()" style="margin-top:50px; padding:25px 100px; background:var(--yellow); border:none; font-size:2.5rem; font-family:'DungGeunMo'; cursor:pointer;">NEXT PHASE</button>
</div>

<script>
    // Firebase 설정
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v22_final');
    
    let active = false, pCards = {}, levels = {red:[0,0,0,0,0], blue:[0,0,0,0,0]}, teams = {1:'red', 2:'red', 3:'blue', 4:'blue'}, focusedId = null, bonus = "";

    function zoomIn(id) { focusedId = id; document.querySelectorAll('.monitor').forEach(m=>m.classList.remove('focused')); document.getElementById(`mon-${id}`).classList.add('focused'); }

    function localStart(e, id) {
        e.stopPropagation();
        document.getElementById(`gate-${id}`).style.display = 'none';
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'flex';
        let c = 3;
        const intr = setInterval(() => {
            cd.innerText = c > 0 ? c : "GO!";
            if(c < 0) { clearInterval(intr); cd.style.display = 'none'; document.getElementById(`in-${id}`).disabled = false; document.getElementById(`in-${id}`).focus(); db.update({state: 'RUNNING'}); }
            c--;
        }, 1000);
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        pCards = d.cards || {}; levels = d.levels || levels; teams = d.teams || teams; bonus = d.bonus || "";
        if(d.state === 'RUNNING' && !active) { active = true; startGlobalTimer(); }
        if(d.state === 'FINISHED') showResult();
        updateUI();
    });

    function handleInput(e, id) {
        if(e.key !== 'Enter') return;
        const val = e.target.value.trim();
        const team = teams[id];
        if(val === bonus) { /* 보너스 획득 시 전체 레벨업 혹은 랜덤 카드 점유 */ db.update({bonus: ""}); }
        else if(fullWordList.includes(val)) { db.child('cards').child(val).set(team); }
        e.target.value = "";
    }

    function startGlobalTimer() {
        let time = 120;
        let turnTime = 10;
        const mainIntr = setInterval(() => {
            time--; turnTime--;
            document.getElementById('timer-disp').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
            document.getElementById('progress-bar').style.width = (turnTime/10 * 100) + "%";

            // 10초마다 팀 강제 교환
            if(turnTime <= 0) {
                turnTime = 10;
                if(focusedId === 1) {
                    const nextTeams = {};
                    for(let i=1; i<=4; i++) nextTeams[i] = (teams[i] === 'red' ? 'blue' : 'red');
                    db.update({teams: nextTeams});
                }
            }
            // 20초마다 보너스 문제
            if(time % 20 === 0 && focusedId === 1) db.update({bonus: fullWordList[Math.floor(Math.random()*100)]});
            // 30초마다 2초 감시
            if(time % 30 === 0) {
                document.querySelectorAll('.radar-overlay').forEach(r => r.style.display = 'flex');
                setTimeout(() => document.querySelectorAll('.radar-overlay').forEach(r => r.style.display = 'none'), 2000);
            }
            if(time <= 0) { clearInterval(mainIntr); db.update({state:'FINISHED'}); }
        }, 1000);
    }

    function updateUI() {
        document.getElementById('bonus-zone').style.display = bonus ? 'block' : 'none';
        document.getElementById('bw').innerText = bonus;
        for(let i=1; i<=4; i++) {
            const m = document.getElementById(`mon-${i}`);
            const myTeam = teams[i];
            m.className = `monitor my-team-${myTeam} ${i===focusedId?'focused':''}`;
            document.getElementById(`label-${i}`).innerText = myTeam.toUpperCase();
            document.getElementById(`label-${i}`).style.color = myTeam === 'red' ? 'var(--red)' : 'var(--blue)';
            
            const board = document.getElementById(`board-${i}`);
            board.innerHTML = fullWordList.map(w => `<div class="card ${pCards[w]?'owned-'+pCards[w]:''}">${w}</div>`).join('');
            
            cityNames.forEach((_, idx) => {
                const lv = levels[myTeam][idx];
                const icon = document.getElementById(`icon-${i}-${idx}`);
                icon.className = `fas ${rankIcons[lv]}`;
                icon.style.color = lv > 0 ? (myTeam==='red'?'var(--red)':'var(--blue)') : '#222';
                // 상단 아이콘 동기화
                const maxLv = Math.max(levels.red[idx], levels.blue[idx]);
                document.getElementById(`ti-${idx}`).style.color = maxLv > 0 ? 'var(--yellow)' : '#333';
            });
        }
    }

    function showResult() {
        document.getElementById('result-screen').style.display = 'flex';
        const ctx = document.getElementById('radarChart').getContext('2d');
        const config = {
            type: 'radar',
            data: {
                labels: cityNames,
                datasets: [
                    { label: 'RED', data: levels.red, borderColor: 'red', backgroundColor: 'rgba(255,0,0,0.2)' },
                    { label: 'BLUE', data: levels.blue, borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.2)' }
                ]
            },
            options: {
                scales: { r: { min: 0, max: 4, ticks: { display: false }, grid: { color: '#444' }, pointLabels: { color: '#fff', font: { size: 20 } } } }
            }
        };
        new Chart(ctx, config);
    }
</script>
</body>
</html>
