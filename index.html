<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íƒ€ì ë°°í‹€ V78 - í•˜ìš°ìŠ¤ ì „ê´‘íŒ ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #FF4757; --blue: #2E86DE; --yellow: #FECA57; --dark: #1E272E; --bg: #F1F2F6; }
        body { background: var(--bg); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* [ìƒë‹¨ ë° ìƒíƒœë°”] */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; border-bottom: 5px solid var(--dark); display: flex; justify-content: space-around; align-items: center; z-index: 2000; color: var(--dark); }
        #status-area { position: fixed; top: 60px; left: 0; width: 100%; z-index: 1900; }
        #shuffle-timer-container { height: 25px; background: #222; display: flex; align-items: center; position: relative; overflow: hidden; }
        #shuffle-bar { height: 100%; background: var(--yellow); width: 100%; transition: width 0.1s linear; }
        #shuffle-text { position: absolute; width: 100%; text-align: center; color: #000; font-weight: bold; font-size: 1rem; }

        /* [ë©”ì¸ ë ˆì´ì•„ì›ƒ] */
        #main-container { display: flex; width: 100vw; height: 100vh; padding-top: 100px; box-sizing: border-box; transition: 0.5s; }

        /* [ì´ëª¨ì§€ ê±°ì‹¤ ê³µê°„] */
        .lounge { 
            width: 250px; background: #fff; border: 6px solid var(--dark); margin: 10px; 
            display: flex; flex-wrap: wrap; align-content: flex-start; padding: 15px; 
            overflow-y: auto; gap: 8px; cursor: zoom-in; transition: 0.5s; z-index: 1000;
        }
        /* ê±°ì‹¤ ì „ì²´ë³´ê¸° ëª¨ë“œ (í´ë¦­ ì‹œ) */
        .lounge.expanded {
            position: fixed; top: 85px; bottom: 15px; width: calc(50vw - 25px); 
            z-index: 4000; cursor: zoom-out;
        }
        #red-lounge.expanded { left: 15px; }
        #blue-lounge.expanded { right: 15px; }

        .lounge-title { width: 100%; text-align: center; font-size: 1.4rem; padding: 8px; color: #fff; border-radius: 5px; margin-bottom: 15px; }
        .emoji-item { font-size: 2.5rem; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* ì¤‘ì•™ ì „íˆ¬ ëª¨ë‹ˆí„° */
        #room-view { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 10px; transition: 0.5s; }
        .monitor { border: 6px solid var(--dark); display: flex; flex-direction: column; position: relative; background: #999; cursor: pointer; transition: 0.3s; }
        .monitor.focused { position: fixed !important; inset: 100px 280px 20px 280px; z-index: 3500; border-width: 12px; }

        .teacher-box { text-align: center; padding: 5px; background: #fff; color: #000; border-bottom: 2px solid #000; }
        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; flex: 1; padding: 10px; pointer-events: none; }
        .card-container { height: 45px; perspective: 400px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border: 1px solid var(--dark); display: flex; align-items: center; justify-content: center; border-radius: 5px; font-size: 0.75rem; font-weight: bold; }
        .card-front { background: white; color: #000; }
        .card-back { transform: rotateY(180deg); color: white; }
        .back-red { background: var(--red); }
        .back-blue { background: var(--blue); }

        .input-box { width: 100%; padding: 15px; font-family: 'DungGeunMo'; font-size: 2rem; border: none; border-top: 5px solid var(--dark); text-align: center; outline: none; }

        /* ê¸°íƒ€ UI */
        #round-selector { position: fixed; inset: 0; background: var(--dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .round-btn { width: 350px; padding: 20px; margin: 10px; font-size: 1.5rem; cursor: pointer; border: 6px outset #eee; font-family:'DungGeunMo'; }
        #bonus-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--yellow); border: 8px solid var(--dark); padding: 30px; z-index: 4500; text-align: center; transition: 0.3s; color: #000; }
        #bonus-popup.active { transform: translate(-50%, -50%) scale(1); }

        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div id="round-selector">
    <h1 style="color:var(--yellow); font-size: 3rem; margin-bottom: 20px;">ğŸ« í•˜ìš°ìŠ¤ ì „ê´‘íŒ ëª¨ë“œ V78 ğŸ«</h1>
    <button class="round-btn" style="background:#00b894; color:white;" onclick="selectRound(1)">1ë¼ìš´ë“œ: ê¸°ë³¸ í…ìŠ¤íŠ¸</button>
    <button class="round-btn" style="background:#6c5ce7; color:white;" onclick="selectRound(2)">2ë¼ìš´ë“œ: ì´ëª¨ì§€ í€´ì¦ˆ</button>
    <button class="round-btn" style="background:#ff4757; color:white;" onclick="selectRound(3)">3ë¼ìš´ë“œ: í•˜ë“œ í…ìŠ¤íŠ¸(3-5ì)</button>
</div>

<div id="top-bar">
    <div style="color:var(--red); font-size: 1.5rem; font-weight:bold;">RED HOUSE: <span id="total-red">0</span></div>
    <div id="timer-disp" style="background:var(--dark); color:#fff; padding:5px 15px; border-radius:5px;">60.0s</div>
    <div style="color:var(--blue); font-size: 1.5rem; font-weight:bold;">BLUE HOUSE: <span id="total-blue">0</span></div>
</div>

<div id="status-area">
    <div id="shuffle-timer-container">
        <div id="shuffle-text">SHUFFLE: 10.0s</div>
        <div id="shuffle-bar"></div>
    </div>
</div>

<div id="main-container">
    <div class="lounge" id="red-lounge" onclick="toggleLoungeView()">
        <div class="lounge-title" style="background:var(--red)">RED HOME</div>
    </div>

    <div id="room-view">
        <script>
            for(let i=1; i<=4; i++) {
                document.write(`
                    <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                        <div class="teacher-box" id="teach-${i}">ğŸ‘¨â€ğŸ« ì¤€ë¹„ ì¤‘</div>
                        <div class="board" id="board-${i}"></div>
                        <input type="text" id="input-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="..." disabled>
                        <button id="start-btn-${i}" onclick="requestStart(event)" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px; font-size:2rem; cursor:pointer; font-family:'DungGeunMo'; z-index:10;">ğŸš€ ì‹œì‘</button>
                    </div>
                `);
            }
        </script>
    </div>

    <div class="lounge" id="blue-lounge" onclick="toggleLoungeView()">
        <div class="lounge-title" style="background:var(--blue)">BLUE HOME</div>
    </div>
</div>

<div id="bonus-popup">
    <h2>ğŸ’¥ ê³¨ë“  ë³´ë„ˆìŠ¤ ğŸ’¥</h2>
    <div id="bonus-word-display" style="font-size: 3.5rem; background:#fff; margin:10px; padding:10px; border:3px dashed #000;">ë‹¨ì–´</div>
    <p>ìƒëŒ€ íŒ€ ì¹´ë“œ 3ì¥ì„ ëºì–´ì˜µë‹ˆë‹¤!</p>
</div>

<script>
    const baseWords = [{t:"ì‚¬ê³¼",i:"ğŸ"},{t:"í¬ë„",i:"ğŸ‡"},{t:"í”¼ì",i:"ğŸ•"},{t:"ì¶•êµ¬",i:"âš½"},{t:"í•™êµ",i:"ğŸ«"},{t:"ì—°í•„",i:"âœï¸"},{t:"ìë™ì°¨",i:"ğŸš—"},{t:"íƒœì–‘",i:"â˜€ï¸"},{t:"êµ¬ë¦„",i:"â˜ï¸"},{t:"ê²Œì„",i:"ğŸ®"},{t:"ì‹œê³„",i:"â°"},{t:"ê·¸ë¦¼",i:"ğŸ¨"},{t:"ë‚˜ë¬´",i:"ğŸŒ³"},{t:"ì˜ì",i:"ğŸª‘"},{t:"ë…¸íŠ¸",i:"ğŸ““"},{t:"ê¸°ì°¨",i:"ğŸš‚"},{t:"ìš°ì‚°",i:"â˜‚ï¸"},{t:"ì•ˆê²½",i:"ğŸ‘“"},{t:"ë…¸ë˜",i:"ğŸ¤"},{t:"ë°”ë‹¤",i:"ğŸŒŠ"},{t:"ì†Œê¸ˆ",i:"ğŸ§‚"},{t:"ìš°ìœ ",i:"ğŸ¥›"},{t:"ë¼ë©´",i:"ğŸœ"},{t:"ëª¨ì",i:"ğŸ§¢"},{t:"ì¥ê°‘",i:"ğŸ§¤"},{t:"ì˜¤ì´",i:"ğŸ¥’"},{t:"ë‚˜ë¹„",i:"ğŸ¦‹"},{t:"ê³ ë˜",i:"ğŸ³"},{t:"ì—¬ìš°",i:"ğŸ¦Š"},{t:"í’ì„ ",i:"ğŸˆ"}];
    const hardWords = [{t:"ì»´í“¨í„°",i:"ğŸ’»"},{t:"í…”ë ˆë¹„ì „",i:"ğŸ“º"},{t:"ìŠ¤ë§ˆíŠ¸í°",i:"ğŸ“±"},{t:"ë–¡ë³¶ì´",i:"ğŸ¥˜"},{t:"í–„ë²„ê±°",i:"ğŸ”"},{t:"ì„ ìƒë‹˜",i:"ğŸ‘¨â€ğŸ«"},{t:"ëŒ€í•œë¯¼êµ­",i:"ğŸ‡°ğŸ‡·"},{t:"ì•„ì´ìŠ¤í¬ë¦¼",i:"ğŸ¦"},{t:"ìŠ¤ì¼€ì´íŠ¸",i:"â›¸ï¸"},{t:"ìì „ê±°",i:"ğŸš²"},{t:"ë¹„í–‰ê¸°",i:"âœˆï¸"},{t:"ì†Œë°©ì°¨",i:"ğŸš’"},{t:"ê²½ì°°ì°¨",i:"ğŸš“"},{t:"ë¬´ì§€ê°œ",i:"ğŸŒˆ"},{t:"ì½”ë¼ë¦¬",i:"ğŸ˜"},{t:"ê³ êµ¬ë§ˆ",i:"ğŸ "},{t:"ì„ ê¸€ë¼ìŠ¤",i:"ğŸ•¶ï¸"},{t:"í¬ë¦¬ìŠ¤ë§ˆìŠ¤",i:"ğŸ„"},{t:"ìƒŒë“œìœ„ì¹˜",i:"ğŸ¥ª"},{t:"ë„ì„œê´€",i:"ğŸ“š"},{t:"ì˜¤ë Œì§€",i:"ğŸŠ"},{t:"ë°”ë‚˜ë‚˜",i:"ğŸŒ"},{t:"ë‹¤ëŒì¥",i:"ğŸ¿ï¸"},{t:"ì§€í•˜ì‹¤",i:"ğŸšï¸"},{t:"í”„ë¼ì´íŒ¬",i:"ğŸ³"},{t:"ìœ ì¹˜ì›",i:"ğŸ“›"},{t:"ë¨¸ë¦¬ì¹´ë½",i:"ğŸ’‡"},{t:"ì²´ìœ¡ê´€",i:"ğŸŸï¸"},{t:"ì„ í’ê¸°",i:"ğŸ"},{t:"ëƒ‰ì¥ê³ ",i:"ğŸ§Š"}];

    let wordSet = [], monTeams = {}, hasStarted = false, isWatching = false, activeBonus = "";
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('game_v78');

    async function selectRound(r) {
        wordSet = (r === 3) ? hardWords : baseWords;
        await db.set({ state: 'WAITING', cards: {}, teams: {1:'red', 2:'blue', 3:'red', 4:'blue'}, bonusWord: "" });
        document.getElementById('round-selector').style.display = 'none';
        initBoard();
    }

    function initBoard() {
        for(let i=1; i<=4; i++){
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            wordSet.forEach(item => {
                const c = document.createElement('div');
                c.className = 'card-container'; c.id = `card-${i}-${item.t}`;
                const content = (item.i && item.t.length < 1) ? item.i : item.t; // 2ë¼ìš´ë“œëŠ” ì´ëª¨ì§€
                c.innerHTML = `<div class="card-inner"><div class="card-front">${content}</div><div class="card-back" id="back-${i}-${item.t}">${item.t}</div></div>`;
                b.appendChild(c);
            });
            document.getElementById(`start-btn-${i}`).style.display = 'block';
        }
    }

    // ê±°ì‹¤ í™•ëŒ€/ì¶•ì†Œ í† ê¸€ í•¨ìˆ˜
    function toggleLoungeView() {
        const redL = document.getElementById('red-lounge');
        const blueL = document.getElementById('blue-lounge');
        const roomV = document.getElementById('room-view');
        
        const isExpanded = redL.classList.contains('expanded');
        
        if(isExpanded) {
            redL.classList.remove('expanded');
            blueL.classList.remove('expanded');
            roomV.style.opacity = "1";
        } else {
            redL.classList.add('expanded');
            blueL.classList.add('expanded');
            roomV.style.opacity = "0.1"; // ì¤‘ì•™ ëª¨ë‹ˆí„°ëŠ” íë¦¿í•˜ê²Œ
        }
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !hasStarted) startCountDown();
        if(d.teams) monTeams = d.teams;

        const redEmojis = [], blueEmojis = [];
        wordSet.forEach(item => {
            const team = d.cards?.[item.t]?.team;
            if(team === 'red') redEmojis.push(item.i);
            if(team === 'blue') blueEmojis.push(item.i);
            for(let i=1; i<=4; i++){
                const c = document.getElementById(`card-${i}-${item.t}`), b = document.getElementById(`back-${i}-${item.t}`);
                if(c && team) { c.classList.add('is-flipped'); b.className = `card-back back-${team}`; }
                else if(c) c.classList.remove('is-flipped');
            }
        });

        updateLounge('red', redEmojis);
        updateLounge('blue', blueEmojis);
        document.getElementById('total-red').innerText = redEmojis.length;
        document.getElementById('total-blue').innerText = blueEmojis.length;
        
        activeBonus = d.bonusWord || "";
        document.getElementById('bonus-popup').classList.toggle('active', !!activeBonus);
        if(activeBonus) document.getElementById('bonus-word-display').innerText = activeBonus;

        for(let i=1; i<=4; i++){
            const m = document.getElementById(`mon-${i}`);
            m.className = `monitor team-${monTeams[i]} ${m.classList.contains('focused')?'focused':''}`;
        }
    });

    function updateLounge(team, emojis) {
        const l = document.getElementById(`${team}-lounge`);
        const title = l.querySelector('.lounge-title');
        l.innerHTML = '';
        l.appendChild(title);
        emojis.forEach(e => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.innerText = e;
            l.appendChild(span);
        });
    }

    function requestStart(e) { e.stopPropagation(); db.update({ state: 'START' }); }

    function startCountDown() {
        hasStarted = true;
        document.querySelectorAll('[id^=start-btn]').forEach(b => b.style.display = 'none');
        let count = 3;
        const itv = setInterval(() => {
            if(count > 0) count--;
            else { clearInterval(itv); document.querySelectorAll('.input-box').forEach(i=>i.disabled=false); gameLoop(); }
        }, 1000);
    }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const myTeam = monTeams[id];
            if(activeBonus && val === activeBonus) {
                stealCards(myTeam, 3);
                db.update({ bonusWord: "" });
            } else if(isWatching) {
                applyPenalty(myTeam);
            } else if(wordSet.some(w => w.t === val)) {
                db.child('cards').child(val).set({ team: myTeam, t: Date.now() });
            }
            e.target.value = '';
        }
    }

    function stealCards(myTeam, count) {
        const enemy = myTeam === 'red' ? 'blue' : 'red';
        db.child('cards').once('value', snap => {
            const cards = snap.val(); if(!cards) return;
            let targets = Object.keys(cards).filter(k => cards[k].team === enemy);
            for(let i=0; i<count && i<targets.length; i++) db.child('cards').child(targets[i]).update({ team: myTeam, t: Date.now() });
        });
    }

    function applyPenalty(team) {
        db.child('cards').once('value', snap => {
            const cards = snap.val(); if(!cards) return;
            let myCards = Object.keys(cards).filter(k => cards[k].team === team).sort((a,b) => cards[b].t - cards[a].t);
            if(myCards.length > 0) db.child('cards').child(myCards[0]).remove();
        });
    }

    function gameLoop() {
        let time = 600;
        setInterval(() => {
            if(time <= 0) return;
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            let sLeft = time % 100 || 100;
            const bar = document.getElementById('shuffle-bar'), txt = document.getElementById('shuffle-text');
            bar.style.width = (sLeft) + "%";
            txt.innerText = `SHUFFLE: ${(sLeft/10).toFixed(1)}s`;
            bar.className = sLeft <= 30 ? 'urgent-bar' : '';

            let wPos = (600 - time) % 200;
            isWatching = (wPos >= 170);
            for(let i=1; i<=4; i++){
                const t = document.getElementById(`teach-${i}`);
                t.innerText = isWatching ? "ğŸš¨ ê°ì‹œ!" : "ğŸ‘¨â€ğŸ« ì¹ íŒ";
                t.style.background = isWatching ? "#ff4757" : "#fff";
                t.style.color = isWatching ? "#fff" : "#000";
            }

            if(time > 0 && time % 150 === 0) {
                const rand = wordSet[Math.floor(Math.random()*wordSet.length)].t;
                db.update({ bonusWord: rand });
                setTimeout(() => db.update({ bonusWord: "" }), 5000);
            }

            if(time % 100 === 0) {
                const teams = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: {1:teams[0], 2:teams[1], 3:teams[2], 4:teams[3]} });
            }
        }, 100);
    }

    function focusMon(id) {
        // ì´ë¯¸ í™•ëŒ€ëœ ê±°ì‹¤ì´ ìˆë‹¤ë©´ ë‹«ê¸°
        if(document.getElementById('red-lounge').classList.contains('expanded')) toggleLoungeView();
        
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        if(hasStarted) setTimeout(() => document.getElementById(`input-${id}`).focus(), 100);
    }
</script>
</body>
</html>
