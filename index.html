<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì™€ê¸€ì™€ê¸€ íƒ€ìì™• ë°°í‹€! V33</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #1e90ff; --yellow: #ffa502; --bg: #f1f2f6; }
        body { background: #5758bb; color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ë¡œë¹„ */
        #lobby { position: fixed; inset: 0; background: #5758bb; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { padding: 20px 60px; font-size: 2.5rem; background: var(--yellow); border: 8px outset #eccc68; cursor: pointer; font-family: 'DungGeunMo'; border-radius: 20px; color: #2f3542; }
        
        /* ìƒë‹¨ UI */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; border-bottom: 5px solid #2f3542; display: flex; justify-content: space-around; align-items: center; z-index: 800; color: #2f3542; }
        .score-val { font-size: 1.8rem; font-weight: bold; }
        #timer-disp { font-size: 2.5rem; color: #ff4757; font-weight: bold; background: #2f3542; padding: 0 20px; border-radius: 10px; }

        /* ëª¨ë‹ˆí„° ë ˆì´ì•„ì›ƒ */
        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 20px; padding: 80px 20px 20px; box-sizing: border-box; }
        .monitor { border: 10px solid #2f3542; background: #fff; border-radius: 20px; display: flex; flex-direction: column; position: relative; transition: 0.3s; box-shadow: 10px 10px 0 rgba(0,0,0,0.3); }
        
        /* íŒ€ ê°•ì¡° íš¨ê³¼ */
        .mon-red { border-color: var(--red); box-shadow: 0 0 20px var(--red); }
        .mon-blue { border-color: var(--blue); box-shadow: 0 0 20px var(--blue); }
        
        .monitor-info { background: #eee; color: #333; padding: 5px 15px; display: flex; justify-content: space-between; border-bottom: 3px solid #ddd; }
        .teacher-box { font-size: 2.5rem; text-align: center; padding: 5px; border-bottom: 2px solid #eee; }
        .watching { background: #ff4757 !important; animation: shake 0.2s infinite; }

        /* 3D ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; flex: 1; padding: 10px; background: #dfe4ea; perspective: 1000px; }
        .card-container { height: 35px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: default; }
        .card-container.is-flipped { transform: rotateY(180deg); }
        
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 2px solid #ced6e0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .card-front { background: #fff; color: #747d8c; }
        .card-back { transform: rotateY(180deg); color: #fff; font-weight: bold; }
        .back-red { background: var(--red); border-color: #ff6b81; }
        .back-blue { background: var(--blue); border-color: #70a1ff; }

        .input-box { width: 100%; padding: 15px; font-family: 'DungGeunMo'; font-size: 1.8rem; border: none; border-top: 5px solid #2f3542; text-align: center; }
        .input-box:disabled { background: #f1f2f6; }

        /* ë³´ë„ˆìŠ¤ íŒì—… */
        #bonus-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--yellow); border: 10px solid #2f3542; padding: 40px; z-index: 2000; border-radius: 40px; text-align: center; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bonus-popup.active { transform: translate(-50%, -50%) scale(1); }
        .bonus-word { font-size: 4rem; color: #2f3542; margin: 20px 0; display: block; background: #fff; padding: 10px; border-radius: 20px; }

        .focused { position: fixed !important; inset: 5vh 5vw; width: 90vw !important; height: 90vh !important; z-index: 500; }
        .blurred { filter: blur(5px); opacity: 0.5; pointer-events: none; }
        
        @keyframes shake { 0% { transform: rotate(-1deg); } 100% { transform: rotate(1deg); } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 3.5rem; text-shadow: 4px 4px 0 #2f3542;">ğŸ« ëŒ€ê¸°ì‹¤: ì¹œêµ¬ë“¤ì„ ê¸°ë‹¤ë ¤ìš”</h1>
    <p style="font-size: 1.5rem; margin-bottom: 40px;">ëª¨ë‘ ì ‘ì†í•˜ë©´ ì•„ë˜ [ì‹œì‘] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</p>
    <button class="start-btn" onclick="triggerStart()">ë‹¤ ì™”ë‹¤! ì‹œì‘í•˜ê¸°</button>
</div>

<div id="top-bar">
    <div class="score-val" style="color:var(--red)">RED: <span id="total-red">0</span></div>
    <div id="timer-disp">300.0s</div>
    <div class="score-val" style="color:var(--blue)">BLUE: <span id="total-blue">0</span></div>
</div>

<div id="bonus-popup">
    <h2 style="margin:0; color:#fff;">âš¡ í™©ê¸ˆ ë‹¨ì–´ ë“±ì¥! âš¡</h2>
    <span class="bonus-word" id="bonus-word-txt">í™©ê¸ˆë‹¨ì–´</span>
    <p style="margin:0; font-size: 1.2rem;">ë¨¼ì € ì¹˜ëŠ” íŒ€ì´ ìƒëŒ€ ì¹´ë“œë¥¼ ëºì–´ì˜µë‹ˆë‹¤!</p>
</div>

<div id="room-view">
    <div class="monitor mon-red" id="mon-1" onclick="focusMon(1)">
        <div class="monitor-info"><span>MON #1</span><span>RED TEAM</span></div>
        <div class="teacher-box" id="teacher-1">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-1"></div>
        <input type="text" id="input-1" class="input-box" onkeydown="handleInput(event, 'red')">
    </div>
    <div class="monitor mon-blue" id="mon-2" onclick="focusMon(2)">
        <div class="monitor-info"><span>MON #2</span><span>BLUE TEAM</span></div>
        <div class="teacher-box" id="teacher-2">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-2"></div>
        <input type="text" id="input-2" class="input-box" onkeydown="handleInput(event, 'blue')">
    </div>
    <div class="monitor mon-red" id="mon-3" onclick="focusMon(3)">
        <div class="monitor-info"><span>MON #3</span><span>RED TEAM</span></div>
        <div class="teacher-box" id="teacher-3">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-3"></div>
        <input type="text" id="input-3" class="input-box" onkeydown="handleInput(event, 'red')">
    </div>
    <div class="monitor mon-blue" id="mon-4" onclick="focusMon(4)">
        <div class="monitor-info"><span>MON #4</span><span>BLUE TEAM</span></div>
        <div class="teacher-box" id="teacher-4">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-4"></div>
        <input type="text" id="input-4" class="input-box" onkeydown="handleInput(event, 'blue')">
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_v33');

    const words = ["ë–¡ë³¶ì´", "ê¸‰ì‹", "ìš´ë™ì¥", "ë°©í•™", "ì•Œë¦¼ì¥", "ì§ê¿", "ì¤€ë¹„ë¬¼", "ì‹¤ë‚´í™”", "ë”±ì§€", "ìŠ¬ëŸ¬ì‹œ", "í”¼ì¹´ì¸„", "í•™ì›", "ìˆ™ì œ", "ì²´ìœ¡", "ì†Œí’", "ì‰¬ëŠ”ì‹œê°„", "ì§€ìš°ê°œ", "í•„í†µ", "ë¦¬ì½”ë”", "ë°˜ì¥", "ì¼ê¸°", "ë…ì„œ", "í”¼êµ¬", "íƒœê¶Œë„", "ë¬¸ë°©êµ¬", "êµì‹¤", "ë§¤ì ", "ì¹ íŒ", "ë¶„í•„", "ì •ë¬¸", "êµê°€", "í˜„ì¥í•™ìŠµ", "ê°œí•™", "êµì¥ì‹¤", "ê³¼í•™ì‹¤", "ìŒì•…ì‹¤", "ë³µë„", "ì‹¤ë‚´í™”ê°€ë°©", "ë°›ì•„ì“°ê¸°", "ë°©ê³¼í›„"];
    const bonusWords = ["ìŠˆí¼ì»´í“¨í„°", "ìš°ì£¼ìµœê°•", "ë¬´ì§€ê°œë°˜ì‚¬", "í™©ê¸ˆì˜¬ë¦¬ë¸Œ", "ìŠ¤íŒŒê²Œí‹°", "ì¹˜ì¦ˆë²„ê±°"];
    
    let isWatching = false, hasStarted = false, turn = 'red', activeBonus = "";

    // 3D ì¹´ë“œ ë³´ë“œ ìƒì„±
    for(let i=1; i<=4; i++) {
        const b = document.getElementById(`board-${i}`);
        words.forEach(w => {
            const container = document.createElement('div');
            container.className = 'card-container';
            container.id = `cont-${i}-${w}`;
            container.innerHTML = `
                <div class="card-front">${w}</div>
                <div class="card-back" id="back-${i}-${w}">${w}</div>
            `;
            b.appendChild(container);
        });
    }

    db.on('value', (snap) => {
        const data = snap.val();
        if(!data) return;
        
        if(data.state === 'START' && !hasStarted) {
            hasStarted = true;
            document.getElementById('lobby').style.display = 'none';
            gameLoop();
        }

        activeBonus = data.bonusWord || "";
        document.getElementById('bonus-popup').classList.toggle('active', !!activeBonus);
        if(activeBonus) document.getElementById('bonus-word-txt').innerText = activeBonus;

        let r=0, b=0;
        words.forEach(w => {
            const owner = (data.cards && data.cards[w]) ? data.cards[w].team : null;
            if(owner) owner === 'red' ? r++ : b++;
            for(let i=1; i<=4; i++) {
                const cont = document.getElementById(`cont-${i}-${w}`);
                const back = document.getElementById(`back-${i}-${w}`);
                if(owner) {
                    cont.classList.add('is-flipped');
                    back.className = 'card-back back-' + owner;
                } else {
                    cont.classList.remove('is-flipped');
                }
            }
        });
        document.getElementById('total-red').innerText = r;
        document.getElementById('total-blue').innerText = b;
    });

    function triggerStart() {
        db.set({ state: 'START', cards: {}, bonusWord: "", t: Date.now() });
    }

    function handleInput(e, team) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(isWatching) {
                applyPenalty(team);
                e.target.value = '';
                return;
            }
            if(activeBonus && val === activeBonus) {
                db.update({ bonusWord: "" });
                alert(team.toUpperCase() + " ë³´ë„ˆìŠ¤ íšë“! ìƒëŒ€ ì¹´ë“œë¥¼ ë¬´ì‘ìœ„ë¡œ í•˜ë‚˜ ëºìŠµë‹ˆë‹¤!");
                applyPenalty(team === 'red' ? 'blue' : 'red'); // ìƒëŒ€íŒ€ íŒ¨ë„í‹°
            }
            db.child('cards').transaction((c) => {
                if(!c) c = {};
                if(words.includes(val) && !c[val]) c[val] = { team: team, t: Date.now() };
                return c;
            });
            e.target.value = '';
        }
    }

    function applyPenalty(team) {
        db.child('cards').once('value', (snap) => {
            const cards = snap.val(); if(!cards) return;
            let lastKey = null, lastT = -1;
            for(let k in cards) {
                if(cards[k].team === team && cards[k].t > lastT) { lastT = cards[k].t; lastKey = k; }
            }
            if(lastKey) db.child('cards').child(lastKey).remove();
        });
    }

    function gameLoop() {
        let timeLeft = 3000;
        setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                document.getElementById('timer-disp').innerText = (timeLeft/10).toFixed(1) + "s";
                turn = (Math.floor((3000-timeLeft)/100) % 2 === 0) ? 'red' : 'blue';
                
                for(let i=1; i<=4; i++) {
                    const inp = document.getElementById(`input-${i}`);
                    const myTeam = (i===1 || i===3) ? 'red' : 'blue';
                    inp.disabled = (myTeam !== turn);
                    inp.placeholder = (myTeam === turn) ? "ì…ë ¥ ê°€ëŠ¥!" : "ê¸°ë‹¤ë ¤!";
                }

                if(timeLeft % 100 < 20) {
                    isWatching = true;
                    for(let i=1; i<=4; i++) document.getElementById(`teacher-${i}`).classList.add('watching');
                } else {
                    isWatching = false;
                    for(let i=1; i<=4; i++) document.getElementById(`teacher-${i}`).classList.remove('watching');
                }

                if(timeLeft % 400 === 0 && timeLeft !== 3000) {
                    db.update({ bonusWord: bonusWords[Math.floor(Math.random()*bonusWords.length)] });
                    setTimeout(() => db.update({ bonusWord: "" }), 5000);
                }
            }
        }, 100);
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.add('blurred'));
        const target = document.getElementById(`mon-${id}`);
        target.classList.remove('blurred'); target.classList.add('focused');
        document.getElementById(`input-${id}`).focus();
    }
    function unfocus() {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('blurred', 'focused'));
    }
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') unfocus(); });
</script>
</body>
</html>
