<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íƒ€ì ë°°í‹€ V62 - ì‹œì‘ ë²„íŠ¼ ìˆ˜ì • ì™„ë£Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #FF0000; --blue: #0000FF; --yellow: #feca57; --dark: #1e272e; --bg: #f1f2f6; --gold: #ffd700; }
        body { background: var(--bg); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #round-selector { position: fixed; inset: 0; background: var(--dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .round-btn { width: 400px; padding: 30px; margin: 20px; font-size: 2rem; font-family: 'DungGeunMo'; cursor: pointer; border: 8px outset #eee; transition: 0.2s; border-radius: 10px; }
        .round-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        #btn-r1 { background: #00b894; color: white; }
        #btn-r2 { background: #6c5ce7; color: white; }

        #lobby-guide { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #000; pointer-events: none; }
        #countdown { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; font-size: 10rem; color: var(--yellow); pointer-events: none; }
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4500; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .win-box { background: white; padding: 40px; border: 10px double var(--dark); color: #000; }

        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: #fff; border-bottom: 6px solid var(--dark); display: flex; justify-content: space-around; align-items: center; z-index: 900; color: var(--dark); }
        #timer-disp { font-size: 2.2rem; color: #ff4757; background: var(--dark); padding: 5px 15px; border-radius: 5px; }
        #main-progress-bar { position: fixed; top: 65px; left: 0; height: 12px; background: #00b894; z-index: 850; width: 100%; transition: width 0.1s linear; }

        #room-view { display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 15px; padding: 100px 15px 15px; box-sizing: border-box; }
        .monitor { border: 10px solid var(--dark); display: flex; flex-direction: column; position: relative; background: #999; cursor: pointer; transition: 0.2s; overflow: hidden; }
        .monitor.team-red { background: var(--red) !important; border-color: #b30000; }
        .monitor.team-blue { background: var(--blue) !important; border-color: #0000b3; }
        .monitor.focused { position: fixed !important; inset: 80px 20px 20px 20px; width: auto !important; height: auto !important; z-index: 1500; cursor: default; border-width: 15px; }

        .team-indicator { font-size: 1.5rem; font-weight: bold; text-align: center; padding: 5px; background: rgba(0,0,0,0.7); color: #fff; }
        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 6px; flex: 1; padding: 15px; pointer-events: none; }
        .card-container { height: 65px; perspective: 600px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border: 2px solid var(--dark); display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .card-front { background: white; color: #000; font-weight: bold; }
        .card-front.mode-text { font-size: 0.85rem; }
        .card-front.mode-emoji { font-size: 2.5rem; }

        .card-back { transform: rotateY(180deg); color: white; font-size: 0.9rem; font-weight: bold; text-align: center; padding: 2px; }
        .back-red { background: #d63031; }
        .back-blue { background: #0984e3; }

        .swap-bar-container { width: 100%; height: 12px; background: rgba(255,255,255,0.3); border-bottom: 2px solid var(--dark); }
        .swap-bar-fill { height: 100%; width: 100%; background: var(--yellow); transition: width 0.1s linear; }
        .swap-warning { background: #ff4757; animation: blink 0.3s infinite; }

        .input-box { width: 100%; padding: 20px; font-family: 'DungGeunMo'; font-size: 2.5rem; border: none; border-top: 6px solid var(--dark); text-align: center; outline: none; }
        
        /* ğŸš¨ ì‹œì‘ ë²„íŠ¼ ìµœìš°ì„  ìˆœìœ„ ì„¤ì • */
        .start-btn { display: none; padding: 25px 60px; font-size: 3rem; background: var(--yellow); border: 8px outset #fff; cursor: pointer; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; font-family: 'DungGeunMo'; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .focused .start-btn { display: block !important; }
        
        #bonus-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--gold); border: 10px solid var(--dark); padding: 40px; z-index: 2500; color: #000; text-align: center; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); min-width: 400px; }
        #bonus-popup.active { transform: translate(-50%, -50%) scale(1); }
        #bonus-reward-badge { background: #000; color: var(--gold); padding: 5px 15px; border-radius: 20px; font-size: 1.5rem; margin-top: 10px; display: inline-block; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="round-selector">
    <h1 style="font-size: 4rem; margin-bottom: 50px; color: var(--yellow);">ğŸ« íƒ€ì í•™êµ V62 ğŸ«</h1>
    <button id="btn-r1" class="round-btn" onclick="selectRound(1)">1ë¼ìš´ë“œ: í…ìŠ¤íŠ¸ ëª¨ë“œ</button>
    <button id="btn-r2" class="round-btn" onclick="selectRound(2)">2ë¼ìš´ë“œ: ì´ëª¨ì§€ ëª¨ë“œ</button>
</div>

<div id="countdown">3</div>
<div id="result-screen">
    <div class="win-box">
        <h1 id="winner-text" style="font-size: 4rem;">ê²°ê³¼!</h1>
        <p id="final-score" style="font-size: 2rem;"></p>
        <button onclick="location.reload()" style="padding:15px 40px; font-family:'DungGeunMo'; cursor:pointer; font-size:1.5rem;">ì²˜ìŒìœ¼ë¡œ</button>
    </div>
</div>

<div id="bonus-popup">
    <h2 style="margin:0; font-size: 2rem;">ğŸ’¥ ê³¨ë“  ë³´ë„ˆìŠ¤ ğŸ’¥</h2>
    <div id="bonus-word-display" style="font-size: 5rem; background:#fff; margin:20px 0; padding:15px; border:6px dashed #000;">ë‹¨ì–´</div>
    <div id="bonus-reward-badge">ğŸ’ ë³´ìƒ: ?ì¥ íƒˆì·¨</div>
</div>

<div id="lobby-guide">
    <h1 id="guide-title" style="font-size: 3.5rem;">ë¼ìš´ë“œ ì¤€ë¹„</h1>
    <p id="guide-desc" style="font-size: 1.8rem;">ëª¨ë‹ˆí„°ë¥¼ í´ë¦­í•˜ê³  [ì‹œì‘]ì„ ëˆ„ë¥´ì„¸ìš”.</p>
</div>

<div id="top-bar">
    <div id="round-disp" style="background:var(--dark); color:white; padding:5px 15px; border-radius:5px; font-size:1.5rem;">Round 1</div>
    <div style="color:var(--red); font-size: 2rem; font-weight:bold;">RED: <span id="total-red">0</span></div>
    <div id="timer-disp">60.0s</div>
    <div style="color:var(--blue); font-size: 2rem; font-weight:bold;">BLUE: <span id="total-blue">0</span></div>
</div>
<div id="main-progress-bar"></div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <button class="start-btn" id="start-btn-${i}" onclick="requestStart(event)">ğŸš€ ì‹œì‘</button>
                    <div class="team-indicator" id="team-text-${i}">ëŒ€ê¸° ì¤‘</div>
                    <div class="teacher-box" id="teach-${i}" style="color:#000; text-align:center; padding:5px; background:#fff; border-bottom:2px solid #000; font-size:1.2rem;">ğŸ‘¨â€ğŸ« ëŒ€ê¸°</div>
                    <div class="swap-bar-container"><div class="swap-bar-fill" id="swap-bar-${i}"></div></div>
                    <div class="board" id="board-${i}"></div>
                    <input type="text" id="input-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ì…ë ¥í•˜ì„¸ìš”" disabled>
                </div>
            `);
        }
    </script>
</div>

<script>
    const wordSet = [
        {t: "ë–¡ë³¶ì´", i: "ğŸ²"}, {t: "í”¼ì", i: "ğŸ•"}, {t: "í–„ë²„ê±°", i: "ğŸ”"}, {t: "ì‚¬ê³¼", i: "ğŸ"}, {t: "í¬ë„", i: "ğŸ‡"},
        {t: "ì¶•êµ¬", i: "âš½"}, {t: "ë†êµ¬", i: "ğŸ€"}, {t: "ì•¼êµ¬", i: "âš¾"}, {t: "ìˆ˜ì˜", i: "ğŸŠ"}, {t: "ìì „ê±°", i: "ğŸš²"},
        {t: "í•™êµ", i: "ğŸ«"}, {t: "ì„ ìƒë‹˜", i: "ğŸ‘¨â€ğŸ«"}, {t: "ì±…ìƒ", i: "ğŸª‘"}, {t: "ì—°í•„", i: "âœï¸"}, {t: "ë…¸íŠ¸", i: "ğŸ““"},
        {t: "ê°•ì•„ì§€", i: "ğŸ¶"}, {t: "ê³ ì–‘ì´", i: "ğŸ±"}, {t: "í† ë¼", i: "ğŸ°"}, {t: "ì‚¬ì", i: "ğŸ¦"}, {t: "ì½”ë¼ë¦¬", i: "ğŸ˜"},
        {t: "ë¹„í–‰ê¸°", i: "âœˆï¸"}, {t: "ê¸°ì°¨", i: "ğŸš‚"}, {t: "ìë™ì°¨", i: "ğŸš—"}, {t: "ê²½ì°°ì°¨", i: "ğŸš“"}, {t: "ì†Œë°©ì°¨", i: "ğŸš’"},
        {t: "íƒœì–‘", i: "â˜€ï¸"}, {t: "ë‹¬", i: "ğŸŒ™"}, {t: "ë³„", i: "â­"}, {t: "êµ¬ë¦„", i: "â˜ï¸"}, {t: "ë¬´ì§€ê°œ", i: "ğŸŒˆ"},
        {t: "ì»´í“¨í„°", i: "ğŸ’»"}, {t: "ìŠ¤ë§ˆíŠ¸í°", i: "ğŸ“±"}, {t: "ê²Œì„", i: "ğŸ®"}, {t: "í…”ë ˆë¹„ì „", i: "ğŸ“º"}, {t: "ì¹´ë©”ë¼", i: "ğŸ“·"},
        {t: "ìš°ì‚°", i: "â˜‚ï¸"}, {t: "ì•ˆê²½", i: "ğŸ‘“"}, {t: "ì‹œê³„", i: "â°"}, {t: "ì„ ë¬¼", i: "ğŸ"}, {t: "í’ì„ ", i: "ğŸˆ"},
        {t: "ë…¸ë˜", i: "ğŸ¤"}, {t: "ì¶¤", i: "ğŸ’ƒ"}, {t: "ê·¸ë¦¼", i: "ğŸ¨"}, {t: "ì˜í™”", i: "ğŸ¬"}, {t: "ìš°í¸", i: "ğŸ“®"},
        {t: "ëˆˆì‚¬ëŒ", i: "â˜ƒï¸"}, {t: "ë°”ë‹¤", i: "ğŸŒŠ"}, {t: "ì‚°", i: "â›°ï¸"}, {t: "ê½ƒ", i: "ğŸŒ¸"}, {t: "ë‚˜ë¬´", i: "ğŸŒ³"}
    ];

    let currentRound = 1;
    const firebaseConfig = { databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_visual_v62');

    let monTeams = { 1: null, 2: null, 3: null, 4: null };
    let hasStarted = false, isWatching = false, isCounting = false, isGameOver = false, activeBonus = "", bonusReward = 0;

    async function selectRound(r) {
        currentRound = r;
        await db.set({ state: 'WAITING', cards: {}, bonusWord: "", bonusReward: 0 });
        document.getElementById('round-selector').style.display = 'none';
        document.getElementById('room-view').style.display = 'grid';
        document.getElementById('lobby-guide').style.display = 'flex';
        document.getElementById('round-disp').innerText = `Round ${r}`;
        initBoard();
    }

    function initBoard() {
        for(let i=1; i<=4; i++){
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = ""; // ë³´ë“œ ë‚´ë¶€ ì¹´ë“œë§Œ ì´ˆê¸°í™”
            wordSet.forEach(item => {
                const c = document.createElement('div');
                c.className = 'card-container'; c.id = `card-${i}-${item.t}`;
                const content = (currentRound === 1) ? item.t : item.i;
                const modeClass = (currentRound === 1) ? 'mode-text' : 'mode-emoji';
                c.innerHTML = `<div class="card-inner">
                    <div class="card-front ${modeClass}">${content}</div>
                    <div class="card-back" id="back-${i}-${item.t}">${item.t}</div>
                </div>`;
                b.appendChild(c);
            });
        }
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !hasStarted && !isCounting) startCountDown();
        if(d.state === 'WAITING' && hasStarted) location.reload();
        
        activeBonus = d.bonusWord || "";
        bonusReward = d.bonusReward || 0;
        const popup = document.getElementById('bonus-popup');
        popup.classList.toggle('active', !!activeBonus);
        if(activeBonus) {
            document.getElementById('bonus-word-display').innerText = activeBonus;
            document.getElementById('bonus-reward-badge').innerText = `ğŸ’ ë³´ìƒ: ${bonusReward}ì¥ íƒˆì·¨`;
        }

        wordSet.forEach(item => {
            const team = d.cards?.[item.t]?.team;
            for(let i=1; i<=4; i++){
                const c = document.getElementById(`card-${i}-${item.t}`);
                const b = document.getElementById(`back-${i}-${item.t}`);
                if(c && team) { c.classList.add('is-flipped'); if(b) b.className = `card-back back-${team}`; }
                else if(c) { c.classList.remove('is-flipped'); }
            }
        });
        document.getElementById('total-red').innerText = Object.values(d.cards||{}).filter(v=>v.team==='red').length;
        document.getElementById('total-blue').innerText = Object.values(d.cards||{}).filter(v=>v.team==='blue').length;
    });

    function requestStart(e) { e.stopPropagation(); db.update({ state: 'START' }); }

    function startCountDown() {
        isCounting = true;
        const cd = document.getElementById('countdown');
        cd.style.display = 'flex';
        let count = 3; cd.innerText = count;
        let itv = setInterval(() => {
            count--;
            if(count > 0) cd.innerText = count;
            else if(count === 0) cd.innerText = "GO!";
            else {
                clearInterval(itv); cd.style.display = 'none';
                monTeams = { 1: 'red', 2: 'blue', 3: 'red', 4: 'blue' };
                updateMonitorUI();
                hasStarted = true; isCounting = false;
                document.getElementById('lobby-guide').style.display = 'none';
                document.querySelectorAll('.start-btn').forEach(b => b.style.display = 'none');
                document.querySelectorAll('.input-box').forEach(i => i.disabled = false);
                gameLoop();
            }
        }, 1000);
    }

    function updateMonitorUI() {
        for(let i=1; i<=4; i++) {
            const m = document.getElementById(`mon-${i}`);
            const t = document.getElementById(`team-text-${i}`);
            if(!m) continue;
            m.classList.remove('team-red', 'team-blue');
            if(monTeams[i]) {
                m.classList.add(`team-${monTeams[i]}`);
                t.innerText = monTeams[i].toUpperCase() + " TEAM";
            }
        }
    }

    function handleInput(e, id) {
        if(e.key === 'Enter' && !isGameOver && monTeams[id]) {
            const val = e.target.value.trim();
            const myTeam = monTeams[id];
            if(activeBonus && val === activeBonus) {
                stealCards(myTeam, bonusReward);
                db.update({ bonusWord: "", bonusReward: 0 });
            } else if(isWatching) {
                applyPenalty(myTeam, 1);
            } else if(wordSet.some(w => w.t === val)) {
                db.child('cards').child(val).set({ team: myTeam, t: Date.now() });
            }
            e.target.value = '';
        }
    }

    function stealCards(myTeam, count) {
        const enemy = myTeam === 'red' ? 'blue' : 'red';
        db.child('cards').once('value', snap => {
            const cards = snap.val(); if(!cards) return;
            let targets = Object.keys(cards).filter(k => cards[k].team === enemy);
            targets.sort((a,b) => cards[b].t - cards[a].t);
            for(let i=0; i<count && i<targets.length; i++) {
                db.child('cards').child(targets[i]).update({ team: myTeam, t: Date.now() });
            }
        });
    }

    function applyPenalty(team, count) {
        db.child('cards').once('value', snap => {
            const cards = snap.val(); if(!cards) return;
            let targets = Object.keys(cards).filter(k => cards[k].team === team);
            targets.sort((a,b) => cards[b].t - cards[a].t);
            for(let i=0; i<count && i<targets.length; i++) db.child('cards').child(targets[i]).remove();
        });
    }

    function gameLoop() {
        let time = 600;
        const timer = setInterval(() => {
            if(time > 0) {
                time--;
                document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
                document.getElementById('main-progress-bar').style.width = (time / 600 * 100) + "%";
                const cyclePos = (600 - time) % 100;
                const swapPercent = 100 - cyclePos;
                for(let i=1; i<=4; i++) {
                    const bar = document.getElementById(`swap-bar-${i}`);
                    if(bar) bar.style.width = swapPercent + "%";
                }
                if(cyclePos === 0) {
                    for(let i=1; i<=4; i++) monTeams[i] = (monTeams[i]==='red')?'blue':'red';
                    updateMonitorUI();
                }
                const watchPos = (600 - time) % 200;
                isWatching = (watchPos >= 170);
                for(let i=1; i<=4; i++) {
                    const t = document.getElementById(`teach-${i}`);
                    if(t) {
                        t.innerText = isWatching ? "ğŸš¨ ê°ì‹œ ì¤‘! ğŸš¨" : "ğŸ‘¨â€ğŸ« ì¹ íŒ ë³´ëŠ” ì¤‘";
                        t.style.background = isWatching ? "#ff4757" : "#fff";
                        t.style.color = isWatching ? "#fff" : "#000";
                    }
                }
                if(time > 0 && time % 150 === 0) {
                    const randomItem = wordSet[Math.floor(Math.random()*wordSet.length)];
                    const len = randomItem.t.length;
                    let reward = len >= 5 ? 5 : (len === 4 ? 3 : 2);
                    db.update({ bonusWord: randomItem.t, bonusReward: reward });
                    setTimeout(() => db.update({ bonusWord: "", bonusReward: 0 }), 5000);
                }
            } else { clearInterval(timer); endGame(); }
        }, 100);
    }

    function endGame() {
        isGameOver = true;
        const r = parseInt(document.getElementById('total-red').innerText);
        const b = parseInt(document.getElementById('total-blue').innerText);
        const winTxt = r > b ? "RED TEAM ìŠ¹ë¦¬!" : (b > r ? "BLUE TEAM ìŠ¹ë¦¬!" : "ë¬´ìŠ¹ë¶€!");
        document.getElementById('winner-text').innerText = winTxt;
        document.getElementById('winner-text').style.color = r > b ? "red" : (b > r ? "blue" : "black");
        document.getElementById('final-score').innerText = `RED: ${r} vs BLUE: ${b}`;
        document.getElementById('result-screen').style.display = 'flex';
    }

    function focusMon(id) {
        if(isGameOver) return;
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        if(hasStarted) setTimeout(() => document.getElementById(`input-${id}`).focus(), 100);
    }
</script>
</body>
</html>
