<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MAFIA: EMPIRE EVOLUTION v23</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #ff0000; --blue: #0044ff; --yellow: #ffcc00; --dark: #0a0a0a; --neon: #00ff00; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo'; margin: 0; overflow: hidden; }
        
        /* ìƒë‹¨ ì˜ì—­: ë¯¸ë“±ë¡ í…ìŠ¤íŠ¸ ì œê±°, ì•„ì´ì½˜ ê°€ì‹œì„± í™•ë³´ */
        #top-bar { height: 80px; background: #111; display: flex; align-items: center; justify-content: space-around; padding: 0 20px; border-bottom: 3px solid #333; }
        #timer-disp { font-size: 3rem; color: var(--yellow); }
        .top-icons { display: flex; gap: 30px; }
        .top-icons div { text-align: center; position: relative; }
        .top-icons i { font-size: 2.5rem; color: #222; transition: 0.3s; }
        .upgrade-ready { color: var(--neon) !important; text-shadow: 0 0 10px var(--neon); }

        /* 10ì´ˆ ë§‰ëŒ€ ë°” */
        #turn-progress-container { position: absolute; top: 77px; left: 0; width: 100%; height: 8px; background: #222; z-index: 1000; }
        #turn-progress-bar { width: 100%; height: 100%; background: var(--neon); transition: width 0.1s linear; }

        /* ëª¨ë‹ˆí„° ì„¤ì • ë° íŒ€ ì»¬ëŸ¬ ì—°ì¶œ (ê³¼í•˜ê²Œ) */
        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 20px; height: calc(100vh - 100px); }
        .monitor { position: relative; border: 10px solid #333; background: #000; transition: 0.3s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 90px 15px 15px 15px; z-index: 5000; }
        
        /* íŒ€ë³„ ê°•ë ¬í•œ ì—°ì¶œ */
        .my-team-red { border-color: var(--red) !important; box-shadow: inset 0 0 150px rgba(255,0,0,0.5); }
        .my-team-blue { border-color: var(--blue) !important; box-shadow: inset 0 0 150px rgba(0,68,255,0.5); }

        .radar-overlay { position: absolute; inset: 0; background: rgba(255,0,0,0.1); border: 5px solid var(--red); z-index: 6000; display: none; align-items: center; justify-content: center; font-size: 3rem; color: var(--red); pointer-events: none; }

        .board { flex: 1; display: grid; grid-template-columns: repeat(10, 5fr); gap: 2px; padding: 10px; height: 65%; overflow-y: auto; }
        .card { background: #1a1a1a; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; border: 1px solid #333; color: #555; height: 30px; }
        .card.owned-red { background: var(--red) !important; color: white; border: none; font-weight: bold; }
        .card.owned-blue { background: var(--blue) !important; color: white; border: none; font-weight: bold; }

        .input-wrap { height: 80px; border-top: 5px solid #333; display: flex; }
        .input-box { flex: 1; background: transparent; border: none; font-size: 4rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        /* ê²°ê³¼ í™”ë©´ */
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #evo-status { font-size: 2rem; color: var(--yellow); margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="timer-disp">02:00</div>
    <div class="top-icons">
        <div title="ì—ë„ˆì§€"><i class="fas fa-bolt" id="ti-0"></i></div>
        <div title="ì œì¡°"><i class="fas fa-industry" id="ti-1"></i></div>
        <div title="ê¸ˆìœµ"><i class="fas fa-coins" id="ti-2"></i></div>
        <div title="ê¸°ìˆ "><i class="fas fa-microchip" id="ti-3"></i></div>
        <div title="ì¸ì ìë³¸"><i class="fas fa-users" id="ti-4"></i></div>
    </div>
    <div id="current-stage" style="font-size:1.5rem; color:var(--yellow)">[ê¸°ì´ˆ ì„¤ë¦½ ë‹¨ê³„]</div>
</div>
<div id="turn-progress-container"><div id="turn-progress-bar"></div></div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++){
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="radar-overlay" id="radar-${i}">ğŸš¨ ê°ì‹œ ëª¨ë“œ: íƒ€ì ê¸ˆì§€! ğŸš¨</div>
                    <div class="gate" id="gate-${i}" style="position:absolute; inset:0; background:rgba(0,0,0,0.8); z-index:100; display:flex; align-items:center; justify-content:center;">
                        <button onclick="localStart(event, ${i})" style="padding:20px 40px; font-size:2rem; background:var(--yellow); border:none; cursor:pointer; font-family:'DungGeunMo'">ì¡°ì§ íˆ¬ì…</button>
                    </div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="..." disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<div id="result-screen">
    <h1 style="color:var(--yellow); font-size:4rem;">ì˜í†  í™•ì¥ ë¶„ì„</h1>
    <div id="evo-status"></div>
    <div style="position:relative; width:450px; height:450px;">
        <canvas id="radarChart"></canvas>
    </div>
    <button onclick="nextRound()" style="margin-top:30px; padding:15px 60px; background:var(--yellow); border:none; font-size:2rem; font-family:'DungGeunMo'; cursor:pointer;">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
</div>

<script>
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_empire_v23');
    
    // ë§ˆí”¼ì•„ ì»¨ì…‰ 5ëŒ€ ì˜ì—­ ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ (ì˜ì—­ë‹¹ 25ê°œ)
    const industryWords = {
        0: ['ì„ìœ ','ê°€ìŠ¤','ì›ìë ¥','ì„íƒ„','ë°œì „ê¸°','ì „ë ¥ë§','ì†¡ìœ ê´€','ì •ìœ ì†Œ','ìœ ì •','ë°°í„°ë¦¬','íƒœì–‘ê´‘','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ì—ë„ˆì§€','ì—°ë£Œ','ê°€ì†”ë¦°','ë””ì ¤','ì¶©ì „ì†Œ','ë³€ì••ê¸°','ê·¸ë¦¬ë“œ','ì—´ë³‘í•©','ì±„êµ´','ë¹„ì¶•ìœ ','í•µìœµí•©'],
        1: ['ì² ê°•','ê¸ˆì†','ê¸°ê³„','ìë™ì°¨','ì¡°ì„ ','í•­ê³µ','ë°˜ë„ì²´','í™”í•™','ì„¬ìœ ','í”Œë¼ìŠ¤í‹±','ë¡œë´‡','ìƒì‚°ë¼ì¸','ì¡°ë¦½','ê¸ˆí˜•','ê³µì¥','ë¶€í’ˆ','ì—”ì§„','ì„¤ë¹„','ì œë ¨ì†Œ','ë‹¨ì¡°','ì£¼ì¡°','ì„ ë°˜','ë°€ë§','ìš©ì ‘','ì‚°ì—…'],
        2: ['ì€í–‰','ì¦ê¶Œ','ì±„ê¶Œ','ë³´í—˜','íˆ¬ì','ìë³¸','í˜„ê¸ˆ','ê¸ˆë¦¬','í™˜ìœ¨','ê¸ˆê³ ','ê±°ë˜ì†Œ','ì£¼ì‹','í€ë“œ','ì‹ ìš©','ëŒ€ì¶œ','ìì‚°','íŒŒìƒìƒí’ˆ','ê¸ˆìœµ','ì„¸ê¸ˆ','ì§€ë¶ˆ','ê²°ì œ','í•€í…Œí¬','ëª¨ê¸°ì§€','ë°°ë‹¹','ì˜ˆê¸ˆ'],
        3: ['AI','ë°ì´í„°','ì†Œí”„íŠ¸ì›¨ì–´','ë„¤íŠ¸ì›Œí¬','ë³´ì•ˆ','ì•”í˜¸','í´ë¼ìš°ë“œ','ì„¼ì„œ','ì•Œê³ ë¦¬ì¦˜','ì¸í„°í˜ì´ìŠ¤','í”„ë¡œê·¸ë¨','ì„œë²„','ë””ì§€í„¸','ì‹œìŠ¤í…œ','íšŒë¡œ','í†µì‹ ','ìœ„ì„±','ê´‘ì„¬ìœ ','ì—°ì‚°','ì–‘ì','í•´í‚¹','ë°©í™”ë²½','ì½”ë”©','ë¹…ë°ì´í„°','ê¸°ìˆ '],
        4: ['ì¸ì¬','êµìœ¡','í›ˆë ¨','ë…¸ë™','ì˜ë£Œ','ì „ë¬¸ê°€','ê¸°ìˆ ì','ì—°êµ¬ì›','ë¦¬ë”ì‹­','ë§¤ë‹ˆì €','ë…¸í•˜ìš°','ê²½í—˜','ì—­ëŸ‰','ì§€ì‹','ì°½ì˜ì„±','ë³µì§€','ë³´ê±´','ì¸ë ¥','ìŠ¤ì¹´ìš°íŠ¸','ê³ ìš©','ì¸ì‚¬','ìê²©ì¦','ì›Œí¬ìˆ','ì„±ê³¼','ì»¤ë¦¬ì–´']
    };
    const allWords = Object.values(industryWords).flat();
    const catNames = ['ì—ë„ˆì§€','ì œì¡°','ê¸ˆìœµ','ê¸°ìˆ ','ì¸ì ìë³¸'];
    const rankIcons = ['fa-bolt','fa-industry','fa-coins','fa-microchip','fa-users'];

    let active = false, pCards = {}, teams = {1:'red', 2:'red', 3:'blue', 4:'blue'}, focusedId = null, currentStage = "ê¸°ì´ˆ ì„¤ë¦½";
    let scores = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
    let isAlert = false;

    function zoomIn(id) { focusedId = id; document.querySelectorAll('.monitor').forEach(m=>m.classList.remove('focused')); document.getElementById(`mon-${id}`).classList.add('focused'); }

    function localStart(e, id) {
        e.stopPropagation();
        document.getElementById(`gate-${id}`).style.display = 'none';
        document.getElementById(`in-${id}`).disabled = false;
        document.getElementById(`in-${id}`).focus();
        db.update({state: 'RUNNING'});
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        pCards = d.cards || {}; teams = d.teams || teams;
        if(d.state === 'RUNNING' && !active) { active = true; startGlobalTimer(); }
        if(d.state === 'FINISHED') showResult();
        updateUI();
    });

    function handleInput(e, id) {
        if(e.key !== 'Enter') return;
        if(isAlert) { e.target.value = ""; return; }
        const val = e.target.value.trim();
        const team = teams[id];
        if(allWords.includes(val)) db.child('cards').child(val).set(team);
        e.target.value = "";
    }

    function startGlobalTimer() {
        let time = 120;
        let turnTime = 10;
        const mainIntr = setInterval(() => {
            time--; turnTime--;
            document.getElementById('timer-disp').innerText = `${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}`;
            document.getElementById('turn-progress-bar').style.width = (turnTime/10 * 100) + "%";

            // 10ì´ˆë§ˆë‹¤ íŒ€ ëœë¤ êµì²´
            if(turnTime <= 0) {
                turnTime = 10;
                if(focusedId === 1) {
                    const nextTeams = {};
                    const teamPool = ['red','red','blue','blue'].sort(() => Math.random()-0.5);
                    for(let i=1; i<=4; i++) nextTeams[i] = teamPool[i-1];
                    db.update({teams: nextTeams});
                }
            }
            // 30ì´ˆë§ˆë‹¤ 2ì´ˆ ê°ì‹œ (íƒ€ì ê¸ˆì§€)
            isAlert = (time % 30 < 2 && time % 30 > 0);
            document.querySelectorAll('.radar-overlay').forEach(r => r.style.display = isAlert ? 'flex' : 'none');

            if(time <= 0) { clearInterval(mainIntr); db.update({state:'FINISHED'}); }
        }, 1000);
    }

    function updateUI() {
        // ì ìˆ˜ ê³„ì‚°
        let newScores = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
        Object.keys(pCards).forEach(w => {
            const team = pCards[w];
            for(let i=0; i<5; i++) {
                if(industryWords[i].includes(w)) newScores[team][i]++;
            }
        });
        scores = newScores;

        // ìƒë‹¨ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (20ê°œ ë‹¬ì„± ì‹œ ë¶ˆ ë“¤ì–´ì˜´)
        for(let i=0; i<5; i++) {
            const maxScore = Math.max(scores.red[i], scores.blue[i]);
            const icon = document.getElementById(`ti-${i}`);
            if(maxScore >= 20) icon.classList.add('upgrade-ready');
            else icon.classList.remove('upgrade-ready');
        }

        for(let i=1; i<=4; i++) {
            const m = document.getElementById(`mon-${i}`);
            m.className = `monitor my-team-${teams[i]} ${i===focusedId?'focused':''}`;
            const board = document.getElementById(`board-${i}`);
            board.innerHTML = allWords.map(w => `<div class="card ${pCards[w]?'owned-'+pCards[w]:''}">${w}</div>`).join('');
        }
    }

    function showResult() {
        document.getElementById('result-screen').style.display = 'flex';
        const upCount = scores.red.filter(s => s >= 20).length + scores.blue.filter(s => s >= 20).length;
        document.getElementById('evo-status').innerText = `ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥ ì˜ì—­: ${upCount} / 5`;
        
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: catNames,
                datasets: [
                    { label: 'RED MAFIA', data: scores.red, borderColor: 'red', backgroundColor: 'rgba(255,0,0,0.2)' },
                    { label: 'BLUE MAFIA', data: scores.blue, borderColor: 'blue', backgroundColor: 'rgba(0,0,255,0.2)' }
                ]
            },
            options: {
                scales: { r: { min: 0, max: 25, ticks: { display: false }, grid: { color: '#444' }, pointLabels: { color: '#fff', font: { size: 18 } } } }
            }
        });
    }

    function nextRound() {
        const upCount = scores.red.filter(s => s >= 20).length; // ì˜ˆì‹œ: ë ˆë“œ ê¸°ì¤€
        if(upCount >= 5) alert("êµ­ê°€ê°€ [ê°œë°œ ë„ìƒêµ­]ìœ¼ë¡œ ì§„í™”í–ˆìŠµë‹ˆë‹¤!");
        location.reload();
    }
</script>
</body>
</html>
