<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER: ULTRA READABILITY</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #2e86de; --yellow: #f1c40f; --dark: #0a0a0f; --neon: #00ffdd; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151a; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 3.5rem; color: var(--yellow); text-shadow: 0 0 10px var(--yellow); }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 130px 15px 15px 15px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 6px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 12px; position: relative; }
        .monitor.focused { position: fixed !important; inset: 120px 20px 20px 20px; z-index: 5000; border-width: 10px; border-color: var(--neon); box-shadow: 0 0 30px rgba(0,255,221,0.3); }
        
        /* 업그레이드 구역 */
        .upgrade-layer { display: flex; justify-content: center; gap: 5px; background: #1a1a1a; padding: 10px; }
        .up-btn { font-family: 'DungGeunMo'; padding: 10px; font-size: 0.8rem; cursor: pointer; border: 1px solid #444; background: #222; color: #777; flex: 1; border-radius: 5px; }
        .up-btn.ready { background: var(--yellow); color: #000; border-color: #fff; box-shadow: 0 0 15px var(--yellow); animation: blink 1s infinite; font-weight: bold; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* 보드 구역 - 가독성 향상 */
        .board { display: grid; grid-template-columns: repeat(14, 1fr); gap: 4px; flex: 1; padding: 15px; background: #080808; align-content: start; }
        .card { height: 45px; background: #1a1a1a; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #666; font-weight: bold; border-radius: 3px; }
        .card.owned-red { background: var(--red) !important; color: white !important; border-color: #ffcccc; box-shadow: 0 0 8px var(--red); }
        .card.owned-blue { background: var(--blue) !important; color: white !important; border-color: #cceeff; box-shadow: 0 0 8px var(--blue); }

        /* 입력창 - 가독성 극대화 */
        .input-wrap { display: flex; height: 100px; border-top: 5px solid var(--yellow); background: #000; }
        .input-box { flex: 1; background: #000; color: #00ff00; border: none; font-size: 4rem; text-align: center; outline: none; font-family: 'DungGeunMo'; padding: 10px; text-shadow: 0 0 10px #00ff00; }
        .input-box:focus { background: #051005; }
        .input-box:disabled { color: #222; text-shadow: none; }
        .input-box::placeholder { font-size: 2rem; color: #333; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .monitor-start-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        button.main-btn { padding: 25px 60px; font-family: 'DungGeunMo'; cursor: pointer; background: var(--yellow); border: none; font-size: 2rem; border-radius: 10px; transition: 0.2s; }
        button.main-btn:hover { transform: scale(1.05); background: #fff; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 4rem; margin-bottom: 10px;">NATION BUILDER</h1>
    <p style="color:var(--neon); font-size: 1.5rem;">[ 70개의 자원을 확보하여 도시를 진화시키십시오 ]</p>
    <button class="main-btn" onclick="prepareRound()">건설 현장 접속</button>
</div>

<div id="top-bar"><div id="timer-disp">SYSTEM READY</div></div>

<div id="room-view">
    <script>
        const cityList = ['발전의 도시','강철의 도시','자본의 도시','미래의 도시','지혜의 도시'];
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="upgrade-layer">
                        ${cityList.map((c, idx) => `<button class="up-btn" id="up-${i}-${idx}" onclick="requestUpgrade(event, ${i}, '${c}', ${idx})">${c.split(' ')[0]}</button>`).join('')}
                    </div>
                    <div class="monitor-start-layer" id="layer-${i}">
                        <button class="main-btn" id="btn-start-${i}" onclick="triggerStart(event, ${i})" style="display:none;">침투 시작</button>
                    </div>
                    <div id="cd-${i}" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:10rem; color:var(--yellow); z-index:4000; background:rgba(0,0,0,0.95);">3</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="터미널 잠김" disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const cityMap = {
        '발전의 도시': ['석탄','태양광','원자력','석유','전기','풍력','수소','배터리','가스','화력','수력','광물','송전탑','에너지'],
        '강철의 도시': ['철강','금속','자동차','선박','반도체','기계','로봇','화석','화학','부품','공장','엔진','주물','용접'],
        '자본의 도시': ['은행','주식','채권','투자','자산','환율','금리','펀드','보험','증권','코인','세금','대출','신용'],
        '미래의 도시': ['AI','소프트웨어','클라우드','서버','보안','코딩','알고리즘','양자','센서','회로','위성','해킹','웹3','빅데이터'],
        '지혜의 도시': ['교육','의료','대학','훈련','연구','백신','임상','장학','인재','교수','의사','도서관','백과','멘토']
    };

    let usedWords = new Set();
    let persistentCards = {}, activeWords = {}, active = false;
    let cityLevels = { red: {}, blue: {} }; 
    cityList.forEach(c => { cityLevels.red[c] = 0; cityLevels.blue[c] = 0; });

    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v8_final');

    function prepareRound() {
        document.getElementById('lobby-screen').style.display = 'none';
        const newWords = {};
        Object.keys(cityMap).forEach(city => {
            let available = cityMap[city].filter(w => !usedWords.has(w));
            if(available.length < 14) { usedWords.clear(); available = cityMap[city]; }
            const selected = available.sort(() => Math.random() - 0.5).slice(0, 14);
            selected.forEach(w => usedWords.add(w));
            newWords[city] = selected;
        });
        activeWords = newWords;
        db.update({ state: 'READY', words: activeWords, cards: {} });
        initBoardUI();
    }

    function initBoardUI() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            Object.values(activeWords).flat().forEach(w => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.querySelectorAll('.monitor-start-layer button').forEach(b => b.style.display = 'none');
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`btn-start-${id}`).style.display = 'block';
    }

    function triggerStart(event, id) {
        event.stopPropagation();
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'flex';
        let count = 3;
        const intr = setInterval(() => {
            count--; 
            if(count > 0) cd.innerText = count;
            else {
                clearInterval(intr);
                cd.style.display = 'none';
                document.getElementById(`layer-${id}`).style.display = 'none';
                const input = document.getElementById(`in-${id}`);
                input.disabled = false;
                input.placeholder = "자원 이름 입력...";
                setTimeout(() => input.focus(), 10); // 강제 포커스
                if(!active) db.update({ state: 'START' });
            }
        }, 1000);
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.words) activeWords = d.words;
        
        // 실시간 카드 색상 업데이트
        if(d.cards) {
            persistentCards = d.cards;
            Object.keys(persistentCards).forEach(w => {
                const team = persistentCards[w].team;
                for(let i=1; i<=4; i++) {
                    const cardEl = document.getElementById(`card-${i}-${w}`);
                    if(cardEl) {
                        cardEl.classList.remove('owned-red', 'owned-blue');
                        cardEl.classList.add(`owned-${team}`);
                    }
                }
            });
            updateUpgradeButtons();
        }
    });

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const team = (id === 1 || id === 2) ? 'red' : 'blue'; // 임시 팀 할당 (1,2:빨강 / 3,4:파랑)
            if(findCat(val)) {
                db.child('cards').child(val).set({ team: team });
            }
            e.target.value = "";
        }
    }

    function findCat(w) { for(let cat in cityMap) if(cityMap[cat].includes(w)) return cat; return null; }

    function updateUpgradeButtons() {
        const scores = { red: {}, blue: {} };
        cityList.forEach(c => { scores.red[c] = 0; scores.blue[c] = 0; });
        Object.keys(persistentCards).forEach(w => {
            const team = persistentCards[w].team;
            const cat = findCat(w);
            if(cat) scores[team][cat]++;
        });

        for(let i=1; i<=4; i++) {
            const team = (i === 1 || i === 2) ? 'red' : 'blue';
            cityList.forEach((cityName, idx) => {
                const btn = document.getElementById(`up-${i}-${idx}`);
                const score = scores[team][cityName];
                const lvl = cityLevels[team][cityName];
                btn.classList.remove('ready');
                if((lvl === 0 && score >= 10) || (lvl === 1 && score >= 20)) {
                    btn.classList.add('ready');
                    btn.innerText = `${cityName.split(' ')[0]} UP!`;
                } else {
                    btn.innerText = `${cityName.split(' ')[0]} (Lv.${lvl})`;
                }
            });
        }
    }

    function requestUpgrade(e, monId, cityName, btnIdx) {
        e.stopPropagation();
        const btn = document.getElementById(`up-${monId}-${btnIdx}`);
        if(!btn.classList.contains('ready')) return;
        const team = (monId === 1 || monId === 2) ? 'red' : 'blue';
        cityLevels[team][cityName]++;
        alert(`${cityName}이(가) 레벨 ${cityLevels[team][cityName]}로 업그레이드되었습니다!`);
        updateUpgradeButtons();
    }

    function startTimer() {
        let time = 1200;
        const intr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            if(time <= 0) { clearInterval(intr); alert("라운드 종료!"); }
        }, 100);
    }
</script>
</body>
</html>
