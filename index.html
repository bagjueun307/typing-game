<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA WARFARE</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff1a1a; --blue: #1a75ff; --dark: #050505; --gold: #ffea00; --neon: #00ff41; --gray: #333; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; user-select: none; }
        
        /* ÏÉÅÎã® ÎåÄÏãúÎ≥¥Îìú */
        #top-ui { height: 140px; background: #000; border-bottom: 4px solid var(--gray); display: flex; flex-direction: column; align-items: center; position: relative; }
        #main-timer { font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 10px var(--gold); margin-top: 5px; }
        
        .territory-row { display: flex; gap: 15px; margin-top: 10px; width: 100%; justify-content: center; }
        .sector-card { background: #111; border: 2px solid var(--gray); padding: 8px; width: 130px; text-align: center; border-radius: 8px; position: relative; transition: 0.3s; }
        .sector-card.captured-red { border-color: var(--red); box-shadow: 0 0 15px var(--red); }
        .sector-card.captured-blue { border-color: var(--blue); box-shadow: 0 0 15px var(--blue); }
        
        .lvl-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .sector-name { font-size: 0.9rem; font-weight: bold; }
        .progress-text { font-size: 0.75rem; color: var(--neon); display: block; }
        
        .up-btn { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; border: none; padding: 4px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; display: none; animation: blink 0.5s infinite; z-index: 10; }

        /* ÏÖîÌîå Î∞î */
        #shuffle-container { width: 100%; height: 8px; background: #222; overflow: hidden; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 0.1s linear; }

        /* Î©îÏù∏ Í≤åÏûÑ ÏòÅÏó≠ */
        #game-view { height: calc(100vh - 250px); display: flex; align-items: center; justify-content: center; position: relative; }
        #card-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; width: 95%; padding: 15px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid #222; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: #777; transition: 0.2s; }
        .card.red { background: var(--red) !important; color: #fff; border: none; font-weight: bold; }
        .card.blue { background: var(--blue) !important; color: #fff; border: none; font-weight: bold; }

        /* ÏûÖÎ†• ÏòÅÏó≠ */
        #input-area { height: 102px; border-top: 4px solid var(--gray); display: flex; align-items: center; transition: 0.3s; }
        #word-input { width: 100%; height: 100%; background: transparent; border: none; font-size: 4.5rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }
        
        /* Ïò§Î≤ÑÎ†àÏù¥ Ìö®Í≥º */
        #surveillance-overlay { position: fixed; inset: 0; background: rgba(255,0,0,0.3); z-index: 100; display: none; align-items: center; justify-content: center; pointer-events: none; }
        #surveillance-overlay h2 { font-size: 6rem; color: #fff; text-shadow: 0 0 30px #000; }
        
        #bonus-box { position: fixed; top: 25%; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 15px 40px; font-size: 2.5rem; z-index: 50; display: none; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* ÎåÄÍ∏∞ ÌôîÎ©¥ */
        #lobby { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { padding: 30px 80px; font-size: 3rem; background: var(--gold); border: none; font-family: 'DungGeunMo'; cursor: pointer; border-radius: 10px; }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 4rem; margin-bottom: 40px; color: var(--gold);">NATION BUILDER: MAFIA</h1>
    <button class="start-btn" onclick="GAME.requestStart()">OPERATION START</button>
</div>

<div id="top-ui">
    <div id="main-timer">02:00</div>
    <div class="territory-row" id="territory-row"></div>
</div>

<div id="shuffle-container"><div id="shuffle-bar"></div></div>

<div id="game-view">
    <div id="bonus-box">URGENT: <span id="bonus-word">ÏÑùÏú†</span></div>
    <div id="surveillance-overlay"><h2>üö® MONITORING... üö®</h2></div>
    <div id="card-grid"></div>
</div>

<div id="input-area">
    <input type="text" id="word-input" autocomplete="off" disabled placeholder="WAITING...">
</div>

<div id="result-screen">
    <h1 id="round-title" style="color:var(--gold); font-size:3.5rem;">ROUND REPORT</h1>
    <div id="result-stats" style="display:flex; gap:40px; margin:30px 0;"></div>
    <div style="display:flex; gap:20px;">
        <button onclick="GAME.closeResult()" style="padding:15px 40px; font-family:'DungGeunMo';">CLOSE</button>
        <button onclick="GAME.requestStart()" style="padding:15px 40px; background:var(--gold); font-family:'DungGeunMo'; font-weight:bold;">NEXT ROUND</button>
    </div>
</div>

<script>
// --- CONFIG & CONSTANTS ---
const CONFIG = {
    sectors: ['ÏóêÎÑàÏßÄ', 'Ïù∏ÌîÑÎùº', 'ÏûêÎ≥∏', 'Í∏∞Ïà†', 'Î¨∏Ìôî'],
    levels: ['Í≥µÌÑ∞', 'ÎßàÏùÑ', 'ÎèÑÏãú', 'Í∞úÎ∞úÎèÑÏÉÅÍµ≠', 'ÏÑ†ÏßÑÍµ≠'],
    lvIcons: ['fa-map', 'fa-home', 'fa-city', 'fa-flag', 'fa-crown'],
    wordPool: {
        'ÏóêÎÑàÏßÄ': ['ÏÑùÏú†','Ï†ÑÍ∏∞','ÏõêÏûêÎ†•','ÌÉúÏñëÍ¥ë','Î∞∞ÌÑ∞Î¶¨','ÏÑùÌÉÑ','Í∞ÄÏä§','ÌíçÎ†•','ÏàòÎ†•','Ï°∞Î†•','ÏÜ°Ï†Ñ','Ï†ÑÏïï','Î∞úÏ†Ñ','ÌÉÑÏÜå','Í∑∏Î¶¨Îìú','Ïó∞Î£å','Ï∂©Ï†Ñ','Î≥ÄÏ†Ñ','ÏóîÏßÑ','Í¥ëÏÇ∞'],
        'Ïù∏ÌîÑÎùº': ['ÎèÑÎ°ú','Ï≤†ÎèÑ','Ìï≠Îßå','Í≥µÌï≠','ÍµêÎüâ','ÌÑ∞ÎÑê','ÎπåÎî©','Í∞ïÏ≤†','ÏãúÎ©òÌä∏','ÌÅ¨Î†àÏù∏','ÏÉÅÏàòÎèÑ','Í±¥ÏÑ§','Î¨ºÎ•ò','Ïú†ÌÜµ','ÏÑ§Í≥Ñ','ÎèÑÏãú','ÌÜµÏã†','Î≤ΩÎèå','Ï§ëÏû•ÎπÑ','Ï†ïÎπÑ'],
        'ÏûêÎ≥∏': ['Ï£ºÏãù','Ï±ÑÍ∂å','Ìà¨Ïûê','ÏùÄÌñâ','Í∏àÎ¶¨','ÌôòÏú®','ÏÑ∏Í∏à','ÏòàÏÇ∞','Î≥¥Ìóò','Ï¶ùÍ∂å','ÌéÄÎìú','Í≤ΩÏ†ú','ÌôîÌèê','ÎπÑÏö©','ÏûêÏÇ∞','Î¨¥Ïó≠','ÏΩîÏù∏','Î∞∞Îãπ','Ï¶ùÏãú','Î∂ÄÏ±Ñ'],
        'Í∏∞Ïà†': ['AI','Î°úÎ¥á','ÏΩîÎî©','Î≥¥Ïïà','ÏÑúÎ≤Ñ','Î∞òÎèÑÏ≤¥','Îç∞Ïù¥ÌÑ∞','ÏñëÏûê','Ìï¥ÌÇπ','ÎìúÎ°†','ÏúÑÏÑ±','ÏÑºÏÑú','Î∞±Ïã†','Î™®Î∞îÏùº','Ïπ©','ÏÜåÏä§','ÌöåÎ°ú','Î®∏Ïã†','Ïù∏ÌÑ∞ÎÑ∑','Ïõπ'],
        'Î¨∏Ìôî': ['ÍµêÏú°','ÏùòÎ£å','ÎåÄÌïô','Ï≤†Ìïô','Ïó≠ÏÇ¨','Í≥ºÌïô','ÎÖºÎ¶¨','Î≤ïÎ•†','Ïñ∏Ïñ¥','Ïã¨Î¶¨','ÎØ∏ÎîîÏñ¥','ÏòàÏà†','ÏòÅÌôî','ÏùåÏïÖ','Ï∂ïÏ†ú','Ïú†ÏÇ∞','ÌïúÍ∏Ä','Ï¢ÖÍµê','Ï†ÑÌÜµ','Ï†ïÏã†']
    }
};

const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_v3');

// --- GAME ENGINE ---
const GAME = {
    team: 'red',
    myMonitorSlot: 'm' + (new URLSearchParams(window.location.search).get('m') || '1'), // ?m=1~4
    active: false,
    timerInt: null,

    init() {
        this.renderInitialSectors();
        this.listenFirebase();
        this.bindEvents();
    },

    renderInitialSectors() {
        const row = document.getElementById('territory-row');
        row.innerHTML = CONFIG.sectors.map((s, i) => `
            <div class="sector-card" id="sector-${i}">
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE</button>
                <i class="fas ${CONFIG.lvIcons[0]} lvl-icon" id="icon-${i}"></i>
                <div class="sector-name">${s}</div>
                <span class="progress-text" id="prog-${i}">0 / 5</span>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDatabase();
            this.sync(data);
        });
    },

    resetDatabase() {
        db.set({
            state: 'READY',
            timer: 120,
            shuffle: 10,
            words: Object.values(CONFIG.wordPool).flat(),
            cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1:'red', m2:'red', m3:'blue', m4:'blue' },
            bonus: "",
            surveillance: false
        });
    },

    sync(data) {
        // 1. ÎåÄÍ∏∞/ÏßÑÌñâ ÌôîÎ©¥ Ï†ÑÌôò
        document.getElementById('lobby').style.display = (data.state === 'READY') ? 'flex' : 'none';
        
        // 2. ÎÇ¥ ÌåÄ ÌôïÏù∏ Î∞è Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω
        this.team = data.teams[this.myMonitorSlot];
        document.getElementById('input-area').style.background = (this.team === 'red') ? 'var(--red)' : 'var(--blue)';
        document.getElementById('word-input').placeholder = this.team.toUpperCase() + " TEAM INPUT...";
        
        // 3. ÌÉÄÏù¥Î®∏ Î∞è ÏÖîÌîåÎ∞î
        document.getElementById('main-timer').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffle / 10) * 100 + "%";

        // 4. Ïπ¥Îìú Î≥¥Îìú ÎèôÍ∏∞Ìôî
        const grid = document.getElementById('card-grid');
        if(grid.childElementCount === 0) {
            grid.innerHTML = data.words.map(w => `<div class="card" id="card-${w}">${w}</div>`).join('');
        }
        
        // ÏÜåÏú†Í∂å ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏûêÏõê Ïπ¥Ïö¥Ìä∏
        const myResource = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, team]) => {
            const cardEl = document.getElementById(`card-${word}`);
            if(cardEl) cardEl.className = `card ${team}`;
            if(team === this.team) {
                const sIdx = this.getSectorIdx(word);
                if(sIdx !== -1) myResource[sIdx]++;
            }
        });

        // 5. ÏÉÅÎã® ÏÑπÌÑ∞ UI ÏóÖÎç∞Ïù¥Ìä∏
        CONFIG.sectors.forEach((_, i) => {
            const redLv = data.levels.red[i];
            const blueLv = data.levels.blue[i];
            const myLv = data.levels[this.team][i];
            const sectorEl = document.getElementById(`sector-${i}`);
            
            // ÏÑ†ÏßÑÍµ≠ Ï†êÎ†π ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if(redLv === 4) sectorEl.className = "sector-card captured-red";
            else if(blueLv === 4) sectorEl.className = "sector-card captured-blue";
            else sectorEl.className = "sector-card";

            const currentMaxLv = Math.max(redLv, blueLv);
            document.getElementById(`icon-${i}`).className = `fas ${CONFIG.lvIcons[currentMaxLv]} lvl-icon`;
            document.getElementById(`prog-${i}`).innerText = `${myResource[i]} / 5 (LV.${myLv})`;
            
            // ÏóÖÍ∑∏Î†àÏù¥Îìú Î≤ÑÌäº ÌôúÏÑ±Ìôî (5Í∞ú ÏàòÏßë & ÏÑ†ÏßÑÍµ≠ ÎØ∏Îã¨ÏÑ± & Ìï¥Îãπ ÏÑπÌÑ∞ Ï£ºÏù∏Ïù¥ ÏóÜÏùÑ Îïå)
            const upBtn = document.getElementById(`up-btn-${i}`);
            const someoneWon = (redLv === 4 || blueLv === 4);
            upBtn.style.display = (myResource[i] >= 5 && myLv < 4 && !someoneWon) ? 'block' : 'none';
        });

        // 6. ÌäπÏàò Ìö®Í≥º (Î≥¥ÎÑàÏä§, Í∞êÏãú)
        document.getElementById('bonus-box').style.display = data.bonus ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonus;
        document.getElementById('surveillance-overlay').style.display = data.surveillance ? 'flex' : 'none';
        
        // 7. Í≤åÏûÑ ÏÉÅÌÉú Ìä∏Î¶¨Í±∞
        if(data.state === 'RUNNING' && !this.active) this.startClientLogic();
        if(data.state === 'FINISHED') this.showResult(data);
    },

    requestStart() {
        // Î™®Îì† Î™®ÎãàÌÑ∞Í∞Ä ÎèôÏãú ÏãúÏûëÌïòÎèÑÎ°ù DB ÏóÖÎç∞Ïù¥Ìä∏
        const allWords = Object.values(CONFIG.wordPool).flat().sort(() => Math.random() - 0.5);
        db.update({ 
            state: 'RUNNING', 
            timer: 120, 
            shuffle: 10, 
            words: allWords, 
            cards: {},
            bonus: "",
            surveillance: false
        });
    },

    startClientLogic() {
        this.active = true;
        document.getElementById('word-input').disabled = false;
        document.getElementById('word-input').focus();
        
        // ÎßàÏä§ÌÑ∞ Î™®ÎãàÌÑ∞(m1)Îßå ÏÑúÎ≤Ñ ÌÉÄÏù¥Î®∏Î•º Í¥ÄÎ¶¨Ìï® (Ï§ëÎ≥µ Î∞©ÏßÄ)
        if(this.myMonitorSlot === 'm1') this.runServerTimer();
    },

    runServerTimer() {
        let time = 120, shuffle = 10, bonusTick = 20, surveillanceTick = 30;
        
        const tick = setInterval(() => {
            time--; shuffle--; bonusTick--; surveillanceTick--;
            
            const updates = { timer: time, shuffle: shuffle };

            // 10Ï¥à ÏÖîÌîå
            if(shuffle <= 0) {
                updates.shuffle = 10;
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                updates.teams = { m1:ts[0], m2:ts[1], m3:ts[2], m4:ts[3] };
            }

            // 20Ï¥à Î≥¥ÎÑàÏä§
            if(bonusTick <= 0) {
                bonusTick = 20;
                const allWords = Object.values(CONFIG.wordPool).flat();
                updates.bonus = allWords[Math.floor(Math.random()*allWords.length)];
            }

            // 30Ï¥à Í∞êÏãú (2Ï¥àÍ∞Ñ)
            if(surveillanceTick === 0) {
                updates.surveillance = true;
                setTimeout(() => db.update({ surveillance: false }), 2000);
                surveillanceTick = 30;
            }

            if(time <= 0) {
                clearInterval(tick);
                updates.state = 'FINISHED';
            }
            
            db.update(updates);
        }, 1000);
    },

    bindEvents() {
        const input = document.getElementById('word-input');
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const val = input.value.trim();
                this.processInput(val);
                input.value = "";
            }
        });
    },

    processInput(val) {
        db.once('value', snap => {
            const data = snap.val();
            // Í∞êÏãú Ìå®ÎÑêÌã∞
            if(data.surveillance) {
                const myCards = Object.keys(data.cards || {}).filter(w => data.cards[w] === this.team);
                if(myCards.length > 0) db.child('cards').child(myCards[0]).remove();
                return;
            }
            // Î≥¥ÎÑàÏä§ Ï†ïÎãµ
            if(val === data.bonus && data.bonus !== "") {
                const enemy = this.team === 'red' ? 'blue' : 'red';
                const enemyCards = Object.keys(data.cards || {}).filter(w => data.cards[w] === enemy);
                enemyCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                db.update({ bonus: "" });
            } 
            // ÏùºÎ∞ò Îã®Ïñ¥
            else if(data.words.includes(val)) {
                db.child('cards').child(val).set(this.team);
            }
        });
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const sectorWords = CONFIG.wordPool[CONFIG.sectors[idx]];
            const myOwned = Object.keys(data.cards || {}).filter(w => data.cards[w] === this.team && sectorWords.includes(w));
            
            if(myOwned.length >= 5) {
                myOwned.slice(0, 5).forEach(w => db.child('cards').child(w).remove());
                const currentLevels = data.levels[this.team];
                currentLevels[idx]++;
                db.child('levels').child(this.team).set(currentLevels);
                
                // ÏäπÎ¶¨ ÌåêÏ†ï (3Í∞ú ÏÑπÏÖò ÏÑ†ÏßÑÍµ≠)
                if(currentLevels.filter(lv => lv === 4).length >= 3) {
                    db.update({ state: 'FINISHED', winner: this.team });
                }
            }
        });
    },

    showResult(data) {
        this.active = false;
        document.getElementById('word-input').disabled = true;
        const res = document.getElementById('result-screen');
        res.style.display = 'flex';
        
        const stats = document.getElementById('result-stats');
        stats.innerHTML = ['red', 'blue'].map(t => `
            <div style="color:var(--${t}); text-align:center;">
                <h2>${t.toUpperCase()} MAFIA</h2>
                ${CONFIG.sectors.map((s, i) => `<div>${s}: ${CONFIG.levels[data.levels[t][i]]}</div>`).join('')}
            </div>
        `).join('');
    },

    closeResult() { document.getElementById('result-screen').style.display = 'none'; },
    getSectorIdx(w) { return Object.values(CONFIG.wordPool).findIndex(list => list.includes(w)); },
    formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
};

GAME.init();
</script>
</body>
</html>
