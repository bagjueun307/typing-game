<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff1a1a; --blue: #1a75ff; --dark: #050505; --gold: #ffea00; --neon: #00ff41; --gray: #333; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; }
        
        /* í—¤ë”: íƒ€ì´ë¨¸ & ì˜í†  ìƒíƒœ */
        #top-ui { height: 160px; background: #000; border-bottom: 4px solid var(--gray); display: flex; flex-direction: column; align-items: center; position: relative; }
        #main-timer { font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 10px var(--gold); margin: 5px 0; }
        
        .territory-row { display: flex; gap: 12px; width: 100%; justify-content: center; }
        .sector-card { background: #111; border: 2px solid var(--gray); padding: 10px; width: 140px; text-align: center; border-radius: 8px; position: relative; }
        .sector-card.cap-red { border-color: var(--red); box-shadow: 0 0 15px var(--red); background: rgba(255,26,26,0.1); }
        .sector-card.cap-blue { border-color: var(--blue); box-shadow: 0 0 15px var(--blue); background: rgba(26,117,255,0.1); }
        
        .lvl-step { font-size: 0.7rem; color: #888; display: block; }
        .sector-name { font-size: 1rem; font-weight: bold; margin: 4px 0; }
        .progress-box { font-size: 0.8rem; color: var(--neon); background: #000; border-radius: 4px; padding: 2px; }
        
        /* ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ */
        .up-btn { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; border: none; padding: 5px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; display: none; animation: blink 0.5s infinite; z-index: 100; font-family: 'DungGeunMo'; }

        /* 10ì´ˆ ì…”í”Œ ë°” */
        #shuffle-container { width: 100%; height: 12px; background: #222; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 1s linear; }

        /* ë‹¨ì–´ ë³´ë“œ */
        #game-view { height: calc(100vh - 274px); display: flex; align-items: center; justify-content: center; position: relative; overflow-y: auto; }
        #card-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; width: 95%; padding: 20px; }
        .card { background: #1a1a1a; border: 1px solid #333; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #666; transition: 0.2s; }
        .card.red { background: var(--red) !important; color: #fff; border: none; font-weight: bold; }
        .card.blue { background: var(--blue) !important; color: #fff; border: none; font-weight: bold; }

        /* ì…ë ¥ì°½ & íŒ€ ì»¬ëŸ¬ ë°°ê²½ */
        #input-area { height: 102px; border-top: 4px solid var(--gray); display: flex; align-items: center; transition: background 0.3s; }
        #word-input { width: 100%; height: 100%; background: transparent; border: none; font-size: 4.5rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }
        
        /* íŠ¹ìˆ˜ íš¨ê³¼ */
        #bonus-box { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--gold); color: #000; padding: 20px 50px; font-size: 3rem; z-index: 500; display: none; border: 5px solid #000; }
        #surveillance { position: fixed; inset: 0; background: rgba(255,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; font-size: 5rem; font-weight: bold; pointer-events: none; }

        /* íŒì—… UI */
        #lobby, #result-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { padding: 25px 60px; font-size: 2.5rem; background: var(--gold); border: none; font-family: 'DungGeunMo'; cursor: pointer; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 4rem; color: var(--gold); margin-bottom: 20px;">NATION BUILDER</h1>
    <p style="font-size: 1.5rem; margin-bottom: 40px;">MAFIA WARFARE : TERRITORY DOMINATION</p>
    <button class="start-btn" onclick="GAME.requestStart()">START OPERATION</button>
</div>

<div id="top-ui">
    <div id="main-timer">02:00</div>
    <div class="territory-row" id="territory-row"></div>
</div>
<div id="shuffle-container"><div id="shuffle-bar"></div></div>

<div id="game-view">
    <div id="bonus-box">URGENT: <span id="bonus-word"></span></div>
    <div id="surveillance">ğŸš¨ ê°ì‹œ ì¤‘: ì¤‘ë‹¨í•˜ì‹­ì‹œì˜¤! ğŸš¨</div>
    <div id="card-grid"></div>
</div>

<div id="input-area">
    <input type="text" id="word-input" autocomplete="off" disabled>
</div>

<div id="result-screen" style="display:none;">
    <h1 style="color:var(--gold); font-size:3.5rem;">ROUND ANALYSIS</h1>
    <div id="result-stats" style="display:flex; gap:50px; margin:40px 0; font-size:1.5rem;"></div>
    <button onclick="GAME.requestStart()" class="start-btn">NEXT ROUND</button>
</div>

<script>
const CONFIG = {
    sectors: ['ì—ë„ˆì§€', 'ì¸í”„ë¼', 'ìë³¸', 'ê¸°ìˆ ', 'ë¬¸í™”'],
    levels: ['ê³µí„°', 'ë§ˆì„', 'ë„ì‹œ', 'ê°œë°œë„ìƒêµ­', 'ì„ ì§„êµ­'],
    wordPool: {
        'ì—ë„ˆì§€': ['ì„ìœ ','ì „ê¸°','ì›ìë ¥','íƒœì–‘ê´‘','ë°°í„°ë¦¬','ì„íƒ„','ê°€ìŠ¤','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ì†¡ì „','ì „ì••','ë°œì „','íƒ„ì†Œ','ì—°ë£Œ','ê·¸ë¦¬ë“œ','ë³€ì „','ì—”ì§„','ì¶©ì „','ì—ë„ˆì§€'],
        'ì¸í”„ë¼': ['ë„ë¡œ','ì² ë„','í•­ë§Œ','ê³µí•­','êµëŸ‰','í„°ë„','ë¹Œë”©','ê°•ì² ','ì‹œë©˜íŠ¸','í¬ë ˆì¸','ìƒìˆ˜ë„','ê±´ì„¤','ë¬¼ë¥˜','ìœ í†µ','ì„¤ê³„','ë„ì‹œ','í†µì‹ ','ë²½ëŒ','ì¤‘ì¥ë¹„','ì •ë¹„'],
        'ìë³¸': ['ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ì€í–‰','ê¸ˆë¦¬','í™˜ìœ¨','ì„¸ê¸ˆ','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','í€ë“œ','ê²½ì œ','í™”í','ë¹„ìš©','ìì‚°','ë¬´ì—­','ì½”ì¸','ë°°ë‹¹','ì¦ì‹œ','ë¶€ì±„'],
        'ê¸°ìˆ ': ['AI','ë¡œë´‡','ì½”ë”©','ë³´ì•ˆ','ì„œë²„','ë°˜ë„ì²´','ë°ì´í„°','ì–‘ì','í•´í‚¹','ë“œë¡ ','ìœ„ì„±','ì„¼ì„œ','ë°±ì‹ ','ëª¨ë°”ì¼','ì¹©','ì†ŒìŠ¤','íšŒë¡œ','ë¨¸ì‹ ','ì¸í„°ë„·','ì›¹'],
        'ë¬¸í™”': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ','ì–¸ì–´','ì‹¬ë¦¬','ë¯¸ë””ì–´','ì˜ˆìˆ ','ì˜í™”','ìŒì•…','ì¶•ì œ','ìœ ì‚°','í•œê¸€','ì¢…êµ','ì „í†µ','ì •ì‹ ']
    }
};

const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_v4');

const GAME = {
    team: 'red',
    slot: 'm' + (new URLSearchParams(window.location.search).get('m') || '1'),
    active: false,

    init() {
        this.renderSectors();
        this.listenFirebase();
        this.bindEvents();
    },

    renderSectors() {
        const row = document.getElementById('territory-row');
        row.innerHTML = CONFIG.sectors.map((s, i) => `
            <div class="sector-card" id="sector-${i}">
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE</button>
                <span class="lvl-step" id="lvl-${i}">ê³µí„°</span>
                <div class="sector-name">${s}</div>
                <div class="progress-box" id="prog-${i}">0 / 5</div>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDB();
            this.sync(data);
        });
    },

    resetDB() {
        db.set({
            state: 'READY', timer: 120, shuffle: 10,
            words: Object.values(CONFIG.wordPool).flat().sort(()=>Math.random()-0.5),
            cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1:'red', m2:'red', m3:'blue', m4:'blue' },
            bonus: "", surveillance: false
        });
    },

    sync(data) {
        // 1. ìƒíƒœë³„ í™”ë©´ ì „í™˜
        document.getElementById('lobby').style.display = (data.state === 'READY') ? 'flex' : 'none';
        document.getElementById('result-screen').style.display = (data.state === 'FINISHED') ? 'flex' : 'none';
        
        // 2. 10ì´ˆ ì…”í”Œ & íŒ€ ë°°ì • (í•µì‹¬)
        this.team = data.teams[this.slot];
        document.getElementById('input-area').style.background = (this.team === 'red') ? 'var(--red)' : 'var(--blue)';
        document.getElementById('word-input').disabled = (data.state !== 'RUNNING');
        
        // 3. íƒ€ì´ë¨¸ ë° ë°”
        document.getElementById('main-timer').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffle / 10) * 100 + "%";

        // 4. ë‹¨ì–´ ì¹´ë“œ ì†Œìœ ê¶Œ
        const grid = document.getElementById('card-grid');
        if(grid.childElementCount === 0) {
            grid.innerHTML = data.words.map(w => `<div class="card" id="card-${w}">${w}</div>`).join('');
        }
        
        const myRes = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, team]) => {
            const el = document.getElementById(`card-${word}`);
            if(el) el.className = `card ${team}`;
            if(team === this.team) {
                const idx = this.getSectorIdx(word);
                if(idx !== -1) myRes[idx]++;
            }
        });

        // 5. ì˜í†  ë°œì „ ìƒíƒœ ì‹œê°í™”
        CONFIG.sectors.forEach((_, i) => {
            const rLv = data.levels.red[i], bLv = data.levels.blue[i], myLv = data.levels[this.team][i];
            const sectorEl = document.getElementById(`sector-${i}`);
            
            // ì„ ì§„êµ­ ì ë ¹ ì‹œ ì‹œê° íš¨ê³¼
            if(rLv === 4) sectorEl.className = "sector-card cap-red";
            else if(bLv === 4) sectorEl.className = "sector-card cap-blue";
            else sectorEl.className = "sector-card";

            document.getElementById(`lvl-${i}`).innerText = CONFIG.levels[Math.max(rLv, bLv)];
            document.getElementById(`prog-${i}`).innerText = `${myRes[i]} / 5 (ë‚´ ë‹¨ê³„: ${CONFIG.levels[myLv]})`;
            
            // ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ í™œì„±í™”
            const upBtn = document.getElementById(`up-btn-${i}`);
            const isFinished = (rLv === 4 || bLv === 4);
            upBtn.style.display = (myRes[i] >= 5 && myLv < 4 && !isFinished) ? 'block' : 'none';
        });

        // 6. íŠ¹ìˆ˜ ëª¨ë“œ
        document.getElementById('bonus-box').style.display = data.bonus ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonus;
        document.getElementById('surveillance').style.display = data.surveillance ? 'flex' : 'none';

        // 7. ê²°ê³¼ ë¶„ì„ ì°½
        if(data.state === 'FINISHED') {
            document.getElementById('result-stats').innerHTML = ['red','blue'].map(t => `
                <div style="color:var(--${t}); border:2px solid; padding:20px;">
                    <h2 style="margin:0">${t.toUpperCase()} MAFIA</h2><hr>
                    ${CONFIG.sectors.map((s,i)=>`<div>${s}: ${CONFIG.levels[data.levels[t][i]]}</div>`).join('')}
                </div>
            `).join('');
        }

        // 8. ë§ˆìŠ¤í„° íƒ€ì´ë¨¸ ê°€ë™
        if(this.slot === 'm1' && data.state === 'RUNNING' && !this.active) {
            this.active = true;
            this.runMasterTimer();
        }
    },

    runMasterTimer() {
        let bCount = 20, sCount = 30;
        const tick = setInterval(() => {
            db.once('value', snap => {
                const data = snap.val();
                if(data.state !== 'RUNNING') return clearInterval(tick);

                let upd = { timer: data.timer - 1, shuffle: data.shuffle - 1 };
                bCount--; sCount--;

                // 10ì´ˆ ê°•ì œ ì…”í”Œ
                if(upd.shuffle <= 0) {
                    upd.shuffle = 10;
                    const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                    upd.teams = { m1:ts[0], m2:ts[1], m3:ts[2], m4:ts[3] };
                }

                // 20ì´ˆ ë³´ë„ˆìŠ¤
                if(bCount <= 0) {
                    bCount = 20;
                    const pool = Object.values(CONFIG.wordPool).flat();
                    upd.bonus = pool[Math.floor(Math.random()*pool.length)];
                }

                // 30ì´ˆ ê°ì‹œ
                if(sCount <= 0) {
                    sCount = 30;
                    db.update({ surveillance: true });
                    setTimeout(() => db.update({ surveillance: false }), 2000);
                }

                if(upd.timer <= 0) upd.state = 'FINISHED';
                db.update(upd);
            });
        }, 1000);
    },

    requestStart() {
        db.update({ state: 'RUNNING', timer: 120, shuffle: 10, cards: {}, bonus: "", surveillance: false });
    },

    bindEvents() {
        const inp = document.getElementById('word-input');
        inp.onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = inp.value.trim();
                db.once('value', snap => {
                    const data = snap.val();
                    if(data.surveillance) { // ê°ì‹œ íŒ¨ë„í‹°
                        const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team);
                        if(mine.length > 0) db.child('cards').child(mine[0]).remove();
                    } else if(val === data.bonus) { // ë³´ë„ˆìŠ¤
                        const enemy = this.team === 'red' ? 'blue' : 'red';
                        const eCards = Object.keys(data.cards||{}).filter(w => data.cards[w] === enemy);
                        eCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                        db.update({ bonus: "" });
                    } else if(data.words.includes(val)) { // ì¼ë°˜
                        db.child('cards').child(val).set(this.team);
                    }
                });
                inp.value = "";
            }
        };
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const words = CONFIG.wordPool[CONFIG.sectors[idx]];
            const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team && words.includes(w));
            if(mine.length >= 5) {
                mine.slice(0,5).forEach(w => db.child('cards').child(w).remove());
                const lvs = data.levels[this.team];
                lvs[idx]++;
                db.child('levels').child(this.team).set(lvs);
                if(lvs.filter(v => v === 4).length >= 3) db.update({ state: 'FINISHED' });
            }
        });
    },

    getSectorIdx(w) { return Object.values(CONFIG.wordPool).findIndex(l => l.includes(w)); },
    formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
};

GAME.init();
</script>
</body>
</html>
