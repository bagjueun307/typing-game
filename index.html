<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER: STEP UP</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #D63031; --blue: #0984E3; --yellow: #FDCB6E; --dark: #0A0A0F; --laser: #FF0000; --ai: #00FFDD; --silver: #bdc3c7; --gold: #f1c40f; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151A; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 3rem; color: var(--yellow); }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 130px 15px 15px 15px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 6px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 12px; position: relative; transition: 0.3s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 120px 20px 20px 20px; z-index: 5000; border-width: 12px; }
        
        .team-indicator { font-size: 1.2rem; padding: 8px; text-align: center; font-weight: bold; }
        .monitor.team-red { border-color: var(--red); }
        .monitor.team-blue { border-color: var(--blue); }
        .monitor.team-red .team-indicator { background: var(--red); }
        .monitor.team-blue .team-indicator { background: var(--blue); }

        /* ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ ë ˆì´ì–´ */
        .upgrade-layer { display: flex; justify-content: center; gap: 5px; background: #222; padding: 5px; border-top: 1px solid #444; }
        .up-btn { font-family: 'DungGeunMo'; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; border: none; background: #444; color: #888; border-radius: 4px; }
        .up-btn.ready { background: var(--yellow); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--yellow); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }

        .board { display: grid; grid-template-columns: repeat(14, 1fr); gap: 3px; flex: 1; padding: 10px; background: #000; }
        .card { height: 35px; background: #1A1A1A; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #666; }
        .card.owned-red { background: var(--red) !important; color: white; border-color: #fff; }
        .card.owned-blue { background: var(--blue) !important; color: white; border-color: #fff; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        button.main-btn { padding: 15px 40px; font-family: 'DungGeunMo'; cursor: pointer; background: var(--yellow); border: none; font-size: 1.3rem; margin: 10px; }
        
        /* ê²°ê³¼ì°½ ì°¨íŠ¸ */
        .chart-grid { display: flex; gap: 20px; }
        .chart-item { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 2px solid #444; width: 420px; }
        .rank-badge { font-size: 1.4rem; color: var(--ai); margin: 5px 0; border: 1px solid var(--ai); padding: 5px; }
        .oracle-memo { background: rgba(0, 255, 221, 0.1); border-left: 5px solid var(--ai); padding: 10px; margin-top: 10px; font-size: 0.85rem; text-align: left; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 3rem;">NATION BUILDER: EVOLUTION</h1>
    <div id="evo-status" style="display:flex; gap:10px; margin-bottom:20px;"></div>
    <button class="main-btn" onclick="prepareRound()">ìƒˆ ìì› êµ¬ì—­ ì§„ì…</button>
</div>

<div id="result-screen" class="overlay" style="display:none; z-index:11000;">
    <h1 style="color:var(--yellow); font-size: 2rem;">[êµ­ê°€ ë„ì‹œ ê°œë°œ ë³´ê³ ì„œ]</h1>
    <div class="chart-grid">
        <div class="chart-item" style="border-color: var(--red);">
            <h2 style="color:var(--red);">RED TEAM</h2>
            <div id="rank-red" class="rank-badge">-</div>
            <canvas id="final-chart-red" width="380" height="300"></canvas>
            <div id="tip-red" class="oracle-memo"></div>
        </div>
        <div class="chart-item" style="border-color: var(--blue);">
            <h2 style="color:var(--blue);">BLUE TEAM</h2>
            <div id="rank-blue" class="rank-badge">-</div>
            <canvas id="final-chart-blue" width="380" height="300"></canvas>
            <div id="tip-blue" class="oracle-memo"></div>
        </div>
    </div>
    <button class="main-btn" onclick="closeResult()">ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰</button>
</div>

<div id="top-bar"><div id="timer-disp">120.0s</div></div>

<div id="room-view">
    <script>
        const cities = ['ë°œì „ì˜ ë„ì‹œ','ê°•ì² ì˜ ë„ì‹œ','ìë³¸ì˜ ë„ì‹œ','ë¯¸ë˜ì˜ ë„ì‹œ','ì§€í˜œì˜ ë„ì‹œ'];
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="team-indicator" id="team-text-${i}">ì ‘ì† ëŒ€ê¸°</div>
                    <div class="upgrade-layer">
                        ${cities.map((c, idx) => `<button class="up-btn" id="up-${i}-${idx}" onclick="requestUpgrade(event, ${i}, '${c}', ${idx})">${c.split(' ')[0]} UP</button>`).join('')}
                    </div>
                    <div class="monitor-start-layer" id="layer-${i}">
                        <button class="main-btn" id="btn-start-${i}" onclick="triggerStart(event, ${i})" style="display:none;">ê±´ì„¤ ì‹œì‘</button>
                    </div>
                    <div id="cd-${i}" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:12rem; color:var(--yellow); z-index:4000; background:rgba(0,0,0,0.8);">3</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ìì› ë‹¨ì–´ ì…ë ¥" disabled></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const cityMap = {
        'ë°œì „ì˜ ë„ì‹œ': ['ì„íƒ„','íƒœì–‘ê´‘','ì›ìë ¥','ì„ìœ ','ì „ê¸°','í’ë ¥','ìˆ˜ì†Œ','ë°°í„°ë¦¬','ê°€ìŠ¤','í™”ë ¥','ìˆ˜ë ¥','ê´‘ë¬¼','ì†¡ì „íƒ‘','ì—ë„ˆì§€'],
        'ê°•ì² ì˜ ë„ì‹œ': ['ì² ê°•','ê¸ˆì†','ìë™ì°¨','ì„ ë°•','ë°˜ë„ì²´','ê¸°ê³„','ë¡œë´‡','í™”ì„','í™”í•™','ë¶€í’ˆ','ê³µì¥','ì—”ì§„','ì£¼ë¬¼','ìš©ì ‘'],
        'ìë³¸ì˜ ë„ì‹œ': ['ì€í–‰','ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ìì‚°','í™˜ìœ¨','ê¸ˆë¦¬','í€ë“œ','ë³´í—˜','ì¦ê¶Œ','ì½”ì¸','ì„¸ê¸ˆ','ëŒ€ì¶œ','ì‹ ìš©'],
        'ë¯¸ë˜ì˜ ë„ì‹œ': ['AI','ì†Œí”„íŠ¸ì›¨ì–´','í´ë¼ìš°ë“œ','ì„œë²„','ë³´ì•ˆ','ì½”ë”©','ì•Œê³ ë¦¬ì¦˜','ì–‘ì','ì„¼ì„œ','íšŒë¡œ','ìœ„ì„±','í•´í‚¹','ì›¹3','ë¹…ë°ì´í„°'],
        'ì§€í˜œì˜ ë„ì‹œ': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','í›ˆë ¨','ì—°êµ¬','ë°±ì‹ ','ì„ìƒ','ì¥í•™','ì¸ì¬','êµìˆ˜','ì˜ì‚¬','ë„ì„œê´€','ë°±ê³¼','ë©˜í† ']
    };

    let usedWords = new Set();
    let persistentCards = {}, activeWords = {}, active = false;
    let cityLevels = { red: {}, blue: {} }; // 0:ê³µí„°, 1:ë§ˆì„, 2:ë„ì‹œ
    
    // ì´ˆê¸°í™”
    Object.keys(cityMap).forEach(c => { cityLevels.red[c] = 0; cityLevels.blue[c] = 0; });

    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_builder_v8');

    function prepareRound() {
        document.getElementById('lobby-screen').style.display = 'none';
        const newWords = {};
        Object.keys(cityMap).forEach(city => {
            let available = cityMap[city].filter(w => !usedWords.has(w));
            if(available.length < 14) { usedWords.clear(); available = cityMap[city]; }
            const selected = available.sort(() => Math.random() - 0.5).slice(0, 14);
            selected.forEach(w => usedWords.add(w));
            newWords[city] = selected;
        });
        activeWords = newWords;
        const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
        db.update({ state: 'READY', teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
        initBoardUI();
    }

    function initBoardUI() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            Object.values(activeWords).flat().forEach(w => {
                const div = document.createElement('div');
                div.className = `card ${persistentCards[w]? 'owned-'+persistentCards[w].team : ''}`;
                div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.querySelectorAll('.monitor-start-layer button').forEach(b => b.style.display = 'none');
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`btn-start-${id}`).style.display = 'block';
    }

    function triggerStart(e, id) {
        e.stopPropagation();
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'flex';
        let count = 3;
        const intr = setInterval(() => {
            count--; if(count > 0) cd.innerText = count;
            else {
                clearInterval(intr); cd.style.display = 'none';
                document.getElementById(`layer-${id}`).style.display = 'none';
                db.update({ state: 'START' });
                document.getElementById(`in-${id}`).disabled = false;
                document.getElementById(`in-${id}`).focus();
            }
        }, 1000);
    }

    // ì—…ê·¸ë ˆì´ë“œ ìš”ì²­
    function requestUpgrade(e, monId, cityName, btnIdx) {
        e.stopPropagation();
        const team = document.getElementById(`mon-${monId}`).classList.contains('team-red') ? 'red' : 'blue';
        const currentCount = currentScores[team][cityName];
        const currentLvl = cityLevels[team][cityName];

        // ë§ˆì„(1ë‹¨ê³„) ì¡°ê±´: ë‹¨ì–´ 10ê°œ & Level 0
        if(currentLvl === 0 && currentCount >= 10) {
            cityLevels[team][cityName] = 1;
            db.child('levels').child(team).child(cityName).set(1);
            alert(`[${team.toUpperCase()}] ${cityName}ì´(ê°€) 'ë§ˆì„'ë¡œ ìŠ¹ê²©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        } 
        // ë„ì‹œ(2ë‹¨ê³„) ì¡°ê±´: ë‹¨ì–´ 20ê°œ & Level 1 (ëˆ„ì ì¹˜ ê¸°ì¤€)
        else if(currentLvl === 1 && currentCount >= 20) {
            cityLevels[team][cityName] = 2;
            db.child('levels').child(team).child(cityName).set(2);
            alert(`[${team.toUpperCase()}] ${cityName}ì´(ê°€) 'ë„ì‹œ'ë¡œ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        } else {
            alert("ìì›ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ì´ë¯¸ ìµœê³  ë‹¨ê³„ì…ë‹ˆë‹¤.");
        }
    }

    let currentScores = { red: {}, blue: {} };
    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            for(let i=1; i<=4; i++) {
                const m = document.getElementById(`mon-${i}`);
                m.className = `monitor team-${d.teams[i]} ${m.classList.contains('focused')?'focused':''}`;
                document.getElementById(`team-text-${i}`).innerText = `[ì†Œì†: ${d.teams[i].toUpperCase()} TEAM]`;
            }
        }
        if(d.levels) { cityLevels = d.levels; }
        if(d.cards) {
            persistentCards = d.cards;
            const scores = { red: {}, blue: {} };
            Object.keys(cityMap).forEach(c => { scores.red[c] = 0; scores.blue[c] = 0; });
            Object.keys(persistentCards).forEach(w => {
                const team = persistentCards[w].team;
                const cat = findCat(w);
                if(cat && team !== 'neutral') scores[team][cat]++;
            });
            currentScores = scores;
            updateUIByScore();
        }
    });

    function updateUIByScore() {
        for(let i=1; i<=4; i++) {
            const team = document.getElementById(`mon-${i}`).classList.contains('team-red') ? 'red' : 'blue';
            Object.keys(cityMap).forEach((cityName, idx) => {
                const btn = document.getElementById(`up-${i}-${idx}`);
                const score = currentScores[team][cityName];
                const lvl = cityLevels[team][cityName] || 0;
                
                btn.classList.remove('ready');
                if((lvl === 0 && score >= 10) || (lvl === 1 && score >= 20)) {
                    btn.classList.add('ready');
                }
                const statusTxt = lvl === 0 ? "ê³µí„°" : (lvl === 1 ? "ë§ˆì„" : "ë„ì‹œ");
                btn.innerText = `${cityName.split(' ')[0]} (${statusTxt})`;
            });
        }
    }

    function findCat(w) { for(let cat in cityMap) if(cityMap[cat].includes(w)) return cat; return null; }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const team = document.getElementById(`mon-${id}`).classList.contains('team-red') ? 'red' : 'blue';
            if(findCat(val)) db.child('cards').child(val).set({ team: team });
            e.target.value = "";
        }
    }

    function startTimer() {
        let time = 1200;
        const intr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            if(time <= 0) { clearInterval(intr); endRound(); }
        }, 100);
    }

    function endRound() {
        active = false;
        document.getElementById('result-screen').style.display = 'flex';
        renderFinalCharts();
    }

    function renderFinalCharts() {
        ['red', 'blue'].forEach(team => {
            const cities = Object.keys(cityMap);
            const levels = cities.map(c => cityLevels[team][c] || 0);
            const totalLevel = levels.reduce((a, b) => a + b, 0);
            
            let rank = "ë¯¸ê°œë°œêµ­";
            if(totalLevel >= 10) rank = "ì„ ì§„êµ­ (ğŸ†)";
            else if(totalLevel >= 5) rank = "ê°œë°œë„ìƒêµ­";
            
            document.getElementById(`rank-${team}`).innerText = rank;
            document.getElementById(`tip-${team}`).innerHTML = `<strong>ğŸ’¡ ì˜¤ë¼í´ ë¶„ì„:</strong><br>
                í˜„ì¬ ê±´ì„¤ ì ìˆ˜: ${totalLevel}ì <br>
                ${rank === "ì„ ì§„êµ­ (ğŸ†)" ? "ì™„ë²½í•œ êµ­ê°€ì…ë‹ˆë‹¤!" : "ë‹¨ì–´ë¥¼ ëª¨ì•„ [UPGRADE] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë“±ê¸‰ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤!"}`;

            const ctx = document.getElementById(`final-chart-${team}`);
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: cities.map(c => `${c} (Lv.${cityLevels[team][c] || 0})`),
                    datasets: [{
                        data: levels,
                        backgroundColor: (team==='red'?'rgba(214, 48, 49, 0.4)':'rgba(9, 132, 227, 0.4)'),
                        borderColor: (team==='red'?'#D63031':'#0984E3'),
                        borderWidth: 5
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 2, ticks: { stepSize: 1, display: false }, pointLabels: { color: '#fff' } } },
                    plugins: { legend: { display: false } }
                }
            });
        });
    }

    function closeResult() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'flex';
    }
</script>
</body>
</html>
