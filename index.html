<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER v20.8 - Layout Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark: #050505; --red: #ff1a1a; --blue: #1a75ff; --yellow: #ffea00; --neon: #00ff41; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo'; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* 상단 바 고정 */
        #top-bar { height: 100px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 3px solid #333; z-index: 10000; position: relative; }
        #timer-disp { font-size: 3rem; color: var(--yellow); min-width: 140px; }

        .territory-status { display: flex; gap: 15px; flex: 1; justify-content: center; }
        .icon-box { background: #111; padding: 8px; border: 1px solid #333; text-align: center; min-width: 80px; border-radius: 5px; }

        /* 게임 영역 */
        #room-view { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; padding: 5px; background: #111; position: relative; }
        
        .monitor { border: 3px solid #333; display: flex; flex-direction: column; background: #000; overflow: hidden; position: relative; }
        
        /* [중요] 확대 시 스타일: 나머지 모니터를 덮어버림 */
        .monitor.focused {
            position: absolute !important;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9000;
            border: 5px solid var(--yellow);
        }

        /* 확대되지 않은 모니터 숨기기 전용 클래스 */
        .monitor.hidden { display: none !important; }

        .gate { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9500; }
        
        .board { flex: 1; display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; padding: 5px; align-content: start; overflow-y: auto; }
        .card { background: rgba(255,255,255,0.05); font-size: 0.7rem; height: 35px; display: flex; align-items: center; justify-content: center; border: 1px solid #222; }
        .card.owned-red { background: var(--red) !important; color: #fff; border: none; }
        .card.owned-blue { background: var(--blue) !important; color: #fff; border: none; }

        .input-wrap { height: 80px; background: #000; border-top: 2px solid #333; display: flex; }
        .input-box { flex: 1; background: transparent; border: none; font-size: 3rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        #surveillance-layer { position: fixed; inset: 0; border: 30px solid var(--red); background: rgba(255,0,0,0.1); display: none; z-index: 11000; pointer-events: none; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="surveillance-layer"></div>
<div id="top-bar">
    <div id="timer-disp">02:00</div>
    <div class="territory-status" id="global-stats"></div>
</div>

<div id="room-view">
    <script>
        // 4개의 모니터 동적 생성
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="gate" id="gate-${i}"><button onclick="requestStart(event)" style="padding:20px; font-family:'DungGeunMo'; cursor:pointer;">START OPERATION</button></div>
                    <div id="board-${i}" class="board"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v20_8');
    let myId = 0, active = false, focusedId = null;

    // [수정] 화면 확대 로직: 선택된 모니터 외에는 hidden 클래스 부여
    function zoomIn(id) {
        focusedId = id;
        myId = id;
        const monitors = document.querySelectorAll('.monitor');
        monitors.forEach(m => {
            m.classList.remove('focused', 'hidden');
            if (parseInt(m.id.split('-')[1]) !== id) {
                m.classList.add('hidden'); // 선택되지 않은 모니터는 숨김
            } else {
                m.classList.add('focused'); // 선택된 모니터는 전체화면
            }
        });
        
        // 게이트(시작버튼) 관리
        if(!active) {
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.getElementById(`gate-${id}`).style.display = 'flex';
        }
        document.getElementById(`in-${id}`).focus();
    }

    function requestStart(e) {
        e.stopPropagation();
        const words = ['석유','가스','원자력','태양광','철강','엔진','AI','로봇','은행','주식','코딩','보안','영화','음악','예술','데이터','서버','위성','환율','금리']; // 예시 단어들
        db.update({ state: 'RUNNING', words: words, cards: {}, watching: false });
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'RUNNING' && !active) {
            active = true;
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.querySelectorAll('.input-box').forEach(inp => inp.disabled = false);
        }
        render(d);
    });

    function render(data) {
        document.getElementById('surveillance-layer').style.display = data.watching ? 'block' : 'none';
        
        for(let i=1; i<=4; i++) {
            const board = document.getElementById(`board-${i}`);
            if(data.words && board.innerHTML === "") {
                board.innerHTML = data.words.map(w => `<div class="card" id="card-${i}-${w}">${w}</div>`).join('');
            }
            if(data.cards) {
                Object.keys(data.cards).forEach(w => {
                    const cardEl = document.getElementById(`card-${i}-${w}`);
                    if(cardEl) cardEl.className = `card owned-${data.cards[w]}`;
                });
            }
            // 팀 색상 반영
            if(data.teams) {
                const mon = document.getElementById(`mon-${i}`);
                mon.style.borderColor = data.teams[i] === 'red' ? 'var(--red)' : 'var(--blue)';
            }
        }
    }

    function handleInput(e, id) {
        if(e.key !== 'Enter') return;
        const val = e.target.value.trim();
        db.child('teams').child(id).once('value', tSnap => {
            const team = tSnap.val();
            db.child('words').once('value', wSnap => {
                if(wSnap.val().includes(val)) {
                    db.child('cards').child(val).set(team);
                }
            });
        });
        e.target.value = "";
    }
</script>
</body>
</html>
