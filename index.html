<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER v20.0 - Ultimate Control</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark: #050505; --red: #ff1a1a; --blue: #1a75ff; --yellow: #ffea00; --neon: #00ff41; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        #top-bar { height: 100px; background: #000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid #333; }
        #timer-disp { font-size: 3rem; color: var(--yellow); min-width: 140px; text-shadow: 0 0 15px var(--yellow); }
        
        .territory-status { display: flex; gap: 15px; flex: 1; justify-content: center; }
        .icon-box { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 85px; padding: 5px; border: 1px solid #222; background: #0a0a0a; }
        .icon-box i { font-size: 1.4rem; }
        .rank-tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; margin-top: 5px; font-weight: bold; border: 1px solid #444; }
        .tag-red { background: var(--red); color: #fff; }
        .tag-blue { background: var(--blue); color: #fff; }

        #shuffle-container { height: 8px; background: #111; width: 100%; position: relative; }
        #shuffle-bar { height: 100%; background: var(--yellow); width: 100%; transition: width 0.1s linear; box-shadow: 0 0 10px var(--yellow); }

        #room-view { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 10px; background: #111; }
        .monitor { border: 5px solid #333; position: relative; display: flex; flex-direction: column; background: #000; transition: all 0.4s; overflow: hidden; }
        .monitor.team-red { border-color: var(--red); background: linear-gradient(180deg, #300 0%, #000 100%); }
        .monitor.team-blue { border-color: var(--blue); background: linear-gradient(180deg, #001a4d 0%, #000 100%); }
        .monitor.focused { position: fixed !important; inset: 115px 10px 10px 10px; z-index: 5000; border-width: 8px; }

        #bonus-alert { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: var(--yellow); color: #000; padding: 10px 30px; border-radius: 20px; font-weight: bold; z-index: 7000; display: none; border: 4px solid #fff; box-shadow: 0 0 30px var(--yellow); animation: blink 0.5s infinite; }

        .radar-box { position: absolute; top: 50px; right: 10px; background: rgba(0,255,65,0.1); border: 1px solid var(--neon); color: var(--neon); padding: 5px 10px; font-size: 0.8rem; z-index: 5500; pointer-events: none; display: none; }
        .monitor.focused .radar-box { display: block; }

        .gate { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 8000; display: none; align-items: center; justify-content: center; }
        .start-btn { padding: 25px 60px; font-size: 2.5rem; background: var(--yellow); border: none; cursor: pointer; font-family: 'DungGeunMo'; border-radius: 10px; }

        .missile-panel { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: #fff; padding: 20px; border: 5px solid var(--red); display: none; flex-direction: column; align-items: center; z-index: 6000; border-radius: 10px; color: #000; box-shadow: 0 0 50px var(--red); }

        .board { flex: 1; display: grid; grid-template-columns: repeat(14, 1fr); gap: 4px; padding: 10px; overflow-y: auto; }
        .card { background: rgba(255,255,255,0.05); font-size: 0.75rem; display: flex; align-items: center; justify-content: center; border: 1px solid #222; color: #444; height: 35px; border-radius: 4px; }
        .card.owned-red { background: var(--red) !important; color: white; border: none; box-shadow: 0 0 10px var(--red); }
        .card.owned-blue { background: var(--blue) !important; color: white; border: none; box-shadow: 0 0 10px var(--blue); }

        .input-wrap { height: 80px; display: flex; border-top: 3px solid #333; background: #000; }
        .input-box { flex: 1; background: transparent; border: none; font-size: 3rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        #result-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="timer-disp">02:00</div>
    <div class="territory-status">
        <div class="icon-box"><i class="fas fa-bolt" style="color:var(--yellow)"></i><span>ë°œì „</span><div id="stat-0" class="rank-tag">-</div></div>
        <div class="icon-box"><i class="fas fa-industry" style="color:#aaa"></i><span>ê°•ì² </span><div id="stat-1" class="rank-tag">-</div></div>
        <div class="icon-box"><i class="fas fa-coins" style="color:#ffd700"></i><span>ìë³¸</span><div id="stat-2" class="rank-tag">-</div></div>
        <div class="icon-box"><i class="fas fa-microchip" style="color:#00ff00"></i><span>ë¯¸ë˜</span><div id="stat-3" class="rank-tag">-</div></div>
        <div class="icon-box"><i class="fas fa-book" style="color:#00e5ff"></i><span>ì§€í˜œ</span><div id="stat-4" class="rank-tag">-</div></div>
    </div>
</div>

<div id="shuffle-container"><div id="shuffle-bar"></div></div>
<div id="bonus-alert">âš ï¸ ê¸´ê¸‰ ë³´ë„ˆìŠ¤ ì„ë¬´: <span id="bonus-word"></span> âš ï¸</div>

<div id="room-view">
    <script>
        const cityNames = ['ë°œì „','ê°•ì² ','ìë³¸','ë¯¸ë˜','ì§€í˜œ'];
        const rankLabels = ['ê³µí„°','ë§ˆì„','ë„ì‹œ','ê°œë„êµ­','ì„ ì§„êµ­'];
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="gate" id="gate-${i}"><button class="start-btn" onclick="requestStart(event)">START MISSION</button></div>
                    <div class="radar-box" id="radar-${i}">ğŸ›°ï¸ ì êµ­ ë™í–¥: ê°ì‹œ ì¤‘...</div>
                    <div class="missile-panel" id="mis-panel-${i}">
                        <b style="color:red; font-size:1.2rem;">ğŸš€ íŒ¨ê¶Œ ë¬´ê¸° ìŠ¹ì¸</b>
                        <div style="margin:10px 0;">ê°•ë ¥í•œ êµ­ë ¥ì„ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤. ì ì˜ ì˜í† ë¥¼ íŒŒê´´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                        <button onclick="launchMissile(event, ${i})" style="padding:15px 30px; background:red; color:white; border:none; font-family:'DungGeunMo'; cursor:pointer; font-weight:bold;">ë¯¸ì‚¬ì¼ ë°œì‚¬ (ì¹´ë“œ 7ì¥)</button>
                        <button onclick="closeSabotage(event, ${i})" style="margin-top:5px; background:none; border:none; color:#777; cursor:pointer;">ë°œì‚¬ ì·¨ì†Œ</button>
                    </div>
                    <div style="display:flex; justify-content:space-around; background:rgba(0,0,0,0.7); padding:8px; border-bottom:1px solid #333;">
                        ${cityNames.map((c, idx) => `<span id="lvl-${i}-${idx}" style="font-size:0.75rem; color:var(--yellow);">${c}:-</span>`).join('')}
                    </div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="CONNECTED" disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<div id="result-screen">
    <h1 style="color:var(--yellow); font-size:3.5rem;">FINAL TERRITORY MAP</h1>
    <div style="width:500px; height:500px;"><canvas id="radarChart"></canvas></div>
    <button onclick="closeResult()" style="margin-top:30px; padding:15px 60px; background:var(--yellow); font-family:'DungGeunMo'; font-size:1.5rem; border:none; cursor:pointer;">ì´ì–´ì„œ í•˜ê¸°</button>
</div>

<script>
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v20');
    
    // [ìˆ˜ì •] ì‚¬ìš©ëœ ë‹¨ì–´ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ Set (ì„¸ì…˜ ë™ì•ˆ ìœ ì§€)
    let usedWordsGlobal = new Set();

    const wordPool = {
        'ë°œì „': ['ì„íƒ„','íƒœì–‘ê´‘','ì›ìë ¥','ì„ìœ ','ì „ê¸°','í’ë ¥','ìˆ˜ë ¥','ê°€ìŠ¤','ë°°í„°ë¦¬','íƒ„ì†Œ'],
        'ê°•ì² ': ['ì² ê°•','ì—”ì§„','ë°˜ë„ì²´','ë¡œë´‡','ìë™ì°¨','ì„ ë°•','ê¸°ê³„','í•©ê¸ˆ','ê¸ˆì†','ìš©ì ‘'],
        'ìë³¸': ['ì€í–‰','ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','í™˜ìœ¨','ê¸ˆë¦¬','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','ì„¸ê¸ˆ'],
        'ë¯¸ë˜': ['AI','ì„œë²„','ë³´ì•ˆ','ì½”ë”©','ì–‘ì','í´ë¼ìš°ë“œ','ì„¼ì„œ','í•´í‚¹','ë“œë¡ ','ìœ„ì„±'],
        'ì§€í˜œ': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì—°êµ¬','ë°±ì‹ ','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ']
    };

    let active = false, pCards = {}, currentWords = [], timerIntr = null, bonusWord = "";
    let cityLevels = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
    let currentTeams = { 1:'red', 2:'red', 3:'blue', 4:'blue' };
    let focusedId = null, radarChart = null;

    // ì´ˆê¸°í™” ë¡œì§ (ì²« ì ‘ì† ì‹œì—ë§Œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •)
    window.onload = () => { 
        db.once('value', snap => {
            if(!snap.val()) {
                db.set({ state: 'READY', cards: {}, words: [], teams: { 1:'red', 2:'red', 3:'blue', 4:'blue' }, bonus: "" });
            }
        });
    };

    function zoomIn(id) {
        focusedId = id;
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        if(!active) {
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.getElementById(`gate-${id}`).style.display = 'flex';
        }
    }

    // [ìˆ˜ì •] ìƒˆë¡œìš´ ë¼ìš´ë“œ ì‹œì‘ ì‹œ ì¤‘ë³µ ë‹¨ì–´ ì œì™¸ ë¡œì§
    function requestStart(e) {
        e.stopPropagation();
        const nextWords = [];
        
        Object.keys(wordPool).forEach(cat => {
            // ì•„ì§ ì•ˆ ì“´ ë‹¨ì–´ë§Œ ì¶”ì¶œ
            let available = wordPool[cat].filter(w => !usedWordsGlobal.has(w));
            
            // ë§Œì•½ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ë‹¨ì–´ë¥¼ ë‹¤ ì¼ë‹¤ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë§Œ ë¦¬ì…‹
            if(available.length === 0) {
                wordPool[cat].forEach(w => usedWordsGlobal.delete(w));
                available = wordPool[cat];
            }
            
            // ëœë¤ìœ¼ë¡œ ë‹¨ì–´ ì„ê¸° (ê¸°ì¡´ 10ê°œ ìœ ì§€í•˜ë˜ ì¤‘ë³µ í”¼í•¨)
            available.forEach(w => {
                nextWords.push(w);
                usedWordsGlobal.add(w);
            });
        });

        // ë°œì „ ë‹¨ê³„(cityLevels)ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³  ê²Œì„ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
        db.update({ state: 'RUNNING', words: nextWords, cards: {}, startTime: Date.now() });
    }

    // [ìˆ˜ì •] ê²°ê³¼ì°½ ë‹«ê¸° ì‹œ ë°œì „ ë‹¨ê³„ ìœ ì§€
    function closeResult() {
        document.getElementById('result-screen').style.display = 'none';
        // cityLevels ì´ˆê¸°í™” ì½”ë“œ ì‚­ì œ (ë°ì´í„° ìœ ì§€)
        db.update({ state: 'READY', cards: {}, bonus: "" });
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        pCards = d.cards || {};
        if(d.words && d.words.length > 0) {
            if(JSON.stringify(currentWords) !== JSON.stringify(d.words)) {
                currentWords = d.words;
                syncBoard(d.words);
            }
        }
        if(d.teams) currentTeams = d.teams;
        bonusWord = d.bonus || "";
        
        if(d.state === 'RUNNING' && !active) {
            active = true;
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.querySelectorAll('.input-box').forEach(inp => inp.disabled = false);
            startTimer();
        } else if(d.state === 'FINISHED' && active) {
            active = false;
            showResult();
        }
        updateUI();
    });

    function syncBoard(words) {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            words.forEach(w => {
                const div = document.createElement('div');
                div.className = 'card'; div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function handleInput(e, id) {
        if(e.key !== 'Enter') return;
        const val = e.target.value.trim();
        const team = currentTeams[id];
        if(val === bonusWord && bonusWord !== "") {
            const category = Object.keys(wordPool)[Math.floor(Math.random()*5)];
            const rewardWords = wordPool[category].slice(0, 5);
            rewardWords.forEach(w => db.child('cards').child(w).set(team));
            db.update({ bonus: "" });
        } else if(currentWords.includes(val)) {
            db.child('cards').child(val).set(team);
        }
        e.target.value = "";
    }

    function updateUI() {
        const counts = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
        Object.keys(pCards).forEach(w => {
            const t = pCards[w];
            let cIdx = -1;
            Object.keys(wordPool).forEach((cat, idx) => { if(wordPool[cat].includes(w)) cIdx = idx; });
            if(cIdx !== -1) counts[t][cIdx]++;
            for(let i=1; i<=4; i++) {
                const c = document.getElementById(`card-${i}-${w}`);
                if(c) c.className = `card owned-${t}`;
            }
        });

        ['red','blue'].forEach(t => {
            counts[t].forEach((cnt, idx) => { 
                // ëˆ„ì  ë°œì „ì„ ìœ„í•´ ê¸°ì¡´ ë ˆë²¨ê³¼ í˜„ì¬ íšë“ëŸ‰ì„ í•©ì‚°í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹Œ, 
                // "í˜„ì¬ ë¼ìš´ë“œ ì ë ¹ ìˆ˜"ì— ë”°ë¼ ë ˆë²¨ì´ ê²°ì •ë˜ë¯€ë¡œ, 
                // ë“±ê¸‰ ìœ ì§€ë¥¼ ìœ„í•´ cityLevelsë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì„ ë³´ì¡´
                let currentRoundLvl = Math.min(4, Math.floor(cnt/5));
                if(currentRoundLvl > cityLevels[t][idx]) cityLevels[t][idx] = currentRoundLvl;

                const statTag = document.getElementById(`stat-${idx}`);
                statTag.innerText = rankLabels[cityLevels[t][idx]];
                statTag.className = `rank-tag tag-${t}`;
            });
        });

        for(let i=1; i<=4; i++) {
            const team = currentTeams[i];
            const enemy = team === 'red' ? 'blue' : 'red';
            const mon = document.getElementById(`mon-${i}`);
            mon.className = `monitor team-${team} ${i===focusedId?'focused':''}`;
            
            cityNames.forEach((_, idx) => {
                const lvlElement = document.getElementById(`lvl-${i}-${idx}`);
                if(lvlElement) lvlElement.innerText = `${cityNames[idx]}:${rankLabels[cityLevels[team][idx]]}`;
            });

            const radar = document.getElementById(`radar-${i}`);
            let enemyBest = Math.max(...cityLevels[enemy]);
            if(radar) radar.innerText = `ğŸ›°ï¸ ì êµ­ ìµœê³  ì „ë ¥: [${rankLabels[enemyBest]}] ê°ì§€`;

            const panel = document.getElementById(`mis-panel-${i}`);
            let myPowerIdx = cityLevels[team].findIndex(l => l >= 3);
            let enemyTargetIdx = cityLevels[enemy].findIndex(l => l >= 1);
            if(i === focusedId && myPowerIdx !== -1 && enemyTargetIdx !== -1 && active) {
                panel.style.display = 'flex';
                mon.dataset.targetEnemyIdx = enemyTargetIdx;
            } else {
                panel.style.display = 'none';
            }
        }

        const bonusUI = document.getElementById('bonus-alert');
        if(bonusWord) {
            bonusUI.style.display = 'block';
            document.getElementById('bonus-word').innerText = bonusWord;
        } else {
            bonusUI.style.display = 'none';
        }
    }

    function launchMissile(e, id) {
        e.stopPropagation();
        const team = currentTeams[id];
        const myCards = Object.keys(pCards).filter(k => pCards[k] === team);
        if(myCards.length < 7) return alert("ìì› ë¶€ì¡±!");
        const targetIdx = document.getElementById(`mon-${id}`).dataset.targetEnemyIdx;
        const enemyTeam = team === 'red' ? 'blue' : 'red';
        const targetWords = wordPool[cityNames[targetIdx]];
        myCards.slice(0, 7).forEach(k => db.child('cards').child(k).remove());
        Object.keys(pCards).forEach(w => { if(pCards[w] === enemyTeam && targetWords.includes(w)) db.child('cards').child(w).remove(); });
        alert("ë¯¸ì‚¬ì¼ ë°œì‚¬!");
    }

    function closeSabotage(e, id) { e.stopPropagation(); document.getElementById(`mis-panel-${id}`).style.display = 'none'; }

    function startTimer() {
        let time = 120, shuffle = 10, bonusTick = 0;
        if(timerIntr) clearInterval(timerIntr);
        timerIntr = setInterval(() => {
            time--; shuffle--; bonusTick++;
            document.getElementById('timer-disp').innerText = Math.floor(time/60) + ":" + (time%60).toString().padStart(2,'0');
            document.getElementById('shuffle-bar').style.width = (shuffle/10)*100 + "%";

            if(shuffle <= 0) {
                shuffle = 10;
                const ts = ['red','red','blue','blue'].sort(() => Math.random()-0.5);
                db.update({ teams: { 1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3] } });
            }
            if(bonusTick >= 30) {
                bonusTick = 0;
                const cats = Object.keys(wordPool);
                const randWord = wordPool[cats[Math.floor(Math.random()*5)]][Math.floor(Math.random()*10)];
                db.update({ bonus: randWord });
            }

            if(time <= 0) { clearInterval(timerIntr); db.update({ state: 'FINISHED' }); }
        }, 1000);
    }

    function showResult() {
        document.getElementById('result-screen').style.display = 'flex';
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: cityNames,
                datasets: [
                    { label: 'RED', data: cityLevels.red, backgroundColor: 'rgba(255, 0, 0, 0.6)', borderColor: 'red', fill: true },
                    { label: 'BLUE', data: cityLevels.blue, backgroundColor: 'rgba(0, 102, 255, 0.6)', borderColor: 'blue', fill: true }
                ]
            },
            options: { 
                scales: { r: { min: 0, max: 4, ticks: { display: false }, grid: { color: '#333' }, pointLabels: { color: '#ffea00', font: { size: 18 } } } },
                plugins: { legend: { labels: { color: '#fff' } } }
            }
        });
    }
</script>
</body>
</html>
