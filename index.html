<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER: LAND GRAB</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #2e86de; --yellow: #f1c40f; --dark: #0a0a0f; --neon: #00ffdd; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo'; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151a; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 2.5rem; color: var(--yellow); }
        .score-board { font-size: 1.8rem; display: flex; gap: 40px; align-items: center; }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 130px 20px 20px 20px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 4px solid #333; background: #000; display: flex; flex-direction: column; position: relative; border-radius: 10px; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 120px 20px 20px 20px; z-index: 5000; border-color: var(--neon); }

        /* 4x4 그리드 보드 */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 8px; flex: 1; padding: 15px; background: #050505; }
        .tile { border: 1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; position: relative; background: #111; color: #444; border-radius: 5px; }
        
        /* 실시간 점유 색상 */
        .tile.red { background: var(--red); color: #fff; border: none; box-shadow: 0 0 10px var(--red); }
        .tile.blue { background: var(--blue); color: #fff; border: none; box-shadow: 0 0 10px var(--blue); }
        
        /* 영구 소유(구매 완료) 색상 */
        .tile.perm-red { background: var(--red) !important; color: #fff !important; border: 4px solid #fff !important; }
        .tile.perm-blue { background: var(--blue) !important; color: #fff !important; border: 4px solid #fff !important; }
        .tile.perm-red::before, .tile.perm-blue::before { content: 'OWNED'; position: absolute; top: 2px; font-size: 0.6rem; opacity: 0.8; }

        .input-wrap { display: flex; height: 90px; border-top: 4px solid var(--yellow); }
        .input-box { flex: 1; background: #000; color: var(--neon); border: none; font-size: 3.5rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .gate-btn { padding: 20px 50px; font-family: 'DungGeunMo'; font-size: 2rem; background: var(--yellow); border: none; cursor: pointer; border-radius: 10px; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 4rem; margin-bottom: 10px;">LAND GRAB</h1>
    <p style="font-size: 1.5rem; color: #aaa;">16칸 중 9칸을 먼저 차지하여 영토를 구매하세요.</p>
    <button class="gate-btn" onclick="startNewRound()">전쟁 개시</button>
</div>

<div id="top-bar">
    <div class="score-board">
        <span style="color:var(--red)">RED <span id="p-red">0</span></span>
        <span id="round-title" style="color:var(--yellow); font-size: 1.2rem; border: 1px solid var(--yellow); padding: 5px 15px;">ROUND 1 / 16</span>
        <span style="color:var(--blue)">BLUE <span id="p-blue">0</span></span>
    </div>
    <div id="timer-disp">SHUFFLE: 10s</div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div id="board-${i}" class="board"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="접속 대기" disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    // Firebase 연결 (본인의 URL로 교체하세요)
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('land_grab_v1');

    const wordList = ['강철','엔진','보안','네트','코드','데이터','위성','로봇','미래','자본','투자','은행','지혜','연구','에너지','전기'];
    let myId = 0, currentTeams = {1:'red', 2:'red', 3:'blue', 4:'blue'};
    let gameState = {};

    function startNewRound() {
        const resetRoundTiles = {};
        wordList.forEach(w => resetRoundTiles[w] = "none");
        db.update({ 
            status: 'PLAYING',
            roundTiles: resetRoundTiles,
            winnerFound: false
        });
        document.getElementById('lobby-screen').style.display = 'none';
    }

    function zoomIn(id) {
        myId = id;
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`in-${id}`).disabled = false;
        document.getElementById(`in-${id}`).focus();
    }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(wordList.includes(val)) {
                // 영구 소유된 땅은 뒤집을 수 없음
                if(!gameState.permOwned || !gameState.permOwned[val]) {
                    db.child('roundTiles').child(val).set(currentTeams[id]);
                }
            }
            e.target.value = "";
        }
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        gameState = d;
        if(d.teams) currentTeams = d.teams;
        render(d);
        checkWinner(d);
    });

    function render(d) {
        // 상단 스코어 (영구 땅 개수)
        const redPerms = Object.values(d.permOwned || {}).filter(v => v === 'red').length;
        const bluePerms = Object.values(d.permOwned || {}).filter(v => v === 'blue').length;
        document.getElementById('p-red').innerText = redPerms;
        document.getElementById('p-blue').innerText = bluePerms;
        document.getElementById('round-title').innerText = `ROUND ${d.roundNum || 1} / 16`;

        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            wordList.forEach(w => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerText = w;

                // 영구 땅 우선 표시
                if(d.permOwned && d.permOwned[w]) {
                    tile.classList.add(`perm-${d.permOwned[w]}`);
                } 
                // 이번 라운드 실시간 점유 표시
                else if(d.roundTiles && d.roundTiles[w] !== "none") {
                    tile.classList.add(d.roundTiles[w]);
                }
                b.appendChild(tile);
            });
        }
    }

    function checkWinner(d) {
        if(d.winnerFound || d.status !== 'PLAYING') return;

        const tiles = d.roundTiles || {};
        const redCount = Object.values(tiles).filter(v => v === 'red').length;
        const blueCount = Object.values(tiles).filter(v => v === 'blue').length;

        // 9칸 선점 시 승리
        if(redCount >= 9 || blueCount >= 9) {
            const winner = redCount >= 9 ? 'red' : 'blue';
            if(myId === 1) finalizeRound(winner, d);
        }
    }

    function finalizeRound(winner, d) {
        db.child('winnerFound').set(true);
        
        // 아직 주인이 없는 땅 중 하나를 골라 구매
        const available = wordList.filter(w => !d.permOwned || !d.permOwned[w]);
        const purchasedLand = available[0]; 

        alert(`${winner.toUpperCase()} 팀이 이번 라운드를 지배하여 [${purchasedLand}]을(를) 영구 점유합니다!`);

        setTimeout(() => {
            const nextRound = (d.roundNum || 1) + 1;
            const updates = {};
            updates[`permOwned/${purchasedLand}`] = winner; // 승점 1점으로 땅 구매 반영
            updates[`roundNum`] = nextRound;
            updates[`status`] = 'WAITING';
            
            if(nextRound > 16) {
                alert("전쟁 종료! 영구 영토가 더 많은 팀이 최종 승리입니다.");
                updates[`roundNum`] = 1;
                updates[`permOwned`] = {};
            }
            db.update(updates);
            document.getElementById('lobby-screen').style.display = 'flex';
        }, 2000);
    }

    // 10초 셔플 로직
    let shuffleTime = 10;
    setInterval(() => {
        if(gameState.status === 'PLAYING') {
            shuffleTime--;
            document.getElementById('timer-disp').innerText = `SHUFFLE: ${shuffleTime}s`;
            if(shuffleTime <= 0) {
                if(myId === 1) {
                    const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                    db.update({ teams: { 1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3] } });
                }
                shuffleTime = 10;
            }
        }
    }, 1000);
</script>
</body>
</html>
