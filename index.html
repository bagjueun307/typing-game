<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì™€ê¸€ì™€ê¸€ íƒ€ìì™• ë°°í‹€! V36</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #1e90ff; --yellow: #ffa502; }
        body { background: #5758bb; color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; transition: background 0.5s ease; }
        
        body.turn-red { background: #ff7675; }
        body.turn-blue { background: #74b9ff; }

        #lobby { position: fixed; inset: 0; background: #5758bb; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { padding: 20px 60px; font-size: 2.5rem; background: var(--yellow); border: 8px outset #eccc68; cursor: pointer; border-radius: 20px; color: #2f3542; font-family: 'DungGeunMo'; }
        
        /* ì „ì²´ ì‹œê°„ ë§‰ëŒ€ (ìµœìƒë‹¨) */
        #main-timer-container { position: fixed; top: 60px; left: 0; right: 0; height: 10px; background: rgba(0,0,0,0.2); z-index: 850; }
        #main-timer-bar { width: 100%; height: 100%; background: #2ed573; transition: width 0.1s linear; }

        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: #fff; border-bottom: 5px solid #2f3542; display: flex; justify-content: space-around; align-items: center; z-index: 900; color: #2f3542; }
        #timer-disp { font-size: 2.2rem; color: #ff4757; font-weight: bold; background: #2f3542; padding: 0 15px; border-radius: 10px; min-width: 120px; text-align: center; }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 20px; padding: 90px 20px 20px; box-sizing: border-box; }
        .monitor { border: 10px solid #2f3542; background: #fff; border-radius: 20px; display: flex; flex-direction: column; position: relative; transition: 0.3s; box-shadow: 10px 10px 0 rgba(0,0,0,0.3); overflow: hidden; }
        
        /* í„´ ì‹œê°„ ë§‰ëŒ€ (ëª¨ë‹ˆí„° ë‚´ë¶€) */
        .turn-gauge-bg { width: 100%; height: 12px; background: #dfe4ea; border-bottom: 2px solid #2f3542; }
        .turn-gauge-fill { width: 100%; height: 100%; background: var(--yellow); transition: width 0.1s linear; }

        .teacher-box { font-size: 2.5rem; text-align: center; padding: 5px; border-bottom: 2px solid #eee; }
        .watching { background: #ff4757 !important; animation: shake 0.2s infinite; }

        /* 3D ì¹´ë“œ ë””ìì¸ */
        .board { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; flex: 1; padding: 15px; background: rgba(0,0,0,0.05); perspective: 1500px; }
        .card-container { height: 45px; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .card-container.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; border: 3px solid #2f3542; box-sizing: border-box; }
        .card-front { background: #fff; color: #2f3542; box-shadow: 0 4px 0 #ced6e0; }
        .card-back { transform: rotateY(180deg); color: #fff; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .back-red { background: var(--red); }
        .back-blue { background: var(--blue); }

        .input-box { width: 100%; padding: 15px; font-family: 'DungGeunMo'; font-size: 1.8rem; border: none; border-top: 5px solid #2f3542; text-align: center; outline: none; }
        .not-my-turn { background: #f1f2f6; color: #ccc; }

        #bonus-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: var(--yellow); border: 10px solid #2f3542; padding: 40px; z-index: 2000; border-radius: 40px; text-align: center; pointer-events: none; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #bonus-popup.active { transform: translate(-50%, -50%) scale(1); }
        .bonus-word { font-size: 4rem; color: #2f3542; margin: 20px 0; display: block; background: #fff; padding: 10px; border-radius: 20px; box-shadow: 0 8px 0 rgba(0,0,0,0.1); }

        .focused { position: fixed !important; inset: 5vh 5vw; width: 90vw !important; height: 90vh !important; z-index: 500; }
        .blurred { filter: blur(5px); opacity: 0.5; pointer-events: none; }
        @keyframes shake { 0% { transform: rotate(-1deg); } 100% { transform: rotate(1deg); } }
    </style>
</head>
<body id="game-body">

<div id="lobby">
    <h1 style="font-size: 3.5rem; text-shadow: 4px 4px 0 #2f3542;">ğŸ« ëŒ€ê¸°ì‹¤: ëª¨ë‘ ì¤€ë¹„ëë‚˜ìš”?</h1>
    <p style="font-size: 1.5rem;">ê²Œì„ ì‹œê°„: 2ë¶„ (ìƒëŒ€ ì¹´ë“œ ëºê¸° ê°€ëŠ¥!)</p>
    <button class="start-btn" onclick="triggerStart()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="top-bar">
    <div style="color:var(--red); font-size: 1.8rem; font-weight: bold;">RED: <span id="total-red">0</span></div>
    <div id="timer-disp">120.0s</div>
    <div style="color:var(--blue); font-size: 1.8rem; font-weight: bold;">BLUE: <span id="total-blue">0</span></div>
</div>

<div id="main-timer-container"><div id="main-timer-bar"></div></div>

<div id="bonus-popup">
    <h2 style="margin:0; color:#fff; text-shadow: 2px 2px 0 #2f3542;">ğŸ”¥ ë³´ë„ˆìŠ¤! 2ì¥ ê°•íƒˆ! ğŸ”¥</h2>
    <span class="bonus-word" id="bonus-word-txt"></span>
</div>

<div id="room-view">
    <div class="monitor" id="mon-1" onclick="focusMon(1)">
        <div class="turn-gauge-bg"><div id="gauge-1" class="turn-gauge-fill"></div></div>
        <div class="teacher-box" id="teacher-1">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-1"></div>
        <input type="text" id="input-1" class="input-box" placeholder="í´ë¦­í•˜ì—¬ ì‹œì‘" onkeydown="handleInput(event, 'red', 1)">
    </div>
    <div class="monitor" id="mon-2" onclick="focusMon(2)">
        <div class="turn-gauge-bg"><div id="gauge-2" class="turn-gauge-fill"></div></div>
        <div class="teacher-box" id="teacher-2">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-2"></div>
        <input type="text" id="input-2" class="input-box" placeholder="í´ë¦­í•˜ì—¬ ì‹œì‘" onkeydown="handleInput(event, 'blue', 2)">
    </div>
    <div class="monitor" id="mon-3" onclick="focusMon(3)">
        <div class="turn-gauge-bg"><div id="gauge-3" class="turn-gauge-fill"></div></div>
        <div class="teacher-box" id="teacher-3">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-3"></div>
        <input type="text" id="input-3" class="input-box" placeholder="í´ë¦­í•˜ì—¬ ì‹œì‘" onkeydown="handleInput(event, 'red', 3)">
    </div>
    <div class="monitor" id="mon-4" onclick="focusMon(4)">
        <div class="turn-gauge-bg"><div id="gauge-4" class="turn-gauge-fill"></div></div>
        <div class="teacher-box" id="teacher-4">ğŸ‘¨â€ğŸ«</div>
        <div class="board" id="board-4"></div>
        <input type="text" id="input-4" class="input-box" placeholder="í´ë¦­í•˜ì—¬ ì‹œì‘" onkeydown="handleInput(event, 'blue', 4)">
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_v36');

    const words = ["ë–¡ë³¶ì´", "ê¸‰ì‹", "ìš´ë™ì¥", "ë°©í•™", "ì•Œë¦¼ì¥", "ì§ê¿", "ì¤€ë¹„ë¬¼", "ì‹¤ë‚´í™”", "ë”±ì§€", "ìŠ¬ëŸ¬ì‹œ", "í”¼ì¹´ì¸„", "í•™ì›", "ìˆ™ì œ", "ì²´ìœ¡", "ì†Œí’", "ì‰¬ëŠ”ì‹œê°„", "ì§€ìš°ê°œ", "í•„í†µ", "ë¦¬ì½”ë”", "ë°˜ì¥", "ì¼ê¸°", "ë…ì„œ", "í”¼êµ¬", "íƒœê¶Œë„", "ë¬¸ë°©êµ¬", "êµì‹¤", "ë§¤ì ", "ì¹ íŒ", "ë¶„í•„", "ì •ë¬¸", "êµê°€", "í˜„ì¥í•™ìŠµ", "ê°œí•™", "êµì¥ì‹¤", "ê³¼í•™ì‹¤", "ìŒì•…ì‹¤", "ë³µë„", "ì‹¤ë‚´í™”ê°€ë°©", "ë°›ì•„ì“°ê¸°", "ë°©ê³¼í›„"];
    const bonusWords = ["ìŠˆí¼ì»´í“¨í„°", "ìš°ì£¼ìµœê°•", "ë¬´ì§€ê°œë°˜ì‚¬", "í™©ê¸ˆì˜¬ë¦¬ë¸Œ", "ìŠ¤íŒŒê²Œí‹°", "ì¹˜ì¦ˆë²„ê±°"];
    
    let isWatching = false, hasStarted = false, turn = 'red', activeBonus = "";
    const TOTAL_TIME = 1200; // 120ì´ˆ (0.1ì´ˆ ë‹¨ìœ„)

    for(let i=1; i<=4; i++) {
        const b = document.getElementById(`board-${i}`);
        words.forEach(w => {
            const container = document.createElement('div');
            container.className = 'card-container';
            container.id = `cont-${i}-${w}`;
            container.innerHTML = `<div class="card-front">${w}</div><div class="card-back" id="back-${i}-${w}">${w}</div>`;
            b.appendChild(container);
        });
    }

    db.on('value', (snap) => {
        const data = snap.val(); if(!data) return;
        if(data.state === 'START' && !hasStarted) {
            hasStarted = true;
            document.getElementById('lobby').style.display = 'none';
            gameLoop();
        }
        activeBonus = data.bonusWord || "";
        document.getElementById('bonus-popup').classList.toggle('active', !!activeBonus);
        if(activeBonus) document.getElementById('bonus-word-txt').innerText = activeBonus;

        words.forEach(w => {
            const owner = (data.cards && data.cards[w]) ? data.cards[w].team : null;
            for(let i=1; i<=4; i++) {
                const cont = document.getElementById(`cont-${i}-${w}`);
                const back = document.getElementById(`back-${i}-${w}`);
                if(owner) {
                    cont.classList.add('is-flipped');
                    back.className = 'card-back back-' + owner;
                } else { cont.classList.remove('is-flipped'); }
            }
        });
        document.getElementById('total-red').innerText = Object.values(data.cards || {}).filter(c=>c.team==='red').length;
        document.getElementById('total-blue').innerText = Object.values(data.cards || {}).filter(c=>c.team==='blue').length;
    });

    function triggerStart() { db.set({ state: 'START', cards: {}, bonusWord: "", t: Date.now() }); }

    function handleInput(e, team, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(isWatching) { applyPenalty(team, 1); e.target.value = ''; return; }
            if(activeBonus && val === activeBonus) {
                db.update({ bonusWord: "" });
                alert(team.toUpperCase() + " ë³´ë„ˆìŠ¤ ì„±ê³µ! ìƒëŒ€ ì¹´ë“œ 2ì¥ ê°•íƒˆ!");
                applyPenalty(team === 'red' ? 'blue' : 'red', 2);
            }
            if(team === turn) {
                db.child('cards').transaction((c) => {
                    if(!c) c = {};
                    if(words.includes(val) && !c[val]) c[val] = { team: team, t: Date.now() };
                    return c;
                });
            }
            e.target.value = '';
        }
    }

    function applyPenalty(team, count) {
        db.child('cards').once('value', (snap) => {
            const cards = snap.val(); if(!cards) return;
            let myCards = [];
            for(let k in cards) { if(cards[k].team === team) myCards.push({key: k, t: cards[k].t}); }
            myCards.sort((a, b) => b.t - a.t);
            for(let i=0; i < count && i < myCards.length; i++) { db.child('cards').child(myCards[i].key).remove(); }
        });
    }

    function gameLoop() {
        let timeLeft = TOTAL_TIME;
        const mainBar = document.getElementById('main-timer-bar');
        
        setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                document.getElementById('timer-disp').innerText = (timeLeft/10).toFixed(1) + "s";
                
                // ì „ì²´ ë©”ì¸ ë§‰ëŒ€ ì—…ë°ì´íŠ¸
                mainBar.style.width = (timeLeft / TOTAL_TIME * 100) + "%";

                // í„´ ë° ë°°ê²½ìƒ‰ ë¡œì§ (10ì´ˆ ì£¼ê¸°)
                const cyclePos = (TOTAL_TIME - timeLeft) % 100;
                turn = (Math.floor((TOTAL_TIME - timeLeft)/100) % 2 === 0) ? 'red' : 'blue';
                document.getElementById('game-body').className = (turn === 'red') ? 'turn-red' : 'turn-blue';
                
                // ëª¨ë‹ˆí„° í„´ ê²Œì´ì§€ ì—…ë°ì´íŠ¸
                for(let i=1; i<=4; i++) {
                    document.getElementById(`gauge-${i}`).style.width = (100 - cyclePos) + "%";
                    const inp = document.getElementById(`input-${i}`);
                    const myTeam = (i===1 || i===3) ? 'red' : 'blue';
                    inp.classList.toggle('not-my-turn', myTeam !== turn);
                }

                // ì„ ìƒë‹˜ ê°ì‹œ (ì£¼ê¸° ë‚´ì˜ ë§ˆì§€ë§‰ 2ì´ˆ)
                if(cyclePos > 80) {
                    isWatching = true;
                    for(let i=1; i<=4; i++) document.getElementById(`teacher-${i}`).classList.add('watching');
                } else {
                    isWatching = false;
                    for(let i=1; i<=4; i++) document.getElementById(`teacher-${i}`).classList.remove('watching');
                }

                // ë³´ë„ˆìŠ¤ ë¬¸ì œ (30ì´ˆë§ˆë‹¤)
                if(timeLeft % 300 === 0 && timeLeft !== TOTAL_TIME) {
                    db.update({ bonusWord: bonusWords[Math.floor(Math.random()*bonusWords.length)] });
                    setTimeout(() => db.update({ bonusWord: "" }), 5000);
                }
            } else {
                if(hasStarted) { alert("ê²Œì„ ì¢…ë£Œ!"); hasStarted = false; }
            }
        }, 100);
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.add('blurred'));
        const target = document.getElementById(`mon-${id}`);
        target.classList.remove('blurred'); target.classList.add('focused');
        document.getElementById(`input-${id}`).focus();
    }
    function unfocus() { document.querySelectorAll('.monitor').forEach(m => m.classList.remove('blurred', 'focused')); }
    window.addEventListener('keydown', (e) => { if(e.key === 'Escape') unfocus(); });
</script>
</body>
</html>
