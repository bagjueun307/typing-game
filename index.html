<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER v19.5 - Tactical Territory</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark: #050505; --red: #ff0000; --blue: #0066ff; --yellow: #ffea00; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* 상단 네비게이션 */
        #top-bar { height: 70px; background: #000; border-bottom: 3px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        #timer-disp { font-size: 2.8rem; color: var(--yellow); text-shadow: 0 0 10px var(--yellow); }

        /* 모니터 시스템 */
        #room-view { flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 10px; background: #111; }
        .monitor { border: 5px solid #444; position: relative; display: flex; flex-direction: column; background: #000; transition: all 0.3s; overflow: hidden; }
        
        /* 팀 컬러 가시성 (배경 전체) */
        .monitor.team-red { border-color: var(--red); background: linear-gradient(180deg, #300 0%, #000 100%); }
        .monitor.team-blue { border-color: var(--blue); background: linear-gradient(180deg, #001a4d 0%, #000 100%); }
        .monitor.focused { position: fixed !important; inset: 80px 10px 10px 10px; z-index: 5000; border-width: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }

        /* 미사일 패널 - 확대 모니터 전용 */
        .missile-panel {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.95); padding: 20px 40px; border: 4px solid white;
            display: none; flex-direction: column; align-items: center; z-index: 6000;
            box-shadow: 0 0 40px rgba(255,0,0,1); border-radius: 10px;
        }

        /* 시작 게이트 */
        .gate { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 8000; display: none; align-items: center; justify-content: center; }
        .start-btn { padding: 25px 60px; font-size: 2.5rem; background: var(--yellow); border: none; cursor: pointer; font-family: 'DungGeunMo'; border-radius: 10px; box-shadow: 0 5px 0 #b3a400; }

        /* 영토 보드 */
        .board { flex: 1; display: grid; grid-template-columns: repeat(14, 1fr); gap: 4px; padding: 10px; }
        .card { background: rgba(255,255,255,0.05); font-size: 0.8rem; display: flex; align-items: center; justify-content: center; border-radius: 3px; border: 1px solid #222; transition: 0.2s; color: #666; }
        .card.owned-red { background: var(--red) !important; color: #fff; border: none; box-shadow: 0 0 10px var(--red); }
        .card.owned-blue { background: var(--blue) !important; color: #fff; border: none; box-shadow: 0 0 10px var(--blue); }

        /* 입력창 */
        .input-wrap { height: 80px; display: flex; border-top: 3px solid #333; background: #000; }
        .input-box { flex: 1; background: transparent; border: none; font-size: 3rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }
        .team-red .input-box { color: #ffcccc; text-shadow: 0 0 10px var(--red); }
        .team-blue .input-box { color: #cce0ff; text-shadow: 0 0 10px var(--blue); }

        /* 결과 화면 (오각형 영토 맵) */
        #result-screen { position: fixed; inset: 0; background: radial-gradient(circle, #222 0%, #000 100%); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #chart-container { width: 600px; height: 600px; background: rgba(255,255,255,0.02); padding: 30px; border-radius: 50%; border: 2px solid #333; position: relative; }

        @keyframes blink { 50% { opacity: 0.4; } }
        .blink { animation: blink 0.6s infinite; }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="timer-disp">READY</div>
    <div id="status-msg" style="color:var(--yellow); font-size: 1.2rem;">MONITOR SELECTION REQUIRED</div>
    <div style="color:#555;">NATION BUILDER Final v19.5</div>
</div>

<div id="result-screen">
    <h1 style="color:var(--yellow); font-size:3.5rem; text-shadow: 0 0 20px var(--yellow); margin-bottom: 10px;">TERRITORY ANALYSIS</h1>
    <div id="chart-container"><canvas id="radarChart"></canvas></div>
    <button onclick="closeResult()" style="margin-top:30px; padding:20px 60px; background:var(--yellow); font-family:'DungGeunMo'; font-size:1.5rem; border:none; cursor:pointer; font-weight:bold;">영토 분석 완료 및 대기</button>
</div>

<div id="room-view">
    <script>
        const cityNames = ['발전','강철','자본','미래','지혜'];
        const rankLabels = ['공터','마을','도시','개도국','선진국'];
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="gate" id="gate-${i}"><button class="start-btn" onclick="requestStart(event)">START MISSION</button></div>
                    
                    <div class="missile-panel" id="mis-panel-${i}">
                        <div id="mis-text-${i}" style="font-size:1.5rem; color:white; margin-bottom:15px; text-align:center;"></div>
                        <button onclick="launchMissile(event, ${i})" style="padding:15px 30px; background:white; color:red; border:none; font-family:'DungGeunMo'; font-weight:bold; cursor:pointer; font-size:1.2rem;">전술 미사일 발사 (카드 7장 소모)</button>
                        <button onclick="closeSabotage(event, ${i})" style="margin-top:10px; background:transparent; color:#ffcccc; border:none; cursor:pointer;">발사 취소</button>
                    </div>

                    <div style="display:flex; justify-content:space-around; background:rgba(0,0,0,0.6); padding:8px; border-bottom:1px solid #333;">
                        ${cityNames.map((c, idx) => `<span id="lvl-${i}-${idx}" style="font-size:0.8rem; color:var(--yellow);">${c}:공터</span>`).join('')}
                    </div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap">
                        <input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="INIT..." disabled autocomplete="off">
                    </div>
                </div>
            `);
        }
    </script>
</div>

<script>
    // --- 1. Firebase & 초기 데이터 설정 ---
    // 사용자님의 Firebase 정보를 이곳에 입력하세요.
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v19_5');
    
    const wordPool = {
        '발전': ['석탄','태양광','원자력','석유','전기','풍력','수력','가스','배터리','탄소'],
        '강철': ['철강','엔진','반도체','로봇','자동차','선박','기계','합금','금속','용접'],
        '자본': ['은행','주식','채권','투자','환율','금리','예산','보험','증권','세금'],
        '미래': ['AI','서버','보안','코딩','양자','클라우드','센서','해킹','드론','위성'],
        '지혜': ['교육','의료','대학','연구','백신','철학','역사','과학','논리','법률']
    };

    let active = false, pCards = {}, currentWords = [], timerIntr = null;
    let cityLevels = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
    let currentTeams = { 1:'red', 2:'red', 3:'blue', 4:'blue' };
    let focusedId = null, sabotageTarget = null, radarChart = null;

    // --- 2. 게임 상태 관리 ---

    function zoomIn(id) {
        focusedId = id;
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        if(!active) {
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.getElementById(`gate-${id}`).style.display = 'flex';
        }
    }

    function requestStart(e) {
        e.stopPropagation();
        const allWords = [];
        Object.keys(wordPool).forEach(cat => allWords.push(...wordPool[cat]));
        db.update({ state: 'RUNNING', words: allWords, cards: {}, startTime: Date.now() });
    }

    function closeResult() {
        document.getElementById('result-screen').style.display = 'none';
        db.update({ state: 'READY' });
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        pCards = d.cards || {};
        if(d.words) { currentWords = d.words; syncBoard(d.words); }
        if(d.teams) currentTeams = d.teams;
        
        if(d.state === 'RUNNING' && !active) {
            active = true;
            document.querySelectorAll('.gate').forEach(g => g.style.display = 'none');
            document.querySelectorAll('.input-box').forEach(inp => inp.disabled = false);
            startTimer();
        } else if(d.state === 'FINISHED' && active) {
            active = false;
            showResult();
        }
        updateUI();
    });

    function syncBoard(words) {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            if(b.innerHTML !== "") continue;
            words.forEach(w => {
                const div = document.createElement('div');
                div.className = 'card'; div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function handleInput(e, id) {
        if(e.key !== 'Enter') return;
        const val = e.target.value.trim();
        if(currentWords.includes(val)) db.child('cards').child(val).set(currentTeams[id]);
        e.target.value = "";
    }

    // --- 3. UI 및 전략 시스템 ---

    function updateUI() {
        const counts = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
        Object.keys(pCards).forEach(w => {
            const t = pCards[w];
            let cIdx = -1;
            Object.keys(wordPool).forEach((cat, idx) => { if(wordPool[cat].includes(w)) cIdx = idx; });
            if(cIdx !== -1) counts[t][cIdx]++;
            for(let i=1; i<=4; i++) {
                const c = document.getElementById(`card-${i}-${w}`);
                if(c) c.className = `card owned-${t}`;
            }
        });

        // 5개 단위 레벨업 (공터-마을-도시-개도국-선진국)
        ['red','blue'].forEach(t => {
            counts[t].forEach((cnt, idx) => { cityLevels[t][idx] = Math.min(4, Math.floor(cnt/5)); });
        });

        for(let i=1; i<=4; i++) {
            const team = currentTeams[i];
            const enemy = team === 'red' ? 'blue' : 'red';
            const mon = document.getElementById(`mon-${i}`);
            mon.className = `monitor team-${team} ${i===focusedId?'focused':''}`;
            
            cityNames.forEach((_, idx) => {
                document.getElementById(`lvl-${i}-${idx}`).innerText = `${cityNames[idx]}:${rankLabels[cityLevels[team][idx]]}`;
            });

            // [미사일 로직] 확대된 모니터에서 적군이 개도국(Lv.3) 이상일 때만 발사 패널 노출
            const panel = document.getElementById(`mis-panel-${i}`);
            let dangerIdx = cityLevels[enemy].findIndex(l => l >= 3);
            if(i === focusedId && dangerIdx !== -1 && active) {
                panel.style.display = 'flex';
                document.getElementById(`mis-text-${i}`).innerText = `경고: 적군 ${cityNames[dangerIdx]} 영토 고도 성장 중!`;
                sabotageTarget = { team: enemy, cityIdx: dangerIdx };
            } else {
                panel.style.display = 'none';
            }
        }
    }

    function launchMissile(e, id) {
        e.stopPropagation();
        const team = currentTeams[id];
        const myCards = Object.keys(pCards).filter(k => pCards[k] === team);
        if(myCards.length < 7) return alert("발사 자원 부족 (카드 7장 필요)");

        // 내 카드 소모
        myCards.slice(0, 7).forEach(k => db.child('cards').child(k).remove());
        // 적 해당 영역 파괴
        const targetWords = wordPool[cityNames[sabotageTarget.cityIdx]];
        Object.keys(pCards).forEach(w => {
            if(pCards[w] === sabotageTarget.team && targetWords.includes(w)) db.child('cards').child(w).remove();
        });
        alert("미사일이 명중했습니다! 적의 영토가 초기화되었습니다.");
    }

    function closeSabotage(e, id) { e.stopPropagation(); document.getElementById(`mis-panel-${id}`).style.display = 'none'; }

    function startTimer() {
        let time = 120;
        if(timerIntr) clearInterval(timerIntr);
        timerIntr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = Math.floor(time/60) + ":" + (time%60).toString().padStart(2,'0');
            if(time % 10 === 0 && time > 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: { 1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3] } });
            }
            if(time <= 0) { clearInterval(timerIntr); db.update({ state: 'FINISHED' }); }
        }, 1000);
    }

    // --- 4. 결과 영토 지도 시각화 ---
    function showResult() {
        document.getElementById('result-screen').style.display = 'flex';
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: cityNames.map(n => n + " 영토"),
                datasets: [
                    { label: 'RED NATION', data: cityLevels.red, backgroundColor: 'rgba(255, 0, 0, 0.6)', borderColor: '#ff0000', borderWidth: 4, fill: true },
                    { label: 'BLUE NATION', data: cityLevels.blue, backgroundColor: 'rgba(0, 102, 255, 0.6)', borderColor: '#0066ff', borderWidth: 4, fill: true }
                ]
            },
            options: {
                scales: {
                    r: {
                        min: 0, max: 4, ticks: { display: false, stepSize: 1 },
                        grid: { color: '#444' }, angleLines: { color: '#444' },
                        pointLabels: { color: '#ffea00', font: { family: 'DungGeunMo', size: 20 } }
                    }
                },
                plugins: { legend: { labels: { color: '#fff', font: { family: 'DungGeunMo', size: 16 } } } }
            }
        });
    }
</script>
</body>
</html>
