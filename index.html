<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íƒ€ì ë°°í‹€ V69 - ì´ˆì„± ì ë ¹ì „ ìµœì í™”</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --red: #ff4757; --red-dark: #ff1f36;
            --blue: #2e86de; --blue-dark: #1a6fbf;
            --yellow: #feca57; --dark: #1e272e; --bg: #f1f2f6; 
        }
        body { background: var(--bg); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ìƒë‹¨ ë°” ë° ì‹¤ì‹œê°„ ì ìœ ìœ¨ ê²Œì´ì§€ */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 80px; background: #fff; border-bottom: 6px solid var(--dark); display: flex; justify-content: space-around; align-items: center; z-index: 2000; color: var(--dark); }
        #gauge-container { position: fixed; top: 80px; left: 0; width: 100%; height: 20px; background: #ccc; display: flex; z-index: 1900; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #gauge-red { height: 100%; background: var(--red); transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #gauge-blue { height: 100%; background: var(--blue); transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        #timer-disp { font-size: 2.5rem; color: #fff; background: var(--dark); padding: 5px 20px; border-radius: 10px; border: 4px solid var(--yellow); }
        .score-box { font-size: 2.2rem; font-weight: bold; transition: transform 0.2s; }
        .score-red { color: var(--red); }
        .score-blue { color: var(--blue); }

        /* ë¼ìš´ë“œ ì„ íƒê¸° */
        #round-selector { position: fixed; inset: 0; background: var(--dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .round-btn { width: 450px; padding: 25px; margin: 10px; font-size: 1.8rem; font-family: 'DungGeunMo'; cursor: pointer; border: 8px outset #eee; border-radius: 10px; color: white; }

        /* ê²Œì„ ë³´ë“œ ë° ëª¨ë‹ˆí„° */
        #room-view { display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 15px; padding: 120px 20px 20px; box-sizing: border-box; }
        .monitor { border: 10px solid var(--dark); display: flex; flex-direction: column; position: relative; background: #777; transition: 0.2s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 110px 20px 20px 20px; z-index: 1500; border-width: 15px; }

        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; flex: 1; padding: 10px; pointer-events: none; background: #555; }
        .cell { background: #ddd; border-radius: 4px; transition: 0.3s; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .cell.red { background: linear-gradient(135deg, var(--red), var(--red-dark)); border: 2px solid #fff; box-shadow: 0 0 10px rgba(255,71,87,0.5); }
        .cell.blue { background: linear-gradient(135deg, var(--blue), var(--blue-dark)); border: 2px solid #fff; box-shadow: 0 0 10px rgba(46,134,222,0.5); }

        .chosung-panel { display: none; background: #000; color: #00ff00; font-size: 4.5rem; text-align: center; padding: 10px; border-top: 6px solid var(--dark); letter-spacing: 20px; }
        body.round-3-active .chosung-panel { display: block; }

        .input-box { width: 100%; padding: 20px; font-family: 'DungGeunMo'; font-size: 3.5rem; border: none; border-top: 6px solid var(--dark); text-align: center; outline: none; background: #fff; color: #000; }
        #countdown { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; font-size: 12rem; color: var(--yellow); }
    </style>
</head>
<body id="main-body">

<div id="round-selector">
    <h1 style="font-size: 4rem; margin-bottom: 40px; color: var(--yellow);">ğŸ« íƒ€ì í•™êµ V69 ğŸ«</h1>
    <button class="round-btn" style="background:#00b894;" onclick="selectRound(1)">1ë¼ìš´ë“œ: í…ìŠ¤íŠ¸</button>
    <button class="round-btn" style="background:#6c5ce7;" onclick="selectRound(2)">2ë¼ìš´ë“œ: ì´ëª¨ì§€</button>
    <button class="round-btn" style="background:#e67e22;" onclick="selectRound(3)">3ë¼ìš´ë“œ: ë¦¬ì–¼ ì´ˆì„±ì „</button>
</div>

<div id="countdown">3</div>

<div id="top-bar">
    <div class="score-box score-red">RED: <span id="total-red">0</span></div>
    <div id="timer-disp">60.0s</div>
    <div class="score-box score-blue">BLUE: <span id="total-blue">0</span></div>
</div>
<div id="gauge-container">
    <div id="gauge-red" style="width: 50%;"></div>
    <div id="gauge-blue" style="width: 50%;"></div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div id="teach-${i}" style="color:#000; text-align:center; padding:8px; background:#fff; font-weight:bold; border-bottom:4px solid #000;">ì¤€ë¹„ì¤‘</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="chosung-panel" id="chosung-box-${i}">??</div>
                    <input type="text" id="input-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ì…ë ¥!" disabled>
                    <button id="start-btn-${i}" onclick="requestStart(event)" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px 40px; font-size:2rem; font-family:'DungGeunMo'; background:var(--yellow); border:5px outset #fff; cursor:pointer; display:none;">ê²Œì„ ì‹œì‘</button>
                </div>
            `);
        }
    </script>
</div>

<script>
    const dictionary2 = ["ì‚¬ê³¼", "í¬ë„", "ì¶•êµ¬", "ë†êµ¬", "ì•¼êµ¬", "ìˆ˜ì˜", "í•™êµ", "ì±…ìƒ", "ì—°í•„", "ë…¸íŠ¸", "ì‚¬ì", "í† ë¼", "ê¸°ì°¨", "íƒœì–‘", "êµ¬ë¦„", "ì‹œê³„", "ì•ˆê²½", "ìš°ì‚°", "ë…¸ë˜", "ê·¸ë¦¼", "ì˜í™”", "ë°”ë‹¤", "í•˜ëŠ˜", "ìš°ì£¼", "ì»¤í”¼", "ì˜ì", "ê°€ë°©", "ì¥ê°‘", "ì–‘ë§", "ë‚˜ë¬´", "ë‚˜ë¹„", "ê°€ì§€", "ì˜¤ì´", "ìš°ìœ ", "ì¹˜ì¦ˆ", "ë¯¸ì†Œ", "í–‰ë³µ", "ì‚¬ë‘", "ì¹œêµ¬", "ê°€ì¡±"];
    
    function getChosung(str) {
        const cho = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        let result = "";
        for(let i=0; i<str.length; i++) {
            const code = str.charCodeAt(i) - 44032;
            if(code >= 0 && code <= 11171) result += cho[Math.floor(code/588)];
            else result += str.charAt(i);
        }
        return result;
    }

    const firebaseConfig = { databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('game_visual_v69');

    let currentRound = 1, currentChosung = "", hasStarted = false, usedWords = new Set();
    let monTeams = { 1: 'red', 2: 'blue', 3: 'red', 4: 'blue' };

    async function selectRound(r) {
        currentRound = r;
        if(r === 3) document.getElementById('main-body').classList.add('round-3-active');
        await db.set({ state: 'WAITING', cards: {}, globalChosung: "" });
        document.getElementById('round-selector').style.display = 'none';
        document.getElementById('room-view').style.display = 'grid';
        initBoard();
    }

    function initBoard() {
        for(let i=1; i<=4; i++){
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            for(let j=0; j<40; j++) {
                const c = document.createElement('div');
                c.className = 'cell'; c.id = `cell-${i}-${j}`;
                b.appendChild(c);
            }
        }
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !hasStarted) startCountDown();
        
        if(currentChosung !== d.globalChosung) {
            currentChosung = d.globalChosung;
            usedWords.clear();
        }
        for(let i=1; i<=4; i++) {
            const cb = document.getElementById(`chosung-box-${i}`);
            if(cb) cb.innerText = currentChosung || "??";
        }

        const cards = d.cards || {};
        for(let i=1; i<=4; i++) {
            for(let j=0; j<40; j++) {
                const cell = document.getElementById(`cell-${i}-${j}`);
                cell.className = 'cell ' + (cards[j] ? cards[j].team : '');
            }
        }

        let rCnt = 0, bCnt = 0;
        Object.values(cards).forEach(v => { if(v.team === 'red') rCnt++; if(v.team === 'blue') bCnt++; });
        
        // ìŠ¤ì½”ì–´ ì—…ë°ì´íŠ¸ ë° ê²Œì´ì§€ ê³„ì‚°
        document.getElementById('total-red').innerText = rCnt;
        document.getElementById('total-blue').innerText = bCnt;
        const total = rCnt + bCnt || 2; // ìµœì†Œê°’ 2ë¡œ ì„¤ì • (0:0 ë°©ì§€)
        const redPct = (rCnt / (rCnt + bCnt || 1)) * 100 || 50;
        document.getElementById('gauge-red').style.width = redPct + "%";
        document.getElementById('gauge-blue').style.width = (100 - redPct) + "%";
    });

    function requestStart(e) { e.stopPropagation(); db.update({ state: 'START' }); }

    function startCountDown() {
        const cd = document.getElementById('countdown');
        cd.style.display = 'flex';
        let count = 3; cd.innerText = count;
        let itv = setInterval(() => {
            count--;
            if(count > 0) cd.innerText = count;
            else if(count === 0) cd.innerText = "GO!";
            else {
                clearInterval(itv); cd.style.display = 'none';
                hasStarted = true;
                document.body.classList.add('game-on');
                document.querySelectorAll('.input-box').forEach(i => i.disabled = false);
                if(currentRound === 3) generateNewChosung();
                gameLoop();
            }
        }, 1000);
    }

    function generateNewChosung() {
        const rand = dictionary2[Math.floor(Math.random()*dictionary2.length)];
        db.update({ globalChosung: getChosung(rand) });
    }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(currentRound === 3 && getChosung(val) === currentChosung && val.length === 2 && dictionary2.includes(val)) {
                if(!usedWords.has(val)) {
                    usedWords.add(val);
                    occupyCell(monTeams[id]);
                }
            }
            e.target.value = '';
        }
    }

    function occupyCell(myTeam) {
        const enemy = myTeam === 'red' ? 'blue' : 'red';
        db.child('cards').once('value', snap => {
            const cards = snap.val() || {};
            let enemyCells = [], emptyCells = [];
            for(let i=0; i<40; i++) {
                if(cards[i]?.team === enemy) enemyCells.push(i);
                else if(!cards[i]) emptyCells.push(i);
            }
            let target = enemyCells.length > 0 ? enemyCells[Math.floor(Math.random()*enemyCells.length)] : emptyCells[Math.floor(Math.random()*emptyCells.length)];
            if(target !== undefined) db.child('cards').child(target).set({ team: myTeam });
        });
    }

    function gameLoop() {
        let time = 600;
        const timer = setInterval(() => {
            if(time > 0) {
                time--;
                document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
                if(currentRound === 3 && time % 100 === 0) generateNewChosung();
                for(let i=1; i<=4; i++) document.getElementById(`teach-${i}`).innerText = "ğŸ”¥ ë‹¨ì–´ ì…ë ¥ ì¤‘! ğŸ”¥";
            } else { clearInterval(timer); location.reload(); }
        }, 100);
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`start-btn-${id}`).style.display = hasStarted ? 'none' : 'block';
        if(hasStarted) setTimeout(() => document.getElementById(`input-${id}`).focus(), 100);
    }
</script>
</body>
</html>
