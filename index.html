// 1. Firebase 설정 (본인의 정보를 입력하면 더 정확합니다)
const firebaseConfig = {
    databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/"
};

// 초기화 확인
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database().ref('mafia_v31_final');

// ... 기존 변수 설정 (cats, stages, wordLib 등 동일) ...

// [수정] 게임 시작 트리거: 모든 모니터의 데이터를 초기화하고 시작 신호를 보냄
function triggerStart() {
    console.log("Game Start Triggered!");
    const shuffled = Object.values(wordLib).flat().sort(() => Math.random() - 0.5).slice(0, 100);
    
    // set 대신 update를 사용하여 특정 노드부터 확실히 초기화
    db.set({
        state: 'COUNTDOWN',
        cards: {}, // 점유 카드 초기화
        curWords: shuffled,
        levels: {red:[0,0,0,0,0], blue:[0,0,0,0,0]},
        teams: {1:'red', 2:'red', 3:'blue', 4:'blue'},
        startTime: firebase.database.ServerValue.TIMESTAMP // 서버 시간 기준 동기화
    }).then(() => {
        console.log("Database Initialized");
    }).catch(e => {
        alert("데이터베이스 연결 오류: " + e.message);
    });
}

// [수정] handleInput: 감시 모드 시 패널티 강화
function handleInput(e) {
    if(e.key !== 'Enter') return;
    const val = e.target.value.trim();
    if(!val) return;

    if(isWatcher) {
        // 감시 모드일 때 타자를 치면 즉시 패널티
        const team = teams[myId];
        db.child('cards').once('value', snap => {
            const currentCards = snap.val() || {};
            const owned = Object.keys(currentCards).filter(w => currentCards[w] === team);
            if(owned.length >= 2) {
                // 내 카드 2개를 무작위로 제거 (중립화)
                db.child('cards').child(owned[0]).remove();
                db.child('cards').child(owned[1]).remove();
            }
        });
        e.target.value = ""; 
        return;
    }

    // 정상 입력
    if(curWords.includes(val)) {
        db.child('cards').child(val).set(teams[myId]);
    }
    e.target.value = "";
}
