<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER: TERRITORY WAR</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #2e86de; --yellow: #f1c40f; --dark: #0a0a0f; --neon: #00ffdd; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo'; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151a; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 3rem; color: var(--yellow); }
        .score-board { font-size: 1.5rem; display: flex; gap: 20px; }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; padding: 120px 10px 10px 10px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 4px solid #333; background: #000; display: flex; flex-direction: column; position: relative; }
        .monitor.focused { position: fixed !important; inset: 120px 10px 10px 10px; z-index: 5000; border-color: var(--neon); }

        /* 16칸 그리드 */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 5px; flex: 1; padding: 10px; }
        .tile { border: 1px solid #222; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; position: relative; transition: 0.3s; background: #111; }
        
        /* 라운드 중 점유 상태 */
        .tile.red { background: var(--red); color: #fff; border: none; }
        .tile.blue { background: var(--blue); color: #fff; border: none; }
        
        /* 영구 점유 상태 */
        .tile.perm-red { border: 4px solid #fff !important; background: var(--red) !important; box-shadow: inset 0 0 15px #000; }
        .tile.perm-blue { border: 4px solid #fff !important; background: var(--blue) !important; box-shadow: inset 0 0 15px #000; }
        .tile.perm-red::after, .tile.perm-blue::after { content: '★'; position: absolute; top: 2px; right: 2px; font-size: 0.8rem; }

        .input-wrap { display: flex; height: 80px; border-top: 4px solid var(--yellow); }
        .input-box { flex: 1; background: #000; color: #0f0; border: none; font-size: 3rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .gate-btn { padding: 15px 40px; font-family: 'DungGeunMo'; font-size: 1.5rem; background: var(--yellow); border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 3rem;">TERRITORY WAR</h1>
    <p id="round-info">준비가 되면 버튼을 누르세요</p>
    <button class="gate-btn" onclick="initRound()">대결 시작</button>
</div>

<div id="top-bar">
    <div class="score-board">
        <span style="color:var(--red)">RED: <span id="perm-red-cnt">0</span></span>
        <span id="round-display" style="color:var(--neon)">ROUND 1/16</span>
        <span style="color:var(--blue)">BLUE: <span id="perm-blue-cnt">0</span></span>
    </div>
    <div id="timer-disp">10.0s</div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div id="board-${i}" class="board"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="터미널 잠김" disabled autocomplete="off"></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    // Firebase 설정
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('territory_war_v1');

    const wordList = ['강철','엔진','보안','네트','코드','데이터','위성','로봇','미래','자본','투자','은행','지혜','연구','에너지','전기'];
    let myId = 0, currentTeams = {1:'red', 2:'red', 3:'blue', 4:'blue'};
    let roundData = { roundNum: 1, permOwned: {}, roundTiles: {} };

    // 라운드 초기화 (한 명만 실행)
    function initRound() {
        const resetTiles = {};
        wordList.forEach(w => resetTiles[w] = "none");
        db.update({ 
            state: 'START',
            roundTiles: resetTiles,
            winner: 'none'
        });
        document.getElementById('lobby-screen').style.display = 'none';
    }

    function zoomIn(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`in-${id}`).disabled = false;
        document.getElementById(`in-${id}`).focus();
        myId = id;
    }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(wordList.includes(val)) {
                // 이미 영구 점유된 땅이 아닐 때만 공격 가능
                if(!roundData.permOwned[val]) {
                    db.child('roundTiles').child(val).set(currentTeams[id]);
                }
            }
            e.target.value = "";
        }
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        roundData = d;
        if(d.teams) currentTeams = d.teams;
        updateUI(d);
        checkRoundWinner(d);
    });

    function updateUI(d) {
        const permRed = Object.values(d.permOwned || {}).filter(v => v === 'red').length;
        const permBlue = Object.values(d.permOwned || {}).filter(v => v === 'blue').length;
        document.getElementById('perm-red-cnt').innerText = permRed;
        document.getElementById('perm-blue-cnt').innerText = permBlue;
        document.getElementById('round-display').innerText = `ROUND ${d.roundNum}/16`;

        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            wordList.forEach(w => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.innerText = w;
                
                // 1. 영구 소유 여부 확인
                if(d.permOwned && d.permOwned[w]) {
                    tile.classList.add(`perm-${d.permOwned[w]}`);
                } 
                // 2. 현재 라운드 점유 확인
                else if(d.roundTiles && d.roundTiles[w] !== "none") {
                    tile.classList.add(d.roundTiles[w]);
                }
                b.appendChild(tile);
            });
        }
    }

    function checkRoundWinner(d) {
        if(d.winner !== 'none') return;

        const currentTiles = d.roundTiles || {};
        const redCount = Object.values(currentTiles).filter(v => v === 'red').length;
        const blueCount = Object.values(currentTiles).filter(v => v === 'blue').length;

        // 16칸 중 절반(9칸) 이상 차지하면 라운드 종료
        if(redCount >= 9 || blueCount >= 9) {
            const winTeam = redCount >= 9 ? 'red' : 'blue';
            if(myId === 1) processRoundEnd(winTeam, d);
        }
    }

    function processRoundEnd(winTeam, d) {
        // 영구 소유할 수 있는 땅 탐색 (중립인 땅 중 하나 선택)
        const neutralTiles = wordList.filter(w => !d.permOwned || !d.permOwned[w]);
        if(neutralTiles.length === 0) return;

        const targetTile = neutralTiles[0]; // 단순화: 남은 땅 중 첫 번째 구매
        const nextRound = d.roundNum + 1;

        db.update({ winner: winTeam });
        alert(`${winTeam.toUpperCase()} 팀 승리! [${targetTile}] 영구 획득!`);

        setTimeout(() => {
            const updates = {};
            updates[`permOwned/${targetTile}`] = winTeam;
            updates[`roundNum`] = nextRound;
            updates[`winner`] = 'none';
            // 라운드 타일 초기화
            const resetTiles = {};
            wordList.forEach(w => resetTiles[w] = "none");
            updates[`roundTiles`] = resetTiles;

            if(nextRound > 16) {
                alert("최종 전쟁 종료! 영구 영토가 많은 팀이 승리입니다.");
                updates[`roundNum`] = 1; // 리셋
                updates[`permOwned`] = {};
            }
            db.update(updates);
        }, 2000);
    }

    // 10초마다 팀 셔플 (1번 모니터가 마스터)
    setInterval(() => {
        if(myId === 1 && roundData.state === 'START') {
            const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
            db.update({ teams: { 1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3] } });
        }
    }, 10000);
</script>
</body>
</html>
