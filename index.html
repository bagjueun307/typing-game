<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff1a1a; --blue: #1a75ff; --gold: #ffea00; --neon: #00ff41; --dark: #050505; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; transition: background 0.3s; }
        
        /* íŒ€ë³„ ì›ìƒ‰ ë°°ê²½ */
        body.team-red { background-color: #900 !important; }
        body.team-blue { background-color: #004cff !important; }

        /* ìƒë‹¨ ëŒ€ì‹œë³´ë“œ */
        #header { height: 185px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; border-bottom: 4px solid #fff; z-index: 10; position: relative; }
        #main-timer { font-size: 3.5rem; color: var(--gold); margin: 5px 0; text-shadow: 0 0 10px var(--gold); }
        
        .territory-row { display: flex; gap: 8px; justify-content: center; width: 98%; }
        .sector-card { background: #1a1a1a; border: 2px solid #444; padding: 10px; width: 175px; text-align: center; border-radius: 12px; position: relative; overflow: hidden; }
        .sector-card.won-red { border-color: var(--red); box-shadow: inset 0 0 20px #f00; }
        .sector-card.won-blue { border-color: var(--blue); box-shadow: inset 0 0 20px #00f; }
        
        .step-icon { font-size: 2.2rem; margin-bottom: 5px; color: var(--gold); display: block; }
        .step-label { font-size: 0.75rem; color: #888; }
        .prog-info { font-size: 1.1rem; font-weight: bold; color: var(--neon); }
        
        /* í° ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ */
        .up-btn { position: absolute; inset: 0; background: var(--gold); color: #000; border: none; font-size: 1.8rem; font-weight: bold; cursor: pointer; display: none; z-index: 20; font-family: 'DungGeunMo'; }

        /* ì…”í”Œ ë°” */
        #shuffle-wrap { width: 100%; height: 12px; background: #000; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 1s linear; }

        /* ë‹¨ì–´ íŒ (100ê°œ ê·¸ë¦¬ë“œ) */
        #board { height: calc(100vh - 300px); display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); gap: 4px; padding: 12px; box-sizing: border-box; }
        .card { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: #fff; transition: 0.1s; font-weight: bold; }
        .card.red { background: var(--red) !important; color: #fff; border: 2px solid #fff; }
        .card.blue { background: var(--blue) !important; color: #fff; border: 2px solid #fff; }

        /* ì…ë ¥ì°½ êµ¬ì—­ */
        #input-zone { height: 103px; display: flex; align-items: center; background: rgba(0,0,0,0.9); border-top: 3px solid #fff; }
        .input-hint { padding: 0 30px; font-size: 1.5rem; color: var(--gold); }
        #word-input { width: 100%; height: 100%; background: transparent; border: none; font-size: 4.5rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        /* íŠ¹ìˆ˜ ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ */
        #bonus-msg { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); background: var(--gold); color: #000; padding: 30px 60px; font-size: 4rem; z-index: 1000; display: none; border: 10px double #000; box-shadow: 0 0 50px #000; }
        #surveillance { position: fixed; inset: 0; background: rgba(255,0,0,0.85); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; font-size: 6rem; color: #fff; text-shadow: 0 0 20px #000; }

        /* íŒì—… ì°½ */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-action { padding: 25px 60px; font-size: 2.5rem; background: var(--gold); font-family: 'DungGeunMo'; cursor: pointer; border: none; border-radius: 12px; margin-top: 20px; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body id="main-body" onclick="document.getElementById('word-input').focus()">

<div id="lobby" class="overlay">
    <h1 style="font-size: 5rem; color: var(--gold); margin-bottom: 20px;">NATION BUILDER</h1>
    <button class="btn-action" onclick="GAME.requestStart(true)">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="result-screen" class="overlay" style="display:none;">
    <h1 style="font-size: 3.5rem; color: var(--gold); margin-bottom: 20px;">ROUND REPORT</h1>
    <div id="result-data" style="display:flex; gap:20px; margin-bottom:30px;"></div>
    <div id="result-btns">
        <button id="close-res-btn" class="btn-action" style="background:#444; color:#fff;" onclick="GAME.showNextStep()">ê²°ê³¼ ì°½ ë‹«ê¸°</button>
        <button id="resume-btn" class="btn-action" style="display:none; background:var(--neon);" onclick="GAME.requestStart(false)">ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</button>
    </div>
</div>

<div id="header">
    <div id="main-timer">02:00</div>
    <div class="territory-row" id="territory-row"></div>
</div>
<div id="shuffle-wrap"><div id="shuffle-bar"></div></div>

<div id="board"></div>

<div id="input-zone">
    <div class="input-hint">INPUT ></div>
    <input type="text" id="word-input" autocomplete="off" placeholder="READY...">
</div>

<div id="bonus-msg">BONUS WORD!<br><span id="bonus-word"></span></div>
<div id="surveillance">ğŸš¨ ê°ì‹œ ì¤‘! ğŸš¨<br><span style="font-size:2rem">ì…ë ¥ ì‹œ íŒ¨ë„í‹° ë¶€ì—¬</span></div>

<script>
const CONFIG = {
    sectors: ['ì—ë„ˆì§€', 'ì¸í”„ë¼', 'ìë³¸', 'ê¸°ìˆ ', 'ë¬¸í™”'],
    levels: ['ê³µí„°', 'ë§ˆì„', 'ë„ì‹œ', 'ê°œë°œë„ìƒêµ­', 'ì„ ì§„êµ­'],
    icons: ['fa-seedling', 'fa-home', 'fa-city', 'fa-industry', 'fa-crown'],
    wordPool: {
        'ì—ë„ˆì§€': ['ì„ìœ ','ì „ê¸°','ì›ìë ¥','íƒœì–‘ê´‘','ë°°í„°ë¦¬','ì„íƒ„','ê°€ìŠ¤','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ì†¡ì „','ì „ì••','ë°œì „','íƒ„ì†Œ','ê·¸ë¦¬ë“œ','ì—°ë£Œ','ì¶©ì „','ë³€ì „','ì—”ì§„','ë°©ì‚¬ëŠ¥','í•µìœµí•©','ì˜¤ì¼','ì „ì„ ','ê°€ì†”ë¦°','ë””ì ¤','ì „ë ¥','ìˆ˜ì†Œ','ë°”ì´ì˜¤','ì ˆì „','ì•”í˜ì–´'],
        'ì¸í”„ë¼': ['ë„ë¡œ','ì² ë„','í•­ë§Œ','ê³µí•­','êµëŸ‰','í„°ë„','ë¹Œë”©','ê°•ì² ','ì‹œë©˜íŠ¸','í¬ë ˆì¸','ìƒìˆ˜ë„','ê±´ì„¤','ë¬¼ë¥˜','ìœ í†µ','ì„¤ê³„','ë„ì‹œ','í†µì‹ ','ë²½ëŒ','ì¤‘ì¥ë¹„','ì •ë¹„','ì•„ìŠ¤íŒ”íŠ¸','ë°°ê´€','í•˜ìˆ˜ë„','ê³µì‚¬ì¥','ì² ê·¼','ê³¨ì¡°','í•­êµ¬','ê¶¤ë„','ê³ ì†ë„ë¡œ','ìš´í•˜'],
        'ìë³¸': ['ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ì€í–‰','ê¸ˆë¦¬','í™˜ìœ¨','ì„¸ê¸ˆ','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','í€ë“œ','ê²½ì œ','í™”í','ë¹„ìš©','ìì‚°','ë¬´ì—­','ì½”ì¸','ë°°ë‹¹','ì¦ì‹œ','ë¶€ì±„','ê¸ˆìœµ','ì¬í…Œí¬','ì´ì','ì‹ ìš©','ìˆ˜ì…','ì§€ì¶œ','ì—°ê¸ˆ','ë³µë¦¬','ëŒ€ì¶œ','í˜„ê¸ˆ'],
        'ê¸°ìˆ ': ['AI','ë¡œë´‡','ì½”ë”©','ë³´ì•ˆ','ì„œë²„','ë°˜ë„ì²´','ë°ì´í„°','ì–‘ì','í•´í‚¹','ë“œë¡ ','ìœ„ì„±','ì„¼ì„œ','ë°±ì‹ ','ëª¨ë°”ì¼','ì¹©','ì†ŒìŠ¤','íšŒë¡œ','ë¨¸ì‹ ','ì¸í„°ë„·','ì›¹','ë”¥ëŸ¬ë‹','ì½”ë”©','ë‚˜ë…¸','ë°”ì´ì˜¤','ê´‘í•™','ìš°ì£¼ì„ ','ë§ì›ê²½','ì½”ì¼','ì—”ì§„','í”„ë¡œê·¸ë¨'],
        'ë¬¸í™”': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ','ì–¸ì–´','ì‹¬ë¦¬','ë¯¸ë””ì–´','ì˜ˆìˆ ','ì˜í™”','ìŒì•…','ì¶•ì œ','ìœ ì‚°','í•œê¸€','ì¢…êµ','ì „í†µ','ì •ì‹ ','ë°•ë¬¼ê´€','ì „ì‹œ','ë¯¸ìˆ ','ì—°ê·¹','ë¬¸í•™','ì†Œì„¤','ì‹œì¸','ë¬´ìš©','ì•…ê¸°','ì¶•ì œ']
    }
};

const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_v6_final');

const GAME = {
    team: 'red',
    slot: 'm' + (new URLSearchParams(window.location.search).get('m') || '1'),
    active: false,
    
    init() {
        this.renderInitialSectors();
        this.listenFirebase();
        this.bindEvents();
        // í•­ìƒ í¬ì»¤ìŠ¤ ìœ ì§€
        setInterval(() => document.getElementById('word-input').focus(), 500);
    },

    renderInitialSectors() {
        const row = document.getElementById('territory-row');
        row.innerHTML = CONFIG.sectors.map((s, i) => `
            <div class="sector-card" id="sector-${i}">
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE!</button>
                <i class="fas ${CONFIG.icons[0]} step-icon" id="icon-${i}"></i>
                <div class="step-label" id="step-name-${i}">ê³µí„°</div>
                <div style="font-weight:bold; font-size:1.1rem; margin:3px 0;">${s}</div>
                <div class="prog-info" id="prog-${i}">0 / 5</div>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDB();
            this.sync(data);
        });
    },

    resetDB() {
        const words = this.getNewRoundWords([]);
        db.set({
            state: 'READY', timer: 120, shuffle: 10,
            words: words, cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1:'red', m2:'red', m3:'blue', m4:'blue' },
            bonus: "", surveillance: false, usedAll: words
        });
    },

    getNewRoundWords(usedAll) {
        let all = [];
        Object.keys(CONFIG.wordPool).forEach(key => {
            const filtered = CONFIG.wordPool[key].filter(w => !usedAll.includes(w));
            all.push(...filtered.sort(() => Math.random() - 0.5).slice(0, 20));
        });
        return all.sort(() => Math.random() - 0.5);
    },

    sync(data) {
        document.getElementById('lobby').style.display = (data.state === 'READY') ? 'flex' : 'none';
        document.getElementById('result-screen').style.display = (data.state === 'FINISHED') ? 'flex' : 'none';
        
        this.team = data.teams[this.slot];
        document.body.className = (this.team === 'red') ? 'team-red' : 'team-blue';
        
        document.getElementById('main-timer').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffle / 10) * 100 + "%";

        const board = document.getElementById('board');
        if(board.childElementCount === 0 || data.timer === 120) {
            board.innerHTML = data.words.map(w => `<div class="card" id="card-${w}">${w}</div>`).join('');
        }
        
        const myRes = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, owner]) => {
            const el = document.getElementById(`card-${word}`);
            if(el) el.className = `card ${owner}`;
            if(owner === this.team) {
                const sIdx = this.getSectorIdx(word);
                if(sIdx !== -1) myRes[sIdx]++;
            }
        });

        CONFIG.sectors.forEach((_, i) => {
            const rL = data.levels.red[i], bL = data.levels.blue[i], myL = data.levels[this.team][i];
            const sectorEl = document.getElementById(`sector-${i}`);
            
            if(rL === 4) sectorEl.className = "sector-card won-red";
            else if(bL === 4) sectorEl.className = "sector-card won-blue";
            else sectorEl.className = "sector-card";

            const maxL = Math.max(rL, bL);
            document.getElementById(`icon-${i}`).className = `fas ${CONFIG.icons[maxL]} step-icon`;
            document.getElementById(`step-name-${i}`).innerText = CONFIG.levels[maxL];
            document.getElementById(`prog-${i}`).innerText = `${myRes[i]} / 5 (ë‚´ë‹¨ê³„: ${CONFIG.levels[myL]})`;
            
            const upBtn = document.getElementById(`up-btn-${i}`);
            upBtn.style.display = (myRes[i] >= 5 && myL < 4 && rL < 4 && bL < 4) ? 'block' : 'none';
        });

        document.getElementById('bonus-msg').style.display = data.bonus ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonus;
        document.getElementById('surveillance').style.display = data.surveillance ? 'flex' : 'none';

        if(data.state === 'FINISHED') {
            document.getElementById('result-data').innerHTML = ['red','blue'].map(t => `
                <div style="background:#111; padding:25px; border:5px solid var(--${t}); min-width:200px;">
                    <h2 style="color:var(--${t}); font-size:2.2rem;">${t.toUpperCase()} MAFIA</h2>
                    ${CONFIG.sectors.map((s,i)=>`<div style="font-size:1.2rem; margin:5px 0;">${s}: ${CONFIG.levels[data.levels[t][i]]} <i class="fas ${CONFIG.icons[data.levels[t][i]]}"></i></div>`).join('')}
                </div>
            `).join('');
            document.getElementById('close-res-btn').style.display = 'block';
            document.getElementById('resume-btn').style.display = 'none';
        }

        if(this.slot === 'm1' && data.state === 'RUNNING' && !this.active) {
            this.active = true;
            this.runMasterTimer();
        }
    },

    runMasterTimer() {
        let bT = 20, sT = 30;
        const interval = setInterval(() => {
            db.once('value', snap => {
                const data = snap.val();
                if(data.state !== 'RUNNING') return clearInterval(interval);

                let upd = { timer: data.timer - 1, shuffle: data.shuffle - 1 };
                bT--; sT--;

                if(upd.shuffle <= 0) {
                    upd.shuffle = 10;
                    const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                    upd.teams = { m1:ts[0], m2:ts[1], m3:ts[2], m4:ts[3] };
                }
                if(bT <= 0) {
                    bT = 20;
                    const pool = Object.values(CONFIG.wordPool).flat();
                    upd.bonus = pool[Math.floor(Math.random()*pool.length)];
                }
                if(sT <= 0) {
                    sT = 30;
                    db.update({ surveillance: true });
                    setTimeout(() => db.update({ surveillance: false }), 2000);
                }
                if(upd.timer <= 0) {
                    upd.state = 'FINISHED';
                    this.active = false;
                }
                db.update(upd);
            });
        }, 1000);
    },

    requestStart(fullReset) {
        db.once('value', snap => {
            const data = snap.val();
            const usedNow = data.usedAll || [];
            const newWords = this.getNewRoundWords(usedNow);
            const updates = { 
                state: 'RUNNING', timer: 120, shuffle: 10, 
                words: newWords, cards: {}, bonus: "", surveillance: false,
                usedAll: usedNow.concat(newWords)
            };
            if(fullReset) {
                updates.levels = { red: [0,0,0,0,0], blue: [0,0,0,0,0] };
                updates.usedAll = newWords;
            }
            db.update(updates);
        });
    },

    showNextStep() {
        document.getElementById('close-res-btn').style.display = 'none';
        document.getElementById('resume-btn').style.display = 'block';
    },

    bindEvents() {
        const inp = document.getElementById('word-input');
        inp.oninput = () => {
            db.once('value', snap => {
                const data = snap.val();
                if(data.surveillance && inp.value.length > 0) { // ê°ì‹œ íŒ¨ë„í‹°: ì¹˜ê¸°ë§Œ í•´ë„ ì¦‰ì‹œ ì ìš©
                    const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team);
                    if(mine.length >= 2) {
                        db.child('cards').child(mine[0]).remove();
                        db.child('cards').child(mine[1]).remove();
                    } else if(mine.length === 1) {
                        db.child('cards').child(mine[0]).remove();
                    }
                    inp.value = "";
                }
            });
        };
        inp.onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = inp.value.trim();
                db.once('value', snap => {
                    const data = snap.val();
                    if(val === data.bonus) {
                        const enemy = this.team === 'red' ? 'blue' : 'red';
                        const eCards = Object.keys(data.cards||{}).filter(w => data.cards[w] === enemy);
                        eCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                        db.update({ bonus: "" });
                    } else if(data.words.includes(val)) {
                        db.child('cards').child(val).set(this.team);
                    }
                });
                inp.value = "";
            }
        };
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const words = CONFIG.wordPool[CONFIG.sectors[idx]];
            const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team && words.includes(w));
            if(mine.length >= 5) {
                mine.slice(0,5).forEach(w => db.child('cards').child(w).remove());
                const lvs = data.levels[this.team];
                lvs[idx]++;
                db.child('levels').child(this.team).set(lvs);
                if(lvs.filter(v => v === 4).length >= 3) db.update({ state: 'FINISHED' });
            }
        });
        document.getElementById('word-input').focus(); // í´ë¦­ í›„ ìë™ í¬ì»¤ìŠ¤
    },

    getSectorIdx(w) { return Object.values(CONFIG.wordPool).findIndex(l => l.includes(w)); },
    formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
};

GAME.init();
</script>
</body>
</html>
