<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MAFIA: EMPIRE STRATEGY FINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #D63031; --blue: #0984E3; --yellow: #FDCB6E; --dark: #0A0A0F; --laser: #FF0000; --ai: #00FFDD; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151A; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 3rem; color: var(--yellow); }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 130px 15px 15px 15px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 6px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 12px; position: relative; transition: 0.3s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 120px 20px 20px 20px; z-index: 5000; border-width: 12px; }
        
        /* íŒ€ í‘œì‹œ */
        .team-indicator { font-size: 1.5rem; padding: 10px; text-align: center; font-weight: bold; }
        .monitor.team-red { border-color: var(--red); }
        .monitor.team-blue { border-color: var(--blue); }
        .monitor.team-red .team-indicator { background: var(--red); color: #fff; }
        .monitor.team-blue .team-indicator { background: var(--blue); color: #fff; }

        /* ì…ë ¥ì°½ */
        .input-wrap { display: flex; height: 90px; border-top: 5px solid var(--yellow); }
        .monitor.team-red .input-wrap { background: #4D0000; }
        .monitor.team-blue .input-wrap { background: #002B4D; }
        .input-box { flex: 1; background: rgba(0,0,0,0.5); color: #fff; border: none; font-size: 3rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        /* ë ˆì´ì €/ê°ì‹œ ì—°ì¶œ */
        .laser-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; }
        .monitor.warning .laser-overlay { opacity: 1; background: rgba(253, 203, 110, 0.2); border: 15px solid var(--yellow); animation: warn-blink 0.2s infinite; }
        .monitor.warning .laser-overlay::after { content: "âš ï¸ SCANNING..."; color: var(--yellow); font-size: 4rem; text-shadow: 0 0 10px #000; }
        .monitor.alert .laser-overlay { 
            opacity: 1; background: rgba(0,0,0,0.7); border: 15px solid var(--laser);
            background-image: linear-gradient(rgba(255,0,0,0.8) 2px, transparent 2px), linear-gradient(90deg, rgba(255,0,0,0.8) 2px, transparent 2px);
            background-size: 40px 40px; animation: laser-move 0.5s linear infinite;
        }
        .monitor.alert .laser-overlay::after { content: "ğŸš¨ LASER ACTIVE ğŸš¨"; color: #fff; font-size: 5rem; text-shadow: 0 0 20px #FF0000; animation: text-pulse 0.1s infinite; }

        @keyframes laser-move { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
        @keyframes warn-blink { 0% { opacity: 0.3; } 100% { opacity: 0.8; } }
        @keyframes text-pulse { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }

        /* ì¹´ë“œ ë³´ë“œ */
        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; flex: 1; padding: 10px; background: #000; }
        .card { height: 50px; background: #1A1A1A; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #888; }
        .card.owned-red { background: var(--red) !important; color: white; border-color: #fff; font-weight: bold; box-shadow: 0 0 8px var(--red); }
        .card.owned-blue { background: var(--blue) !important; color: white; border-color: #fff; font-weight: bold; box-shadow: 0 0 8px var(--blue); }

        /* ì˜¤ë²„ë ˆì´ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        button { padding: 15px 40px; font-family: 'DungGeunMo'; cursor: pointer; background: var(--yellow); border: none; font-size: 1.3rem; margin: 10px; }
        .monitor-start-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ê²°ê³¼ì°½ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { display: flex; gap: 50px; margin: 20px 0; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; }
        .chart-box h2 { margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 3rem;">MAFIA INDUSTRY WAR</h1>
    <div id="ai-briefing" style="background:rgba(0,255,221,0.1); padding:20px; border:1px solid var(--ai); color:var(--ai); margin: 20px 0; border-radius:10px; width: 600px;">
        <strong>[ì˜¤ë¼í´ ì „ëµ ì¡°ì–¸]</strong><br><span id="ai-message">ë¶„ì„ ë°ì´í„°ë¥¼ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...</span>
    </div>
    <div id="evo-status" style="display:flex; gap:10px; margin-bottom:20px;"></div>
    <button onclick="prepareRound()">í˜„ì¥ ì¹¨íˆ¬ ì‹œì‘ (ì´ì–´ì„œ í•˜ê¸°)</button>
</div>

<div id="result-screen" class="overlay" style="display:none; z-index:11000;">
    <h1 style="color:var(--yellow); font-size: 2.5rem;">[ìµœì¢… ë¼ìš´ë“œ ë¶„ì„ ë³´ê³ ì„œ]</h1>
    <div class="chart-container">
        <div class="chart-box"><h2 style="color:var(--red);">RED MAFIA</h2><canvas id="final-chart-red" width="350" height="350"></canvas></div>
        <div class="chart-box"><h2 style="color:var(--blue);">BLUE MAFIA</h2><canvas id="final-chart-blue" width="350" height="350"></canvas></div>
    </div>
    <button onclick="closeResult()">ê²°ê³¼ ë¶„ì„ì°½ ë‹«ê³  ë³µê·€</button>
</div>

<div id="top-bar">
    <div id="timer-disp">120.0s</div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="team-indicator" id="team-text-${i}">ì ‘ì† ëŒ€ê¸°</div>
                    <div class="laser-overlay"></div>
                    <div class="monitor-start-layer" id="layer-${i}">
                        <button id="btn-start-${i}" onclick="triggerStart(event, ${i})" style="display:none;">ì‹œìŠ¤í…œ ì¹¨íˆ¬</button>
                    </div>
                    <div id="cd-${i}" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:12rem; color:var(--yellow); z-index:4000; background:rgba(0,0,0,0.8);">3</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ëª¨ë‹ˆí„° ì„ íƒ" disabled></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const wordBank = {
        'ì—ë„ˆì§€': ['ì„íƒ„','íƒœì–‘ê´‘','ì›ìë ¥','ì„ìœ ','ì „ê¸°','í’ë ¥','ìˆ˜ì†Œ','ë°°í„°ë¦¬','ê°€ìŠ¤','í™”ë ¥'],
        'ì œì¡°': ['ì² ê°•','ê¸ˆì†','ìë™ì°¨','ì„ ë°•','ë°˜ë„ì²´','ê¸°ê³„','ë¡œë´‡','í™”ì„','í™”í•™','ë¶€í’ˆ'],
        'ê¸ˆìœµ': ['ì€í–‰','ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ìì‚°','í™˜ìœ¨','ê¸ˆë¦¬','í€ë“œ','ë³´í—˜','ì¦ê¶Œ'],
        'ê¸°ìˆ ': ['AI','ì†Œí”„íŠ¸ì›¨ì–´','í´ë¼ìš°ë“œ','ì„œë²„','ë³´ì•ˆ','ì½”ë”©','ì•Œê³ ë¦¬ì¦˜','ì–‘ì','ì„¼ì„œ','íšŒë¡œ'],
        'ì¸ì ìë³¸': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','í›ˆë ¨','ì—°êµ¬','ë°±ì‹ ','ì„ìƒ','ì¥í•™','ì¸ì¬','êµìˆ˜']
    };

    let persistentCards = {}, activeWords = {}, active = false, isAlert = false, isWarning = false;
    let finalCharts = { red: null, blue: null };
    let currentScores = { red: {}, blue: {} };

    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_v6_final');

    function prepareRound() {
        document.getElementById('lobby-screen').style.display = 'none';
        const newWords = {};
        Object.keys(wordBank).forEach(cat => newWords[cat] = [...wordBank[cat]].sort(()=>Math.random()-0.5));
        activeWords = newWords;
        const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
        db.update({ state: 'READY', teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
        initBoardUI();
    }

    function initBoardUI() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            Object.values(activeWords).flat().forEach(w => {
                const div = document.createElement('div');
                div.className = `card ${persistentCards[w]? 'owned-'+persistentCards[w].team : ''}`;
                div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.querySelectorAll('.monitor-start-layer button').forEach(b => b.style.display = 'none');
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`btn-start-${id}`).style.display = 'block';
    }

    function triggerStart(e, id) {
        e.stopPropagation();
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'flex';
        let count = 3;
        const intr = setInterval(() => {
            count--; if(count > 0) cd.innerText = count;
            else {
                clearInterval(intr); cd.style.display = 'none';
                document.getElementById(`layer-${id}`).style.display = 'none';
                db.update({ state: 'START' });
                document.getElementById(`in-${id}`).disabled = false;
                document.getElementById(`in-${id}`).focus();
            }
        }, 1000);
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            for(let i=1; i<=4; i++) {
                const m = document.getElementById(`mon-${i}`);
                m.className = `monitor team-${d.teams[i]} ${m.classList.contains('focused')?'focused':''} ${isWarning?'warning':''} ${isAlert?'alert':''}`;
                document.getElementById(`team-text-${i}`).innerText = `[ì†Œì†: ${d.teams[i].toUpperCase()} TEAM]`;
            }
        }
        if(d.cards) {
            persistentCards = d.cards;
            const scores = { red: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 }, blue: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 } };
            Object.keys(persistentCards).forEach(w => {
                const team = persistentCards[w].team;
                const cat = findCat(w);
                if(cat && team !== 'neutral') scores[team][cat]++;
                for(let i=1; i<=4; i++) {
                    const c = document.getElementById(`card-${i}-${w}`);
                    if(c) c.className = `card owned-${team}`;
                }
            });
            currentScores = scores; // ì ìˆ˜ ì €ì¥
            updateEvoStatus(scores);
        }
    });

    function findCat(w) { for(let cat in wordBank) if(wordBank[cat].includes(w)) return cat; return null; }

    function handleInput(e, id) {
        const team = document.getElementById(`mon-${id}`).classList.contains('team-red') ? 'red' : 'blue';
        if(isAlert) {
            db.child('cards').once('value', s => {
                const c = s.val(); if(!c) return;
                const mine = Object.keys(c).filter(k => c[k].team === team);
                if(mine.length > 0) db.child('cards').child(mine[mine.length-1]).set({team:'neutral'});
            });
            e.target.value = ""; return;
        }
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(findCat(val)) db.child('cards').child(val).set({ team: team });
            e.target.value = "";
        }
    }

    function startTimer() {
        let time = 1200;
        const intr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            let cycle = time % 100;
            isWarning = (cycle <= 30 && cycle > 20); 
            isAlert = (cycle <= 20 && cycle > 0); 
            document.querySelectorAll('.monitor').forEach(m => {
                m.classList.toggle('warning', isWarning);
                m.classList.toggle('alert', isAlert);
            });
            if(time > 0 && time % 100 === 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
            }
            if(time <= 0) { clearInterval(intr); endRound(); }
        }, 100);
    }

    function endRound() {
        active = false;
        document.getElementById('result-screen').style.display = 'flex';
        renderFinalCharts(currentScores); // ìµœì¢… ì ìˆ˜ë¡œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    }

    function renderFinalCharts(scores) {
        const cats = ['ì—ë„ˆì§€','ì œì¡°','ê¸ˆìœµ','ê¸°ìˆ ','ì¸ì ìë³¸'];
        const rData = cats.map(c => scores.red[c]);
        const bData = cats.map(c => scores.blue[c]);

        const chartOpt = (color, data) => ({
            type: 'radar',
            data: {
                labels: cats,
                datasets: [{
                    data: data,
                    backgroundColor: color + '55',
                    borderColor: color,
                    borderWidth: 4,
                    pointBackgroundColor: color
                }]
            },
            options: {
                scales: {
                    r: {
                        min: 0, max: 10,
                        ticks: { stepSize: 2, display: false },
                        grid: { color: 'rgba(255,255,255,0.2)' },
                        angleLines: { color: 'rgba(255,255,255,0.2)' },
                        pointLabels: { color: '#fff', font: { size: 14, family: 'DungGeunMo' } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        if(finalCharts.red) finalCharts.red.destroy();
        if(finalCharts.blue) finalCharts.blue.destroy();

        finalCharts.red = new Chart(document.getElementById('final-chart-red'), chartOpt('#FF4757', rData));
        finalCharts.blue = new Chart(document.getElementById('final-chart-blue'), chartOpt('#2E86DE', bData));
    }

    function closeResult() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'flex';
        document.querySelectorAll('.monitor-start-layer').forEach(l => l.style.display = 'flex');
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
    }

    function updateEvoStatus(scores) {
        const cats = ['ì—ë„ˆì§€','ì œì¡°','ê¸ˆìœµ','ê¸°ìˆ ','ì¸ì ìë³¸'];
        let html = "";
        cats.forEach(c => {
            const count = Math.max(scores.red[c], scores.blue[c]);
            html += `<div style="padding:10px; border:2px solid ${count>=10?'var(--yellow)':'#444'}; width:80px;">${c}<br>${count}/10</div>`;
        });
        document.getElementById('evo-status').innerHTML = html;
        
        let advice = "ëª¨ë“  ë¶„ì•¼ì˜ ë°ì´í„°ë¥¼ í™•ë³´í•˜ì„¸ìš”.";
        for(let c of cats) {
            const val = Math.max(scores.red[c], scores.blue[c]);
            if(val < 10) { advice = `[ì˜¤ë¼í´ ë¶„ì„]: **${c}** ë¶„ì•¼ê°€ **${10-val}ì ** ë¶€ì¡±í•©ë‹ˆë‹¤! ë‹¤ìŒ ë¼ìš´ë“œì—ì„œ ì´ ë¶„ì•¼ë¥¼ ì§‘ì¤‘ ì ë ¹í•˜ì„¸ìš”.`; break; }
        }
        document.getElementById('ai-message').innerHTML = advice;
    }
</script>
</body>
</html>
