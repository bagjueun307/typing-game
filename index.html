<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA WARFARE</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff1a1a; --blue: #1a75ff; --dark: #050505; --gold: #ffea00; --neon: #00ff41; --gray: #333; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', monospace; margin: 0; overflow: hidden; height: 100vh; transition: background 0.3s; }
        
        /* íŒ€ë³„ ì „ì²´ ë°°ê²½ìƒ‰ ë³€í™” */
        body.bg-red { background-color: rgba(150, 0, 0, 0.95); }
        body.bg-blue { background-color: rgba(0, 50, 150, 0.95); }

        /* ìƒë‹¨ ë ˆì´ì•„ì›ƒ */
        #header { height: 180px; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; border-bottom: 3px solid #fff; }
        #main-timer { font-size: 3.2rem; color: var(--gold); margin: 5px 0; text-shadow: 0 0 10px var(--gold); }
        
        .territory-row { display: flex; gap: 10px; justify-content: center; width: 98%; }
        .sector-card { background: #222; border: 2px solid #555; padding: 8px; width: 170px; text-align: center; border-radius: 8px; position: relative; transition: 0.3s; }
        .sector-card.won-red { border-color: var(--red); box-shadow: 0 0 15px var(--red); background: #400; }
        .sector-card.won-blue { border-color: var(--blue); box-shadow: 0 0 15px var(--blue); background: #002b5e; }
        
        .step-icon { font-size: 1.8rem; margin-bottom: 5px; color: var(--gold); }
        .prog-text { font-size: 0.9rem; color: var(--neon); font-weight: bold; }
        
        /* í•œ ë²ˆì— ëˆ„ë¥´ê¸° ì‰¬ìš´ í° ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ */
        .up-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 234, 0, 0.85); color: #000; border: none; font-family: 'DungGeunMo'; font-size: 1.5rem; font-weight: bold; cursor: pointer; display: none; z-index: 10; border-radius: 6px; }

        /* 10ì´ˆ ì…”í”Œ ë°” */
        #shuffle-container { width: 100%; height: 12px; background: #000; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 1s linear; }

        /* ë‹¨ì–´ ë³´ë“œ (100ê°œ ìŠ¤í¬ë¡¤ ì—†ì´ ì „ì²´ ë…¸ì¶œ) */
        #game-board { height: calc(100vh - 295px); display: grid; grid-template-columns: repeat(10, 10fr); grid-template-rows: repeat(10, 10fr); gap: 3px; padding: 10px; box-sizing: border-box; }
        .card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #fff; transition: 0.15s; font-weight: bold; }
        .card.red { background: var(--red) !important; color: #fff; border: 2px solid #fff; z-index: 1; transform: scale(1.02); }
        .card.blue { background: var(--blue) !important; color: #fff; border: 2px solid #fff; z-index: 1; transform: scale(1.02); }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        #footer { height: 103px; display: flex; align-items: center; background: rgba(0,0,0,0.9); border-top: 3px solid var(--gold); }
        .input-label { padding: 0 20px; color: var(--gold); font-size: 1.2rem; white-space: nowrap; }
        #word-input { width: 100%; height: 100%; background: transparent; border: none; font-size: 4rem; text-align: center; color: #fff; font-family: 'DungGeunMo'; outline: none; }

        /* íŠ¹ìˆ˜ ì´ë²¤íŠ¸ */
        #bonus-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--gold); color: #000; padding: 25px 50px; font-size: 3.5rem; z-index: 1000; display: none; border: 8px double #000; box-shadow: 0 0 50px #000; }
        #surveillance { position: fixed; inset: 0; background: rgba(255,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; font-size: 5rem; color: #fff; text-shadow: 0 0 20px #000; }

        /* íŒì—… UI */
        #lobby, #result-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-start { padding: 20px 60px; font-size: 2.5rem; background: var(--gold); font-family: 'DungGeunMo'; cursor: pointer; border: none; border-radius: 10px; margin: 10px; }

        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body id="main-body">

<div id="lobby">
    <h1 style="font-size: 4rem; color: var(--gold); margin-bottom: 30px;">NATION BUILDER: MAFIA</h1>
    <button class="btn-start" onclick="GAME.requestStart()">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
</div>

<div id="header">
    <div id="main-timer">02:00</div>
    <div class="territory-row" id="territory-row"></div>
</div>
<div id="shuffle-container"><div id="shuffle-bar"></div></div>

<div id="game-board"></div>

<div id="footer">
    <div class="input-label">COMMAND ></div>
    <input type="text" id="word-input" autocomplete="off" disabled placeholder="ëŒ€ê¸° ì¤‘...">
</div>

<div id="bonus-msg">!! ë³´ë„ˆìŠ¤ !!<br><span id="bonus-word"></span></div>
<div id="surveillance">ğŸš¨ ê°ì‹œ ëª¨ë“œ ğŸš¨<br>ì…ë ¥ ì¤‘ì§€!</div>

<div id="result-screen" style="display:none;">
    <h1 style="font-size: 3.5rem; color: var(--gold); margin-bottom: 20px;">ROUND ê²°ê³¼ ë¶„ì„</h1>
    <div id="result-content" style="display:flex; gap:20px; margin-bottom:30px;"></div>
    <div style="display:flex;">
        <button class="btn-start" style="font-size:1.5rem; background:#444; color:#fff;" onclick="GAME.closeResult()">ê²°ê³¼ ì°½ ë‹«ê¸°</button>
        <button class="btn-start" style="font-size:1.5rem; background:var(--neon);" onclick="GAME.requestStart()">ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</button>
    </div>
</div>

<script>
// --- ë°ì´í„° ë° ì„¤ì • ---
const CONFIG = {
    sectors: ['ì—ë„ˆì§€', 'ì¸í”„ë¼', 'ìë³¸', 'ê¸°ìˆ ', 'ë¬¸í™”'],
    levels: ['ê³µí„°', 'ë§ˆì„', 'ë„ì‹œ', 'ê°œë°œë„ìƒêµ­', 'ì„ ì§„êµ­'],
    icons: ['fa-seedling', 'fa-home', 'fa-city', 'fa-industry', 'fa-crown'],
    wordPool: {
        'ì—ë„ˆì§€': ['ì„ìœ ','ì „ê¸°','ì›ìë ¥','íƒœì–‘ê´‘','ë°°í„°ë¦¬','ì„íƒ„','ê°€ìŠ¤','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ì†¡ì „','ì „ì••','ë°œì „','íƒ„ì†Œ','ì—°ë£Œ','ê·¸ë¦¬ë“œ','ë³€ì „','ì—”ì§„','ì¶©ì „','ì—ë„ˆì§€'],
        'ì¸í”„ë¼': ['ë„ë¡œ','ì² ë„','í•­ë§Œ','ê³µí•­','êµëŸ‰','í„°ë„','ë¹Œë”©','ê°•ì² ','ì‹œë©˜íŠ¸','í¬ë ˆì¸','ìƒìˆ˜ë„','ê±´ì„¤','ë¬¼ë¥˜','ìœ í†µ','ì„¤ê³„','ë„ì‹œ','í†µì‹ ','ë²½ëŒ','ì¤‘ì¥ë¹„','ì •ë¹„'],
        'ìë³¸': ['ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ì€í–‰','ê¸ˆë¦¬','í™˜ìœ¨','ì„¸ê¸ˆ','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','í€ë“œ','ê²½ì œ','í™”í','ë¹„ìš©','ìì‚°','ë¬´ì—­','ì½”ì¸','ë°°ë‹¹','ì¦ì‹œ','ë¶€ì±„'],
        'ê¸°ìˆ ': ['AI','ë¡œë´‡','ì½”ë”©','ë³´ì•ˆ','ì„œë²„','ë°˜ë„ì²´','ë°ì´í„°','ì–‘ì','í•´í‚¹','ë“œë¡ ','ìœ„ì„±','ì„¼ì„œ','ë°±ì‹ ','ëª¨ë°”ì¼','ì¹©','ì†ŒìŠ¤','íšŒë¡œ','ë¨¸ì‹ ','ì¸í„°ë„·','ì›¹'],
        'ë¬¸í™”': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ','ì–¸ì–´','ì‹¬ë¦¬','ë¯¸ë””ì–´','ì˜ˆìˆ ','ì˜í™”','ìŒì•…','ì¶•ì œ','ìœ ì‚°','í•œê¸€','ì¢…êµ','ì „í†µ','ì •ì‹ ']
    }
};

// --- Firebase ì—°ê²° (ì œê³µëœ ê²½ë¡œ í™œìš©) ---
const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_warfare_v5');

const GAME = {
    team: 'red',
    slot: 'm' + (new URLSearchParams(window.location.search).get('m') || '1'),
    active: false,
    usedWords: new Set(),

    init() {
        this.renderInitialSectors();
        this.listenFirebase();
        this.bindEvents();
    },

    renderInitialSectors() {
        const row = document.getElementById('territory-row');
        row.innerHTML = CONFIG.sectors.map((s, i) => `
            <div class="sector-card" id="sector-${i}">
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE!</button>
                <i class="fas ${CONFIG.icons[0]} step-icon" id="icon-${i}"></i>
                <div style="font-size:0.7rem; color:#888;">${CONFIG.levels[0]}</div>
                <div style="font-weight:bold; margin:3px 0;">${s}</div>
                <div class="prog-text" id="prog-${i}">0 / 5</div>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDB();
            this.sync(data);
        });
    },

    resetDB() {
        const words = this.generateNewWords();
        db.set({
            state: 'READY', timer: 120, shuffle: 10,
            words: words, cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1:'red', m2:'red', m3:'blue', m4:'blue' },
            bonus: "", surveillance: false, round: 1
        });
    },

    generateNewWords() {
        // ëª¨ë“  ë‹¨ì–´ í’€ì—ì„œ ëœë¤í•˜ê²Œ ì„ì–´ì„œ 100ê°œ ì¶”ì¶œ (ì‹¤ì œë¡œëŠ” ê° ë¶„ì•¼ 20ê°œì”© 100ê°œ)
        return Object.values(CONFIG.wordPool).flat().sort(() => Math.random() - 0.5);
    },

    sync(data) {
        // 1. ìƒíƒœ ë° ë°°ê²½ìƒ‰ ë™ê¸°í™”
        document.getElementById('lobby').style.display = (data.state === 'READY') ? 'flex' : 'none';
        document.getElementById('result-screen').style.display = (data.state === 'FINISHED') ? 'flex' : 'none';
        
        this.team = data.teams[this.slot];
        document.body.className = (this.team === 'red') ? 'bg-red' : 'bg-blue';
        document.getElementById('word-input').disabled = (data.state !== 'RUNNING');

        // 2. ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ & ì…”í”Œë°”
        document.getElementById('main-timer').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffle / 10) * 100 + "%";

        // 3. ë‹¨ì–´ ë³´ë“œ (ì‹¤ì‹œê°„ ì¹´ë“œ ì†Œìœ ê¶Œ ë°˜ì˜)
        const board = document.getElementById('game-board');
        if(board.childElementCount === 0 || data.timer === 120) { // ë¼ìš´ë“œ ì‹œì‘ ì‹œ ìƒˆë¡œ ê·¸ë¦¼
            board.innerHTML = data.words.map(w => `<div class="card" id="card-${w}">${w}</div>`).join('');
        }
        
        const myResourceCounts = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, owner]) => {
            const el = document.getElementById(`card-${word}`);
            if(el) {
                el.className = `card ${owner}`;
            }
            if(owner === this.team) {
                const sIdx = this.getSectorIdx(word);
                if(sIdx !== -1) myResourceCounts[sIdx]++;
            }
        });

        // 4. ìƒë‹¨ ì˜í†  ë‹¨ê³„/ì•„ì´ì½˜ ë™ê¸°í™”
        CONFIG.sectors.forEach((_, i) => {
            const rLv = data.levels.red[i], bLv = data.levels.blue[i], myLv = data.levels[this.team][i];
            const sectorEl = document.getElementById(`sector-${i}`);
            
            if(rLv === 4) sectorEl.className = "sector-card won-red";
            else if(bLv === 4) sectorEl.className = "sector-card won-blue";
            else sectorEl.className = "sector-card";

            const currentMax = Math.max(rLv, bLv);
            document.getElementById(`icon-${i}`).className = `fas ${CONFIG.icons[currentMax]} step-icon`;
            document.getElementById(`prog-${i}`).innerText = `${myResourceCounts[i]} / 5 (ë‚´ë‹¨ê³„: ${CONFIG.levels[myLv]})`;
            
            // ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ ë…¸ì¶œ ì¡°ê±´
            const upBtn = document.getElementById(`up-btn-${i}`);
            const isSectorTaken = (rLv === 4 || bLv === 4);
            upBtn.style.display = (myResourceCounts[i] >= 5 && myLv < 4 && !isSectorTaken) ? 'block' : 'none';
        });

        // 5. ì´ë²¤íŠ¸ íš¨ê³¼
        document.getElementById('bonus-msg').style.display = data.bonus ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonus;
        document.getElementById('surveillance').style.display = data.surveillance ? 'flex' : 'none';

        // 6. ê²°ê³¼ í™”ë©´ ë°ì´í„°
        if(data.state === 'FINISHED') {
            document.getElementById('result-content').innerHTML = ['red','blue'].map(t => `
                <div style="background:#000; padding:20px; border:4px solid var(--${t}); min-width:200px;">
                    <h2 style="color:var(--${t}); font-size:2rem;">${t.toUpperCase()} MAFIA</h2>
                    ${CONFIG.sectors.map((s,i)=>`<div>${s}: ${CONFIG.levels[data.levels[t][i]]} <i class="fas ${CONFIG.icons[data.levels[t][i]]}"></i></div>`).join('')}
                </div>
            `).join('');
        }

        // 7. ë§ˆìŠ¤í„° ëª¨ë‹ˆí„°(m1) íƒ€ì´ë¨¸ ë¡œì§
        if(this.slot === 'm1' && data.state === 'RUNNING' && !this.active) {
            this.active = true;
            this.runMasterTimer();
        }
    },

    runMasterTimer() {
        let bTick = 20, sTick = 30;
        const tick = setInterval(() => {
            db.once('value', snap => {
                const data = snap.val();
                if(data.state !== 'RUNNING') return clearInterval(tick);

                let updates = { timer: data.timer - 1, shuffle: data.shuffle - 1 };
                bTick--; sTick--;

                // 10ì´ˆ ì…”í”Œ
                if(updates.shuffle <= 0) {
                    updates.shuffle = 10;
                    const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                    updates.teams = { m1:ts[0], m2:ts[1], m3:ts[2], m4:ts[3] };
                }
                // 20ì´ˆ ë³´ë„ˆìŠ¤
                if(bTick <= 0) {
                    bTick = 20;
                    const allWords = Object.values(CONFIG.wordPool).flat();
                    updates.bonus = allWords[Math.floor(Math.random()*allWords.length)];
                }
                // 30ì´ˆ ê°ì‹œ (2ì´ˆê°„)
                if(sTick <= 0) {
                    sTick = 30;
                    db.update({ surveillance: true });
                    setTimeout(() => db.update({ surveillance: false }), 2000);
                }

                if(updates.timer <= 0) updates.state = 'FINISHED';
                db.update(updates);
            });
        }, 1000);
    },

    requestStart() {
        // ìƒˆ ë¼ìš´ë“œ ì‹œ ë‹¨ì–´ êµì²´ (ì¤‘ë³µ ë°©ì§€)
        const newWords = this.generateNewWords();
        db.update({ 
            state: 'RUNNING', timer: 120, shuffle: 10, 
            words: newWords, cards: {}, bonus: "", surveillance: false 
        });
    },

    closeResult() { document.getElementById('result-screen').style.display = 'none'; },

    bindEvents() {
        const input = document.getElementById('word-input');
        input.onkeydown = (e) => {
            if(e.key === 'Enter') {
                const val = input.value.trim();
                db.once('value', snap => {
                    const data = snap.val();
                    if(data.surveillance) { // ê°ì‹œ íŒ¨ë„í‹°
                        const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team);
                        if(mine.length > 0) db.child('cards').child(mine[0]).remove();
                    } else if(val === data.bonus) { // ë³´ë„ˆìŠ¤ ì—­ì „
                        const enemy = (this.team === 'red') ? 'blue' : 'red';
                        const eCards = Object.keys(data.cards||{}).filter(w => data.cards[w] === enemy);
                        eCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                        db.update({ bonus: "" });
                    } else if(data.words.includes(val)) { // ì¼ë°˜ ì ë ¹
                        db.child('cards').child(val).set(this.team);
                    }
                });
                input.value = "";
            }
        };
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const sectorWords = CONFIG.wordPool[CONFIG.sectors[idx]];
            const mine = Object.keys(data.cards||{}).filter(w => data.cards[w] === this.team && sectorWords.includes(w));
            
            if(mine.length >= 5) {
                // ë‹¨ì–´ ì†Œëª¨
                mine.slice(0,5).forEach(w => db.child('cards').child(w).remove());
                const lvs = data.levels[this.team];
                lvs[idx]++;
                db.child('levels').child(this.team).set(lvs);
                
                // ìŠ¹ë¦¬ íŒì •
                if(lvs.filter(v => v === 4).length >= 3) db.update({ state: 'FINISHED' });
            }
        });
    },

    getSectorIdx(w) { return Object.values(CONFIG.wordPool).findIndex(l => l.includes(w)); },
    formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
};

GAME.init();
</script>
</body>
</html>
