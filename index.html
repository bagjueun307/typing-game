<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆí”¼ì•„ ì˜í†  ëŒ€ì „ (4-Monitor System)</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --red-team: #ff4d4d;
            --blue-team: #4d94ff;
            --neutral: #333;
            --gold: #f1c40f;
        }

        body, html { margin: 0; padding: 0; background: #000; color: white; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; height: 100%; }

        /* ëª¨ë‹ˆí„° ì„ íƒê¸° (ë§í¬ ì ‘ì† ì‹œ ì²« í™”ë©´) */
        #monitor-selector {
            display: flex; flex-wrap: wrap; height: 100vh; width: 100vw; background: #111;
        }
        .monitor-preview {
            width: 50%; height: 50%; border: 2px solid #444; box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .monitor-preview:hover { background: #222; border-color: var(--gold); }

        /* ë©”ì¸ ê²Œì„ UI */
        #game-ui { display: none; height: 100vh; width: 100vw; flex-direction: column; }

        /* ìƒë‹¨: ìì› ë° ë°œì „ í˜„í™© (ì˜¤ê°í˜• 5ì¡°ê°) */
        .top-status {
            display: flex; justify-content: space-around; background: rgba(0,0,0,0.8);
            padding: 10px; height: 120px; border-bottom: 2px solid #555;
        }
        .sector {
            text-align: center; width: 18%; position: relative;
            padding: 5px; border-radius: 10px; background: #222;
        }
        .sector-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .progress-container { background: #444; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; transition: 0.3s; }
        .level-text { font-size: 0.8rem; font-weight: bold; margin-top: 5px; color: var(--gold); }
        .upgrade-btn {
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; border: none; padding: 2px 10px;
            font-weight: bold; border-radius: 5px; cursor: pointer; display: none;
            z-index: 100;
        }

        /* ì¤‘ì•™: ë‹¨ì–´ ì¹´ë“œ ê·¸ë¦¬ë“œ (100ê°œ) */
        .word-grid {
            flex: 1; display: grid; grid-template-columns: repeat(10, 1fr);
            gap: 5px; padding: 10px; overflow: hidden;
        }
        .card {
            background: #333; font-size: 0.8rem; display: flex; align-items: center;
            justify-content: center; border-radius: 3px; font-weight: bold;
            transition: 0.2s; text-align: center;
        }
        .card.red { background: var(--red-team); color: #fff; }
        .card.blue { background: var(--blue-team); color: #fff; }

        /* í•˜ë‹¨: íƒ€ì´ë¨¸, íŒ€ ìœ„ì¹˜ ë°”, ì…ë ¥ì°½ */
        .bottom-controls {
            padding: 15px; background: #222; display: flex; flex-direction: column; align-items: center;
        }
        #swap-bar-container { width: 100%; height: 8px; background: #444; margin-bottom: 10px; border-radius: 4px; }
        #swap-bar { height: 100%; width: 100%; background: #00ff00; transition: width 0.1s linear; }

        .input-area {
            width: 100%; display: flex; justify-content: center; gap: 20px; align-items: center;
        }
        #main-input {
            width: 50%; padding: 15px; font-size: 1.8rem; border-radius: 10px;
            border: 4px solid #555; background: #000; color: #fff; text-align: center;
        }
        #main-input:focus { border-color: var(--gold); outline: none; }

        /* ì•Œë¦¼ ë° íŒì—… */
        #round-overlay, #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: #222; padding: 40px; border-radius: 20px; text-align: center;
            border: 5px solid var(--gold); width: 60%;
        }

        /* ë°°ê²½ìƒ‰ìœ¼ë¡œ íŒ€ í‘œì‹œ */
        .team-bg-red { background-color: rgba(255, 77, 77, 0.4) !important; }
        .team-bg-blue { background-color: rgba(77, 148, 255, 0.4) !important; }

        /* ê°ì‹œ ëª¨ë“œ */
        #surveillance {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            border: 20px solid red; display: none; pointer-events: none;
            z-index: 999; box-sizing: border-box; animation: flash 0.5s infinite;
        }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* ë³´ë„ˆìŠ¤ ë¬¸ì œ */
        #bonus-container {
            position: fixed; bottom: 150px; background: var(--gold); color: #000;
            padding: 10px 20px; border-radius: 10px; font-weight: bold; display: none;
        }
    </style>
</head>
<body>

    <div id="monitor-selector">
        <div class="monitor-preview" onclick="selectMonitor(1)"><h1>ëª¨ë‹ˆí„° 1</h1><p>ë³¸ë¶€ êµ¬ì—­</p></div>
        <div class="monitor-preview" onclick="selectMonitor(2)"><h1>ëª¨ë‹ˆí„° 2</h1><p>ìì› êµ¬ì—­ A</p></div>
        <div class="monitor-preview" onclick="selectMonitor(3)"><h1>ëª¨ë‹ˆí„° 3</h1><p>ìì› êµ¬ì—­ B</p></div>
        <div class="monitor-preview" onclick="selectMonitor(4)"><h1>ëª¨ë‹ˆí„° 4</h1><p>ì „ëµ êµ¬ì—­</p></div>
    </div>

    <div id="start-overlay">
        <div id="countdown" style="font-size: 10rem; color: var(--gold);"></div>
        <button id="start-btn" onclick="requestStart()" style="padding: 20px 50px; font-size: 2rem; border-radius: 10px; cursor: pointer;">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="game-ui">
        <div id="surveillance"></div>

        <div class="top-status">
            <div id="timer" style="position: absolute; top: 0; font-size: 1.5rem; color: var(--gold);">02:00</div>
            <div class="sector" id="sector-energy">
                <div class="sector-icon">ğŸ”‹ ì—ë„ˆì§€</div>
                <div class="progress-container"><div id="prog-energy" class="progress-bar"></div></div>
                <div id="info-energy" class="level-text">ê³µí„° (0/5)</div>
                <button class="upgrade-btn" id="up-energy" onclick="upgrade('energy')">UPGRADE</button>
            </div>
            <div class="sector" id="sector-infra">
                <div class="sector-icon">ğŸ—ï¸ ì¸í”„ë¼</div>
                <div class="progress-container"><div id="prog-infra" class="progress-bar"></div></div>
                <div id="info-infra" class="level-text">ê³µí„° (0/5)</div>
                <button class="upgrade-btn" id="up-infra" onclick="upgrade('infra')">UPGRADE</button>
            </div>
            <div class="sector" id="sector-capital">
                <div class="sector-icon">ğŸ’° ìë³¸</div>
                <div class="progress-container"><div id="prog-capital" class="progress-bar"></div></div>
                <div id="info-capital" class="level-text">ê³µí„° (0/5)</div>
                <button class="upgrade-btn" id="up-capital" onclick="upgrade('capital')">UPGRADE</button>
            </div>
            <div class="sector" id="sector-tech">
                <div class="sector-icon">ğŸ’» ê¸°ìˆ </div>
                <div class="progress-container"><div id="prog-tech" class="progress-bar"></div></div>
                <div id="info-tech" class="level-text">ê³µí„° (0/5)</div>
                <button class="upgrade-btn" id="up-tech" onclick="upgrade('tech')">UPGRADE</button>
            </div>
            <div class="sector" id="sector-culture">
                <div class="sector-icon">ğŸ¨ ë¬¸í™”</div>
                <div class="progress-container"><div id="prog-culture" class="progress-bar"></div></div>
                <div id="info-culture" class="level-text">ê³µí„° (0/5)</div>
                <button class="upgrade-btn" id="up-culture" onclick="upgrade('culture')">UPGRADE</button>
            </div>
        </div>

        <div id="bonus-container">ë³´ë„ˆìŠ¤ ë‹¨ì–´: <span id="bonus-word">???</span></div>

        <div class="word-grid" id="word-grid"></div>

        <div class="bottom-controls">
            <div id="swap-bar-container"><div id="swap-bar"></div></div>
            <div class="input-area">
                <div id="current-team-label" style="font-size: 1.5rem; font-weight: bold;"></div>
                <input type="text" id="main-input" placeholder="ì—¬ê¸°ì— ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!">
            </div>
        </div>
    </div>

    <div id="round-overlay">
        <div class="modal">
            <h1 id="result-title">ë¼ìš´ë“œ ì¢…ë£Œ</h1>
            <div id="result-stats" style="display: flex; justify-content: space-around; font-size: 1.2rem;"></div>
            <button id="close-result" style="margin-top: 30px; padding: 10px 30px;">ê²°ê³¼ì°½ ë‹«ê¸°</button>
            <button id="continue-game" style="display:none; margin-top: 20px; padding: 10px 30px; background: var(--gold);">ê²Œì„ ì´ì–´ì„œ í•˜ê¸°</button>
        </div>
    </div>

    <script>
        // --- Firebase ì„¤ì • (ë°˜ë“œì‹œ ë³¸ì¸ì˜ ì •ë³´ë¡œ êµì²´í•˜ì„¸ìš”) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- ê²Œì„ ì„¤ì • ë° ë³€ìˆ˜ ---
        let currentMonitor = 0;
        let myTeam = ""; // red or blue
        let isGameRunning = false;
        let isSurveillance = false;
        const sectors = ["energy", "infra", "capital", "tech", "culture"];
        const levels = ["ê³µí„°", "ë§ˆì„", "ë„ì‹œ", "ê°œë°œë„ìƒêµ­", "ì„ ì§„êµ­"];
        const sectorWords = {
            energy: ["íƒœì–‘ê´‘", "í’ë ¥", "ì„ìœ ", "ì›ìë ¥", "ê°€ìŠ¤", "ì „ê¸°", "ë°°í„°ë¦¬", "ì¡°ë ¥"],
            infra: ["ë„ë¡œ", "ë‹¤ë¦¬", "ì² ë„", "í•­êµ¬", "ê³µí•­", "ë¹Œë”©", "í„°ë„", "ëŒ"],
            capital: ["ì€í–‰", "ì£¼ì‹", "íˆ¬ì", "í˜„ê¸ˆ", "ê¸ˆê¶Œ", "ì‹œì¥", "í™”í", "í€ë“œ"],
            tech: ["AI", "ë‚˜ë…¸", "ì–‘ì", "ë¡œë´‡", "ì½”ë”©", "ë°˜ë„ì²´", "í†µì‹ ", "ìš°ì£¼"],
            culture: ["ì˜í™”", "ìŒì•…", "ë¯¸ìˆ ", "ì¶•ì œ", "ê´€ê´‘", "ì „í†µ", "ì˜ˆìˆ ", "KíŒ"]
        };
        const allNormalWords = ["ì‚¬ê³¼", "ë°”ë‚˜ë‚˜", "í˜¸ë‘ì´", "ë…ìˆ˜ë¦¬", "ì»´í“¨í„°", "ë§ˆìš°ìŠ¤", "ì±…ìƒ", "ì˜ì", "ìŠ¤ë§ˆíŠ¸í°", "ìš´ë™ì¥", "ì¶•êµ¬", "ì•¼êµ¬", "ê¸°ì°¨", "ë¹„í–‰ê¸°", "ìš°ì£¼ì„ ", "ë°”ë‹¤", "ì‚°ë§¥", "ë“¤íŒ", "í¬ë„", "ë”¸ê¸°", "ìˆ˜ë°•", "ì˜¤ì´", "ë‹¹ê·¼", "ë°°ì¶”", "ì‹œê¸ˆì¹˜", "ì§€ìš°ê°œ", "ì—°í•„", "í•™êµ", "ì¹ íŒ", "êµê³¼ì„œ"];

        // --- ì´ˆê¸° ë¡œì§ ---
        function selectMonitor(id) {
            currentMonitor = id;
            document.getElementById('monitor-selector').style.display = 'none';
            document.getElementById('start-overlay').style.display = 'flex';
        }

        function requestStart() {
            db.ref('gameState/control').set({ command: 'start', time: Date.now() });
        }

        // --- ì‹¤ì‹œê°„ ê°ì‹œ (Firebase) ---
        db.ref('gameState/control').on('value', (snap) => {
            const data = snap.val();
            if (data?.command === 'start') startCountdown();
            if (data?.command === 'continue') startCountdown();
        });

        db.ref('gameState/data').on('value', (snap) => {
            const data = snap.val();
            if (data) updateUI(data);
        });

        // --- ê²Œì„ ì—”ì§„ ---
        function startCountdown() {
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('round-overlay').style.display = 'none';
            let count = 3;
            const cdDiv = document.getElementById('countdown');
            const timer = setInterval(() => {
                cdDiv.innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    document.getElementById('start-overlay').style.display = 'none';
                    document.getElementById('game-ui').style.display = 'flex';
                    if (currentMonitor === 1) initNewRound(); // ëª¨ë‹ˆí„° 1ì´ ë°ì´í„° ì´ˆê¸°í™” ë‹´ë‹¹
                    gameLoop();
                }
                count--;
            }, 1000);
        }

        function initNewRound() {
            // ë‹¨ì–´ 100ê°œ ë¬´ì‘ìœ„ ìƒì„± (ì¤‘ë³µ ë°©ì§€ìš© ë¡œì§ í¬í•¨ ê°€ëŠ¥)
            let roundWords = [];
            sectors.forEach(s => roundWords.push(...sectorWords[s]));
            while(roundWords.length < 100) {
                let w = allNormalWords[Math.floor(Math.random() * allNormalWords.length)] + Math.floor(Math.random()*1000);
                if(!roundWords.includes(w)) roundWords.push(w);
            }
            roundWords = roundWords.sort(() => Math.random() - 0.5);

            const initialData = {
                words: roundWords.reduce((acc, w) => { acc[w] = "none"; return acc; }, {}),
                timer: 120,
                swapTimer: 10,
                teams: { 1: "red", 2: "blue", 3: "red", 4: "blue" }, // ì´ˆê¸° ëœë¤ ìœ„ì¹˜
                sectors: {
                    red: { energy: {lvl:0, cnt:0}, infra: {lvl:0, cnt:0}, capital: {lvl:0, cnt:0}, tech: {lvl:0, cnt:0}, culture: {lvl:0, cnt:0} },
                    blue: { energy: {lvl:0, cnt:0}, infra: {lvl:0, cnt:0}, capital: {lvl:0, cnt:0}, tech: {lvl:0, cnt:0}, culture: {lvl:0, cnt:0} }
                },
                isFixed: { energy: "none", infra: "none", capital: "none", tech: "none", culture: "none" }
            };
            db.ref('gameState/data').set(initialData);
        }

        function gameLoop() {
            isGameRunning = true;
            document.getElementById('main-input').focus();
            
            // ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ ëºê¹€ ë°©ì§€
            window.addEventListener('keydown', () => document.getElementById('main-input').focus());

            if (currentMonitor === 1) {
                const interval = setInterval(() => {
                    db.ref('gameState/data').transaction(data => {
                        if (!data) return data;
                        data.timer -= 1;
                        data.swapTimer -= 1;
                        
                        if (data.swapTimer <= 0) {
                            const teamArr = ["red", "red", "blue", "blue"].sort(() => Math.random() - 0.5);
                            data.teams = { 1: teamArr[0], 2: teamArr[1], 3: teamArr[2], 4: teamArr[3] };
                            data.swapTimer = 10;
                        }

                        // ê°ì‹œ ëª¨ë“œ (30ì´ˆë§ˆë‹¤ 2ì´ˆê°„)
                        if (data.timer % 30 === 0 && data.timer !== 120) isSurveillance = true;

                        if (data.timer <= 0) {
                            clearInterval(interval);
                            isGameRunning = false;
                        }
                        return data;
                    });
                }, 1000);
            }
        }

        // --- ì…ë ¥ ì²˜ë¦¬ ---
        document.getElementById('main-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const word = e.target.value.trim();
                e.target.value = "";
                if (!word || !isGameRunning) return;

                // ê°ì‹œ ëª¨ë“œ íŒ¨ë„í‹° ì²´í¬
                if (isSurveillance) {
                    penalty();
                    return;
                }

                db.ref('gameState/data').transaction(data => {
                    if (!data) return data;
                    if (data.words[word] && data.words[word] === "none") {
                        data.words[word] = myTeam;
                        // ì„¹ì…˜ë³„ ë‹¨ì–´ ì¹´ìš´íŠ¸ ì¦ê°€
                        for (let s of sectors) {
                            if (sectorWords[s].includes(word)) {
                                data.sectors[myTeam][s].cnt += 1;
                            }
                        }
                    }
                    return data;
                });
            }
        });

        function penalty() {
            db.ref('gameState/data').transaction(data => {
                if (!data) return data;
                let count = 0;
                for (let w in data.words) {
                    if (data.words[w] === myTeam) {
                        data.words[w] = "none";
                        count++;
                        if (count >= 2) break;
                    }
                }
                return data;
            });
        }

        function upgrade(sector) {
            db.ref('gameState/data').transaction(data => {
                if (!data) return data;
                const sData = data.sectors[myTeam][sector];
                if (sData.cnt >= 5 && sData.lvl < 4) {
                    sData.lvl += 1;
                    sData.cnt -= 5;
                    if (sData.lvl === 4 && data.isFixed[sector] === "none") {
                        data.isFixed[sector] = myTeam;
                    }
                }
                return data;
            });
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function updateUI(data) {
            myTeam = data.teams[currentMonitor];
            document.body.className = myTeam === "red" ? "team-bg-red" : "team-bg-blue";
            document.getElementById('current-team-label').innerText = myTeam.toUpperCase() + " TEAM";
            
            // íƒ€ì´ë¨¸
            const m = Math.floor(data.timer / 60);
            const s = data.timer % 60;
            document.getElementById('timer').innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            
            // ìŠ¤ì™‘ ë°”
            document.getElementById('swap-bar').style.width = (data.swapTimer / 10) * 100 + "%";

            // ìƒë‹¨ ì„¹ì…˜ í˜„í™©
            sectors.forEach(s => {
                const sData = data.sectors[myTeam][s];
                const fixed = data.isFixed[s];
                const prog = document.getElementById(`prog-${s}`);
                const info = document.getElementById(`info-${s}`);
                const btn = document.getElementById(`up-${s}`);

                prog.style.width = (sData.cnt / 5) * 100 + "%";
                prog.style.backgroundColor = fixed !== "none" ? (fixed === "red" ? "var(--red-team)" : "var(--blue-team)") : "var(--gold)";
                
                info.innerText = `${levels[sData.lvl]} (${sData.cnt}/5)`;
                btn.style.display = sData.cnt >= 5 && sData.lvl < 4 ? "block" : "none";
                
                if (fixed !== "none") info.innerText = `[ì ë ¹ì™„ë£Œ] ${fixed.toUpperCase()}`;
            });

            // ì¹´ë“œ ê·¸ë¦¬ë“œ
            const grid = document.getElementById('word-grid');
            grid.innerHTML = "";
            for (let w in data.words) {
                const card = document.createElement('div');
                card.className = `card ${data.words[w]}`;
                card.innerText = w;
                grid.appendChild(card);
            }

            // ë¼ìš´ë“œ ì¢…ë£Œ
            if (data.timer <= 0) showResult(data);
        }

        function showResult(data) {
            const overlay = document.getElementById('round-overlay');
            const stats = document.getElementById('result-stats');
            overlay.style.display = 'flex';
            
            let redFixed = 0, blueFixed = 0;
            sectors.forEach(s => {
                if(data.isFixed[s] === "red") redFixed++;
                if(data.isFixed[s] === "blue") blueFixed++;
            });

            stats.innerHTML = `
                <div style="color:var(--red-team)">RED ì ë ¹ì§€: ${redFixed}</div>
                <div style="color:var(--blue-team)">BLUE ì ë ¹ì§€: ${blueFixed}</div>
            `;

            document.getElementById('close-result').onclick = () => {
                document.getElementById('close-result').style.display = 'none';
                document.getElementById('continue-game').style.display = 'block';
            };

            document.getElementById('continue-game').onclick = () => {
                db.ref('gameState/control').set({ command: 'continue', time: Date.now() });
            };
        }
    </script>
</body>
</html>
