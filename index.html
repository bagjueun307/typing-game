<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>타자 배틀 V72 - 10초 랜덤 셔플전</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff4757; --blue: #2e86de; --yellow: #feca57; --dark: #1e272e; --bg: #f1f2f6; }
        body { background: var(--bg); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 80px; background: #fff; border-bottom: 6px solid var(--dark); display: flex; justify-content: space-around; align-items: center; z-index: 2000; color: var(--dark); }
        #shuffle-timer { position: fixed; top: 80px; left: 0; width: 100%; height: 10px; background: #ccc; z-index: 1900; }
        #shuffle-bar { height: 100%; background: var(--yellow); width: 100%; transition: width 0.1s linear; }

        #timer-disp { font-size: 2.2rem; background: var(--dark); color: #fff; padding: 5px 20px; border-radius: 10px; }
        .score-box { font-size: 1.8rem; font-weight: bold; }

        #room-view { display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 100vw; height: 100vh; gap: 15px; padding: 110px 20px 20px; box-sizing: border-box; }
        .monitor { border: 10px solid var(--dark); display: flex; flex-direction: column; position: relative; background: #777; overflow: hidden; transition: 0.5s; }
        
        /* 팀 색상에 따른 모니터 강조 */
        .mon-red { border-color: var(--red) !important; box-shadow: inset 0 0 50px rgba(255, 71, 87, 0.3); }
        .mon-blue { border-color: var(--blue) !important; box-shadow: inset 0 0 50px rgba(46, 134, 222, 0.3); }
        .monitor.focused { position: fixed !important; inset: 110px 20px 20px 20px; z-index: 1500; border-width: 15px; }

        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; flex: 1; padding: 10px; pointer-events: none; background: #444; }
        .cell { background: #eee; border-radius: 4px; transition: 0.3s; }
        .cell.red { background: var(--red); border: 2px solid #fff; }
        .cell.blue { background: var(--blue); border: 2px solid #fff; }

        .quiz-panel { background: #000; color: #00ff00; text-align: center; padding: 15px; border-top: 6px solid var(--dark); }
        .quiz-chosung { font-size: 3rem; letter-spacing: 15px; margin-bottom: 5px; }
        .quiz-hint { font-size: 1.3rem; color: var(--yellow); }

        .input-box { width: 100%; padding: 20px; font-family: 'DungGeunMo'; font-size: 2.5rem; border: none; border-top: 6px solid var(--dark); text-align: center; }
        #countdown { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; font-size: 10rem; color: var(--yellow); }
    </style>
</head>
<body id="main-body">

<div id="top-bar">
    <div class="score-box" style="color:var(--red)">RED TOTAL: <span id="total-red">0</span></div>
    <div id="timer-disp">60.0s</div>
    <div class="score-box" style="color:var(--blue)">BLUE TOTAL: <span id="total-blue">0</span></div>
</div>
<div id="shuffle-timer"><div id="shuffle-bar"></div></div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div id="team-tag-${i}" style="text-align:center; padding:5px; background:#fff; color:#000; font-weight:bold; font-size:1.2rem;">팀 배정 중...</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="quiz-panel">
                        <div class="quiz-chosung" id="qs-${i}">??</div>
                        <div class="quiz-hint" id="qh-${i}">대기</div>
                    </div>
                    <input type="text" id="input-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="입력불가" disabled>
                    <button id="start-btn-${i}" onclick="requestStart(event)" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px 40px; font-size:2rem; font-family:'DungGeunMo'; background:var(--yellow); cursor:pointer;">게임 시작</button>
                </div>
            `);
        }
    </script>
</div>

<div id="countdown">3</div>

<script>
    const quizData = [
        {a: "사과", h: "빨갛고 맛있는 과일"}, {a: "안경", h: "눈이 나쁠 때 쓰는 물건"}, {a: "우산", h: "비가 올 때 쓰는 물건"},
        {a: "연필", h: "글씨를 쓸 때 쓰는 도구"}, {a: "거울", h: "얼굴을 비추어 보는 유리"}, {a: "비누", h: "손을 씻을 때 쓰는 것"},
        {a: "치약", h: "이를 닦을 때 짜는 것"}, {a: "수건", h: "몸의 물기를 닦는 천"}, {a: "가위", h: "종이를 자를 때 쓰는 도구"},
        {a: "축구", h: "발로 공을 차는 운동"}, {a: "기차", h: "철길 위를 달리는 교통수단"}, {a: "시계", h: "시간을 알려주는 물건"}
    ];

    function getChosung(str) {
        const cho = ["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
        let res = "";
        for(let i=0; i<str.length; i++) {
            const code = str.charCodeAt(i) - 44032;
            if(code >= 0) res += cho[Math.floor(code/588)];
        }
        return res;
    }

    const db = firebase.database().ref('game_visual_v72');
    let currentQuizIdx = -1, hasStarted = false;
    let myTeamInfo = { 1: '', 2: '', 3: '', 4: '' }; // 현재 각 모니터의 팀 상태

    function requestStart(e) { e.stopPropagation(); db.update({ state: 'START' }); }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !hasStarted) startCountDown();
        
        // 퀴즈 업데이트
        if(d.quizIdx !== currentQuizIdx && d.quizIdx >= 0) {
            currentQuizIdx = d.quizIdx;
            const q = quizData[currentQuizIdx];
            for(let i=1; i<=4; i++) {
                document.getElementById(`qs-${i}`).innerText = getChosung(q.a);
                document.getElementById(`qh-${i}`).innerText = q.h;
            }
        }

        // 팀 셔플 정보 업데이트
        if(d.teams) {
            myTeamInfo = d.teams;
            for(let i=1; i<=4; i++) {
                const team = d.teams[i];
                const mon = document.getElementById(`mon-${i}`);
                const tag = document.getElementById(`team-tag-${i}`);
                const inp = document.getElementById(`input-${i}`);
                
                mon.className = `monitor mon-${team} ${mon.classList.contains('focused')?'focused':''}`;
                tag.innerText = `${team.toUpperCase()} TEAM`;
                tag.style.background = team === 'red' ? 'var(--red)' : 'var(--blue)';
                tag.style.color = '#fff';
                
                if(hasStarted) {
                    inp.disabled = false;
                    inp.placeholder = "정답 입력!";
                }
            }
        }

        // 보드 업데이트
        const cards = d.cards || {};
        for(let i=1; i<=4; i++) {
            for(let j=0; j<40; j++) {
                document.getElementById(`cell-${i}-${j}`).className = 'cell ' + (cards[j] ? cards[j].team : '');
            }
        }

        let rCnt = 0, bCnt = 0;
        Object.values(cards).forEach(v => { if(v.team === 'red') rCnt++; if(v.team === 'blue') bCnt++; });
        document.getElementById('total-red').innerText = rCnt;
        document.getElementById('total-blue').innerText = bCnt;
    });

    function startCountDown() {
        document.getElementById('countdown').style.display = 'flex';
        let count = 3;
        let itv = setInterval(() => {
            count--;
            document.getElementById('countdown').innerText = count > 0 ? count : "GO!";
            if(count < 0) {
                clearInterval(itv); document.getElementById('countdown').style.display = 'none';
                hasStarted = true;
                document.getElementById('room-view').style.display = 'grid';
                initBoard(); shuffleTeams(); nextQuiz(); gameLoop();
            }
        }, 1000);
    }

    function initBoard() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`); b.innerHTML = "";
            for(let j=0; j<40; j++) {
                const c = document.createElement('div'); c.className = 'cell'; c.id = `cell-${i}-${j}`;
                b.appendChild(c);
            }
        }
    }

    function shuffleTeams() {
        const teams = ['red', 'red', 'blue', 'blue'].sort(() => Math.random() - 0.5);
        const teamMap = {};
        teams.forEach((t, i) => teamMap[i+1] = t);
        db.update({ teams: teamMap });
    }

    function nextQuiz() {
        db.update({ quizIdx: Math.floor(Math.random() * quizData.length) });
    }

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(val === quizData[currentQuizIdx].a) {
                occupyCell(myTeamInfo[id]); // 현재 내 화면의 팀 색깔로 점령
                nextQuiz();
            }
            e.target.value = '';
        }
    }

    function occupyCell(team) {
        const enemy = team === 'red' ? 'blue' : 'red';
        db.child('cards').once('value', snap => {
            const cards = snap.val() || {};
            let enemyCells = [], emptyCells = [];
            for(let i=0; i<40; i++) {
                if(cards[i]?.team === enemy) enemyCells.push(i);
                else if(!cards[i]) emptyCells.push(i);
            }
            let target = enemyCells.length > 0 ? enemyCells[Math.floor(Math.random()*enemyCells.length)] : emptyCells[Math.floor(Math.random()*emptyCells.length)];
            if(target !== undefined) db.child('cards').child(target).set({ team: team });
        });
    }

    function gameLoop() {
        let totalTime = 600;
        const timer = setInterval(() => {
            if(totalTime > 0) {
                totalTime--;
                document.getElementById('timer-disp').innerText = (totalTime/10).toFixed(1) + "s";
                
                // 셔플 타이머 바 업데이트 (10초 주기)
                const shuffleProgress = (totalTime % 100) / 100;
                document.getElementById('shuffle-bar').style.width = (shuffleProgress * 100) + "%";

                if(totalTime % 100 === 0) shuffleTeams(); // 10초마다 팀 랜덤 셔플
            } else { clearInterval(timer); location.reload(); }
        }, 100);
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`start-btn-${id}`).style.display = 'none';
        setTimeout(() => document.getElementById(`input-${id}`).focus(), 100);
    }
</script>
</body>
</html>
