<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER - MAFIA WARFARE</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --red: #ff3b3b; --blue: #3b82ff; --dark: #0a0a0a; --neon: #00ff41; --gold: #ffd700; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ */
        #header { height: 120px; border-bottom: 3px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        #timer-box { font-size: 3rem; color: var(--gold); }
        #shuffle-bar-container { width: 100%; height: 10px; background: #222; }
        #shuffle-bar { width: 100%; height: 100%; background: var(--neon); transition: width 0.1s linear; }

        /* ì˜í†  ìƒíƒœì°½ */
        .territory-grid { display: flex; gap: 15px; margin-top: 10px; }
        .sector-status { background: #1a1a1a; padding: 10px; border: 1px solid #444; border-radius: 5px; text-align: center; min-width: 110px; position: relative; }
        .level-text { font-size: 0.8rem; display: block; margin-bottom: 5px; }
        .count-badge { background: var(--neon); color: #000; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; position: absolute; top: -5px; right: -5px; }
        .up-btn { background: var(--gold); border: none; padding: 3px 10px; cursor: pointer; font-family: 'DungGeunMo'; font-weight: bold; margin-top: 5px; animation: blink 0.5s infinite; display: none; }

        /* ê²Œì„ ë³´ë“œ ì˜ì—­ */
        #game-container { height: calc(100vh - 220px); display: flex; align-items: center; justify-content: center; position: relative; }
        #word-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; padding: 20px; width: 95%; max-width: 1400px; }
        .card { background: rgba(255,255,255,0.05); height: 45px; display: flex; align-items: center; justify-content: center; border: 1px solid #333; font-size: 0.9rem; transition: 0.3s; }
        .card.red { background: var(--red) !important; color: white; border-color: #fff; }
        .card.blue { background: var(--blue) !important; color: white; border-color: #fff; }

        /* í•˜ë‹¨ ì…ë ¥ì°½ */
        #footer { height: 100px; border-top: 3px solid #333; display: flex; align-items: center; background: #000; }
        .input-box { width: 100%; height: 100%; background: transparent; border: none; color: #fff; font-family: 'DungGeunMo'; font-size: 4rem; text-align: center; outline: none; }
        .monitor-frame { position: absolute; inset: 0; pointer-events: none; border: 20px solid transparent; transition: 0.3s; }
        .frame-red { border-color: rgba(255, 59, 59, 0.3); background: rgba(255, 59, 59, 0.05); }
        .frame-blue { border-color: rgba(59, 130, 255, 0.3); background: rgba(59, 130, 255, 0.05); }

        /* íŠ¹ìˆ˜ íš¨ê³¼ */
        #bonus-alert { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--gold); color: #000; padding: 20px 60px; font-size: 3rem; z-index: 1000; display: none; }
        #surveillance { position: fixed; inset: 0; background: rgba(255,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; font-size: 5rem; color: #fff; text-shadow: 0 0 20px #000; }
        
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }

        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="header">
    <div id="timer-box">02:00</div>
    <div class="territory-grid" id="territory-grid"></div>
</div>
<div id="shuffle-bar-container"><div id="shuffle-bar"></div></div>

<div id="game-container">
    <div id="word-board"></div>
    <div id="bonus-alert">URGENT: <span id="bonus-word"></span></div>
    <div id="surveillance">ğŸš¨ ê°ì‹œ ì¤‘ - ì¤‘ë‹¨í•˜ì„¸ìš”! ğŸš¨</div>
    <div id="monitor-frame" class="monitor-frame"></div>
</div>

<div id="footer">
    <input type="text" id="main-input" class="input-box" placeholder="SYSTEM STANDBY" disabled>
</div>

<div id="result-screen">
    <h1 id="result-title" style="font-size: 4rem; color: var(--gold);">ROUND ANALYSIS</h1>
    <div id="result-content" style="display: flex; gap: 50px; font-size: 1.5rem;"></div>
    <button onclick="GAME.requestContinue()" style="margin-top:40px; padding:20px 60px; font-family:'DungGeunMo'; font-size:2rem; cursor:pointer;">CONTINUE OPERATION</button>
</div>

<script>
// 1. ì„¤ì • ë° ë°ì´í„°
const CONFIG = {
    sectors: ['ì—ë„ˆì§€', 'ì¸í”„ë¼', 'ìë³¸', 'ê¸°ìˆ ', 'ë¬¸í™”'],
    levels: ['ê³µí„°', 'ë§ˆì„', 'ë„ì‹œ', 'ê°œë°œë„ìƒêµ­', 'ì„ ì§„êµ­'],
    wordPool: {
        'ì—ë„ˆì§€': ['ì„ìœ ','ì „ê¸°','ì›ìë ¥','íƒœì–‘ê´‘','ë°°í„°ë¦¬','ì„íƒ„','ê°€ìŠ¤','í’ë ¥','ìˆ˜ë ¥','ì¡°ë ¥','ê·¸ë¦¬ë“œ','ì „ì••','ë°œì „','íƒ„ì†Œ','ë°©ì‚¬ëŠ¥','ì—°ë£Œ','ì†¡ì „','ë³€ì „','ì—”ì§„','ì¶©ì „'],
        'ì¸í”„ë¼': ['ë„ë¡œ','ì² ë„','í•­ë§Œ','ê³µí•­','êµëŸ‰','í„°ë„','ìƒìˆ˜ë„','ë¹Œë”©','ê°•ì² ','ì‹œë©˜íŠ¸','ì¤‘ì¥ë¹„','í¬ë ˆì¸','ìš©ì ‘','ë²½ëŒ','ì„¤ê³„','ë„ì‹œ','ê±´ì„¤','ìœ í†µ','ë¬¼ë¥˜','í†µì‹ '],
        'ìë³¸': ['ì£¼ì‹','ì±„ê¶Œ','íˆ¬ì','ì€í–‰','ê¸ˆë¦¬','í™˜ìœ¨','ì„¸ê¸ˆ','ì˜ˆì‚°','ë³´í—˜','ì¦ê¶Œ','í€ë“œ','ê²½ì œ','ë¬´ì—­','í™”í','ë¹„ìš©','ìì‚°','ë¶€ì±„','ë°°ë‹¹','ì¦ì‹œ','ì½”ì¸'],
        'ê¸°ìˆ ': ['AI','ë¡œë´‡','ì½”ë”©','ë³´ì•ˆ','ì„œë²„','ë°˜ë„ì²´','ë°ì´í„°','ì–‘ì','í•´í‚¹','ë“œë¡ ','ìœ„ì„±','ì„¼ì„œ','ë¨¸ì‹ ','ë”¥ëŸ¬ë‹','ë°±ì‹ ','í´ë¼ìš°ë“œ','ëª¨ë°”ì¼','ì—”ì§€ë‹ˆì–´','ì†ŒìŠ¤','ì¹©'],
        'ë¬¸í™”': ['êµìœ¡','ì˜ë£Œ','ëŒ€í•™','ì² í•™','ì—­ì‚¬','ê³¼í•™','ë…¼ë¦¬','ë²•ë¥ ','ì–¸ì–´','ì‹¬ë¦¬','ë¯¸ë””ì–´','ì˜ˆìˆ ','ì˜í™”','í•œê¸€','ìŒì•…','ì¶•ì œ','ìœ ì‚°','ì¢…êµ','ì „í†µ','ë¯¸ë˜']
    }
};

// 2. íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ê²° (ì œê³µí•´ì£¼ì‹  DB ê²½ë¡œ ìœ ì§€)
const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_v3');

const GAME = {
    team: 'red', 
    monitorId: Math.floor(Math.random() * 1000), // ëª¨ë‹ˆí„° êµ¬ë¶„ìš© ID
    isSurveillance: false,

    init() {
        this.renderStaticUI();
        this.listenFirebase();
        this.bindEvents();
    },

    renderStaticUI() {
        const grid = document.getElementById('territory-grid');
        grid.innerHTML = CONFIG.sectors.map((name, i) => `
            <div class="sector-status" id="sector-${i}">
                <span class="level-text" id="lvl-txt-${i}">ê³µí„°</span>
                <strong style="font-size:1.1rem">${name}</strong>
                <div class="count-badge" id="badge-${i}">0</div>
                <button class="up-btn" id="up-btn-${i}" onclick="GAME.upgrade(${i})">UPGRADE</button>
            </div>
        `).join('');
    },

    listenFirebase() {
        db.on('value', snap => {
            const data = snap.val();
            if(!data) return this.resetDB();
            this.sync(data);
        });
    },

    resetDB() {
        const allWords = Object.values(CONFIG.wordPool).flat();
        db.set({
            state: 'READY',
            timer: 120,
            shuffleTimer: 10,
            bonusTimer: 20,
            surveillanceTimer: 30,
            words: allWords,
            cards: {},
            levels: { red: [0,0,0,0,0], blue: [0,0,0,0,0] },
            teams: { m1: 'red', m2: 'red', m3: 'blue', m4: 'blue' },
            bonusWord: "",
            winners: { red: 0, blue: 0 }
        });
    },

    sync(data) {
        // ëª¨ë‹ˆí„° íŒ€ ë°°ì • (ê³ ìœ  IDë¥¼ 4ê°œì˜ ìŠ¬ë¡¯ ì¤‘ í•˜ë‚˜ì— ë§¤ì¹­í•˜ëŠ” ë¡œì§ì€ ì‹¤ì œ í™˜ê²½ì— ë”°ë¼ ì¡°ì • í•„ìš”)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ 10ì´ˆë§ˆë‹¤ ë°”ë€ŒëŠ” teams ë°ì´í„° ìˆ˜ì‹ 
        const mySlot = 'm1'; // ê° ëª¨ë‹ˆí„° ê¸°ê¸°ë§ˆë‹¤ m1, m2, m3, m4 ê³ ì •ê°’ ë¶€ì—¬ í•„ìš”
        this.team = data.teams[mySlot];
        
        // UI ìƒ‰ìƒ ë³€ê²½
        const frame = document.getElementById('monitor-frame');
        frame.className = `monitor-frame frame-${this.team}`;
        
        // íƒ€ì´ë¨¸ ë° ë°” ì—…ë°ì´íŠ¸
        document.getElementById('timer-box').innerText = this.formatTime(data.timer);
        document.getElementById('shuffle-bar').style.width = (data.shuffleTimer / 10) * 100 + "%";

        // ë‹¨ì–´ ë³´ë“œ ë Œë”ë§ (ìµœì í™”: ê°œìˆ˜ ë‹¤ë¥¼ ë•Œë§Œ)
        const board = document.getElementById('word-board');
        if(board.childElementCount === 0) {
            board.innerHTML = data.words.map(w => `<div class="card" id="word-${w}">${w}</div>`).join('');
        }

        // ì¹´ë“œ ì†Œìœ ê¶Œ ë°˜ì˜ ë° ì¹´ìš´íŠ¸ ê³„ì‚°
        const myCounts = [0,0,0,0,0];
        Object.entries(data.cards || {}).forEach(([word, team]) => {
            const el = document.getElementById(`word-${word}`);
            if(el) el.className = `card ${team}`;
            if(team === this.team) {
                const idx = this.getSectorIdx(word);
                if(idx !== -1) myCounts[idx]++;
            }
        });

        // ì„¹í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        CONFIG.sectors.forEach((_, i) => {
            const lv = data.levels[this.team][i];
            const isCaptured = (data.levels.red[i] === 4 || data.levels.blue[i] === 4);
            
            document.getElementById(`lvl-txt-${i}`).innerText = CONFIG.levels[lv];
            document.getElementById(`badge-${i}`).innerText = myCounts[i];
            
            // ì„ ì§„êµ­(4) ë‹¬ì„± ì‹œ ì˜êµ¬ ì ë ¹ í‘œì‹œ
            if(data.levels.red[i] === 4) document.getElementById(`sector-${i}`).style.backgroundColor = 'var(--red)';
            if(data.levels.blue[i] === 4) document.getElementById(`sector-${i}`).style.backgroundColor = 'var(--blue)';

            // ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ (5ê°œ ëª¨ì•˜ê³ , ì•„ì§ ì„ ì§„êµ­ ì•„ë‹ˆë©°, ìƒëŒ€ê°€ ì„ ì  ì•ˆí–ˆì„ ë•Œ)
            const upBtn = document.getElementById(`up-btn-${i}`);
            upBtn.style.display = (myCounts[i] >= 5 && lv < 4 && !isCaptured) ? 'block' : 'none';
        });

        // ìƒíƒœë³„ í™”ë©´ ì œì–´
        document.getElementById('main-input').disabled = (data.state !== 'RUNNING');
        document.getElementById('bonus-alert').style.display = data.bonusWord ? 'block' : 'none';
        document.getElementById('bonus-word').innerText = data.bonusWord;
        document.getElementById('surveillance').style.display = data.isSurveillance ? 'flex' : 'none';
        this.isSurveillance = data.isSurveillance;

        if(data.state === 'FINISHED') this.showResult(data);
        else document.getElementById('result-screen').style.display = 'none';

        // ë§ˆìŠ¤í„° ëª¨ë‹ˆí„°ê°€ íƒ€ì´ë¨¸ ê³„ì‚° (í•œ ëŒ€ë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥í•˜ê±°ë‚˜ Firebase Functions ì‚¬ìš© ê¶Œì¥)
        // ì—¬ê¸°ì„  ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ m1 ìŠ¬ë¡¯ ëª¨ë‹ˆí„°ê°€ íƒ€ì´ë¨¸ ì£¼ë„
        if(mySlot === 'm1') this.tick(data);
    },

    tick(data) {
        if(data.state !== 'RUNNING') return;
        // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ë¡œì§ (ì‹¤ì œë¡œëŠ” setTimeout ë“±ìœ¼ë¡œ ì •ë°€ ì œì–´ í•„ìš”)
    },

    handleInput(val) {
        db.once('value', snap => {
            const data = snap.val();
            
            // ê°ì‹œ ëª¨ë“œ íŒ¨ë„í‹°
            if(this.isSurveillance) {
                const myCards = Object.keys(data.cards || {}).filter(w => data.cards[w] === this.team);
                if(myCards.length > 0) {
                    db.child('cards').child(myCards[0]).remove();
                }
                return;
            }

            if(val === data.bonusWord) {
                // ë³´ë„ˆìŠ¤: ìƒëŒ€ ì¹´ë“œ 5ê°œ ëºê¸°
                const enemy = this.team === 'red' ? 'blue' : 'red';
                const enemyCards = Object.keys(data.cards || {}).filter(w => data.cards[w] === enemy);
                enemyCards.slice(0, 5).forEach(w => db.child('cards').child(w).set(this.team));
                db.update({ bonusWord: "" });
            } else if(data.words.includes(val)) {
                db.child('cards').child(val).set(this.team);
            }
        });
    },

    upgrade(idx) {
        db.once('value', snap => {
            const data = snap.val();
            const wordsInSector = CONFIG.wordPool[CONFIG.sectors[idx]];
            const myOwned = Object.keys(data.cards || {}).filter(w => data.cards[w] === this.team && wordsInSector.includes(w));
            
            if(myOwned.length >= 5) {
                myOwned.slice(0, 5).forEach(w => db.child('cards').child(w).remove());
                const newLvl = data.levels[this.team][idx] + 1;
                db.child('levels').child(this.team).child(idx).set(newLvl);
                
                // ìŠ¹ì  ì²´í¬ (3ê°œ ì„ ì§„êµ­)
                const winCount = data.levels[this.team].filter(v => v === 4).length + (newLvl === 4 ? 1 : 0);
                if(winCount >= 3) db.update({ state: 'FINISHED', winner: this.team });
            }
        });
    },

    // ìœ í‹¸ë¦¬í‹°
    getSectorIdx(word) {
        return Object.values(CONFIG.wordPool).findIndex(list => list.includes(word));
    },
    formatTime(s) {
        return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
    },
    bindEvents() {
        const input = document.getElementById('main-input');
        input.onkeydown = (e) => {
            if(e.key === 'Enter') {
                this.handleInput(input.value.trim());
                input.value = "";
            }
        };
        // ë§ˆìš°ìŠ¤ í´ë¦­ ì‹œ ê²Œì„ ì‹œì‘ (ì²« ì‚¬ìš©ììš©)
        window.onclick = () => {
            db.once('value', snap => { if(snap.val().state === 'READY') db.update({ state: 'RUNNING' }); });
        };
    }
};

GAME.init();
</script>
</body>
</html>
