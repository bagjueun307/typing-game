<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NATION BUILDER: FINAL DOMINATION</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --red-bg: #4a0000; --blue-bg: #00004a; 
            --red-neon: #ff2e2e; --blue-neon: #2e70ff; 
            --yellow: #f1c40f; --dark: #050505; --neon-cyan: #00ffdd;
        }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* 상단 전체 시간 막대 */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 90px; background: #111; z-index: 6000; border-bottom: 3px solid #333; }
        #total-progress-wrap { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; background: #222; }
        #total-progress-bar { width: 100%; height: 100%; background: var(--yellow); box-shadow: 0 0 15px var(--yellow); transition: 0.1s linear; }
        #timer-disp { font-size: 3rem; text-align: center; line-height: 80px; color: var(--yellow); }

        /* 메인 게임 뷰 */
        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 105px 15px 15px 15px; height: 100vh; box-sizing: border-box; }
        
        /* 모니터 스타일 - 배경색 전면 적용 */
        .monitor { border: 4px solid #333; display: flex; flex-direction: column; border-radius: 15px; position: relative; overflow: hidden; transition: background 0.5s, border 0.3s; background: #111; }
        .monitor.team-red { background-color: var(--red-bg) !important; border-color: var(--red-neon); }
        .monitor.team-blue { background-color: var(--blue-bg) !important; border-color: var(--blue-neon); }
        .monitor.focused { position: fixed !important; inset: 100px 20px 20px 20px; z-index: 5000; border-width: 8px; }

        /* 감시 레이어 (텍스트 알림) */
        .alert-layer { position: absolute; inset: 0; z-index: 4500; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        .monitor.alert .alert-layer { display: flex; background: rgba(255, 0, 0, 0.4); }
        .alert-text { font-size: 4rem; color: #fff; text-shadow: 0 0 20px #f00; font-weight: bold; background: #000; padding: 15px 40px; border: 6px solid #f00; animation: alert-blink 0.5s infinite; }
        @keyframes alert-blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }

        /* 하단 10초 스왑 타이머 */
        .swap-container { height: 15px; background: #000; width: 100%; position: relative; border-top: 2px solid rgba(255,255,255,0.1); }
        .swap-bar { height: 100%; width: 100%; transition: 0.1s linear; }
        .team-red .swap-bar { background: var(--red-neon); box-shadow: 0 0 15px var(--red-neon); }
        .team-blue .swap-bar { background: var(--blue-neon); box-shadow: 0 0 15px var(--blue-neon); }

        /* 보너스 문제 팝업 */
        #bonus-pop { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--yellow); color: #000; padding: 25px 50px; font-size: 3.5rem; z-index: 4800; border: 6px solid #fff; display: none; box-shadow: 0 0 50px var(--yellow); animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-in { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

        /* 업그레이드 및 카운트 정보 */
        .upgrade-layer { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 12px; background: rgba(0,0,0,0.7); border-bottom: 2px solid rgba(255,255,255,0.1); }
        .count-badge { font-size: 1.1rem; color: var(--neon-cyan); font-weight: bold; margin-bottom: 4px; }
        .up-btn { font-family: 'DungGeunMo'; padding: 8px; font-size: 0.85rem; background: #222; color: #777; border: 1px solid #444; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .up-btn.ready { background: #fff; color: #000; font-weight: bold; border-color: var(--yellow); animation: button-flash 0.6s infinite; }
        @keyframes button-flash { 0%, 100% { background: var(--yellow); box-shadow: 0 0 10px var(--yellow); } 50% { background: #fff; box-shadow: none; } }

        /* 정사각형 카드 보드 */
        .board { display: grid; grid-template-columns: repeat(14, 1fr); gap: 6px; flex: 1; padding: 20px; align-content: start; background: rgba(0,0,0,0.3); }
        .card { aspect-ratio: 1/1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #888; border-radius: 5px; text-align: center; word-break: keep-all; line-height: 1.2; }
        .card.owned-red { background: var(--red-neon) !important; color: #fff !important; font-weight: bold; border-color: #fff; box-shadow: 0 0 10px var(--red-neon); }
        .card.owned-blue { background: var(--blue-neon) !important; color: #fff !important; font-weight: bold; border-color: #fff; box-shadow: 0 0 10px var(--blue-neon); }

        /* 입력창 구역 */
        .input-wrap { display: flex; height: 110px; border-top: 5px solid rgba(0,0,0,0.5); }
        .input-box { flex: 1; background: #000; border: none; font-size: 4.5rem; text-align: center; outline: none; font-family: 'DungGeunMo'; color: #fff; }
        .team-red .input-box { color: var(--red-neon); text-shadow: 0 0 20px var(--red-neon); }
        .team-blue .input-box { color: var(--blue-neon); text-shadow: 0 0 20px var(--blue-neon); }

        /* 로비/시작 화면 */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { padding: 30px 80px; font-family: 'DungGeunMo'; font-size: 3rem; background: var(--yellow); border: none; cursor: pointer; border-radius: 20px; box-shadow: 0 10px 0 #b8860b; transition: 0.1s; }
        .start-btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #b8860b; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 5rem; margin-bottom: 30px; text-shadow: 0 0 20px var(--yellow);">NATION BUILDER</h1>
    <p style="color:#0ff; font-size: 1.5rem; margin-bottom: 50px;">[ 마을 > 도시 > 신생국 > 개도국 > 선진국 ]</p>
    <button class="start-btn" onclick="prepareRound()">세션 시작</button>
</div>

<div id="top-bar">
    <div id="timer-disp">READY</div>
    <div id="total-progress-wrap"><div id="total-progress-bar"></div></div>
</div>

<div id="room-view">
    <script>
        const cityList = ['발전의 도시','강철의 도시','자본의 도시','미래의 도시','지혜의 도시'];
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="zoomIn(${i})">
                    <div class="alert-layer"><div class="alert-text">감시 중: 입력 중단!</div></div>
                    <div class="upgrade-layer">
                        ${cityList.map((c, idx) => `
                            <div style="text-align:center;">
                                <div class="count-badge" id="cnt-${i}-${idx}">0/10</div>
                                <button class="up-btn" id="up-${i}-${idx}" onclick="requestUpgrade(event, ${i}, '${c}', ${idx})">${c.split(' ')[0]}</button>
                            </div>
                        `).join('')}
                    </div>
                    <div id="bonus-pop">BONUS!</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap">
                        <input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="터미널 대기" disabled autocomplete="off">
                    </div>
                    <div class="swap-container"><div class="swap-bar" id="swap-bar-${i}"></div></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const cityMap = {
        '발전의 도시': ['석탄','태양광','원자력','석유','전기','풍력','수소','배터리','가스','화력','수력','광물','송전탑','에너지'],
        '강철의 도시': ['철강','금속','자동차','선박','반도체','기계','로봇','화석','화학','부품','공장','엔진','주물','용접'],
        '자본의 도시': ['은행','주식','채권','투자','자산','환율','금리','펀드','보험','증권','코인','세금','대출','신용'],
        '미래의 도시': ['AI','소프트웨어','클라우드','서버','보안','코딩','알고리즘','양자','센서','회로','위성','해킹','웹3','빅데이터'],
        '지혜의 도시': ['교육','의료','대학','훈련','연구','백신','임상','장학','인재','교수','의사','도서관','백과','멘토']
    };

    let persistentCards = {}, activeWords = {}, active = false, isAlert = false, currentBonus = "";
    let cityLevels = { red: {}, blue: {} }; 
    let currentTeams = { 1:'red', 2:'red', 3:'blue', 4:'blue' };
    const stepNames = ["공터", "마을", "도시", "신생국", "개도국", "선진국"];

    cityList.forEach(c => { cityLevels.red[c] = 0; cityLevels.blue[c] = 0; });
    
    // Firebase 설정
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_final_v12');

    function prepareRound() {
        document.getElementById('lobby-screen').style.display = 'none';
        const newWords = {};
        Object.keys(cityMap).forEach(city => newWords[city] = cityMap[city].sort(()=>Math.random()-0.5).slice(0, 14));
        db.update({ state: 'READY', words: newWords, cards: {}, teams: { 1:'red', 2:'red', 3:'blue', 4:'blue' }, bonus: "" });
        initUI();
    }

    function initUI() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`); b.innerHTML = "";
            Object.values(activeWords).flat().forEach(w => {
                const div = document.createElement('div');
                div.className = 'card'; div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function zoomIn(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`in-${id}`).disabled = false;
        document.getElementById(`in-${id}`).focus();
        if(!active) db.update({ state: 'START' });
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.words) activeWords = d.words;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            currentTeams = d.teams;
            for(let i=1; i<=4; i++) {
                const m = document.getElementById(`mon-${i}`);
                m.className = `monitor team-${d.teams[i]} ${m.classList.contains('focused')?'focused':''} ${isAlert?'alert':''}`;
            }
        }
        if(d.cards) { persistentCards = d.cards; updateStats(); }
        if(d.bonus) {
            currentBonus = d.bonus;
            document.querySelectorAll('#bonus-pop').forEach(p => { p.style.display = 'block'; p.innerText = `BONUS: ${d.bonus}`; });
        } else {
            document.querySelectorAll('#bonus-pop').forEach(p => p.style.display = 'none');
        }
    });

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const myTeam = currentTeams[id];
            const enemyTeam = (myTeam === 'red') ? 'blue' : 'red';
            
            if(isAlert) {
                // 감시 중 페널티: 중립화
                db.child('cards').once('value', s => {
                    const c = s.val(); if(!c) return;
                    const mine = Object.keys(c).filter(k => c[k].team === myTeam);
                    if(mine.length > 0) db.child('cards').child(mine[mine.length-1]).remove();
                });
            } else if(val === currentBonus && currentBonus !== "") {
                // 보너스 약탈: 상대방 카드 3개 탈취
                db.child('cards').once('value', s => {
                    const c = s.val(); if(!c) return;
                    const enemyCards = Object.keys(c).filter(k => c[k].team === enemyTeam);
                    const loot = enemyCards.sort(() => 0.5 - Math.random()).slice(0, 3);
                    loot.forEach(k => db.child('cards').child(k).set({ team: myTeam }));
                    db.update({ bonus: "" });
                });
            } else if(findCat(val)) {
                db.child('cards').child(val).set({ team: myTeam });
            }
            e.target.value = "";
        }
    }

    function findCat(w) { for(let cat in cityMap) if(cityMap[cat].includes(w)) return cat; return null; }

    function updateStats() {
        const scores = { red: {}, blue: {} };
        cityList.forEach(c => { scores.red[c] = 0; scores.blue[c] = 0; });
        
        Object.keys(persistentCards).forEach(w => {
            const t = persistentCards[w].team;
            const cat = findCat(w); if(cat) scores[t][cat]++;
            for(let i=1; i<=4; i++) {
                const cEl = document.getElementById(`card-${i}-${w}`);
                if(cEl) { cEl.classList.remove('owned-red', 'owned-blue'); cEl.classList.add(`owned-${t}`); }
            }
        });

        // 중립화된 카드 UI 초기화
        Object.values(activeWords).flat().forEach(w => {
            if(!persistentCards[w]) {
                for(let i=1; i<=4; i++) {
                    const cEl = document.getElementById(`card-${i}-${w}`);
                    if(cEl) cEl.classList.remove('owned-red', 'owned-blue');
                }
            }
        });

        for(let i=1; i<=4; i++) {
            const team = currentTeams[i];
            cityList.forEach((c, idx) => {
                const s = scores[team][c]; const l = cityLevels[team][c];
                const target = (l + 1) * 10;
                document.getElementById(`cnt-${i}-${idx}`).innerText = `${s}/${target}`;
                const btn = document.getElementById(`up-${i}-${idx}`);
                btn.classList.toggle('ready', s >= target && l < 5);
                btn.innerText = stepNames[l];
            });
        }
    }

    function requestUpgrade(e, monId, cityName, btnIdx) {
        e.stopPropagation();
        const team = currentTeams[monId];
        if(document.getElementById(`up-${monId}-${btnIdx}`).classList.contains('ready')) {
            cityLevels[team][cityName]++;
            updateStats();
        }
    }

    function startTimer() {
        let time = 1200; // 120초
        const intr = setInterval(() => {
            time--;
            
            // 상단 전체 시간 바
            document.getElementById('total-progress-bar').style.width = (time/1200)*100 + "%";
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            
            // 하단 10초 스왑 바
            let swapTime = (time % 100);
            document.querySelectorAll('.swap-bar').forEach(bar => {
                bar.style.width = (swapTime === 0 ? 0 : swapTime) + "%";
            });

            // 10초마다 팀 교체
            if(time > 0 && time % 100 === 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: { 1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3] } });
            }

            // 20초 주기 중 5초간 감시 (50틱)
            isAlert = ((time % 200) <= 50 && (time % 200) > 0);

            // 30초마다 보너스 단어 생성
            if(time > 0 && time % 300 === 0) {
                const allWords = Object.values(cityMap).flat();
                db.update({ bonus: allWords[Math.floor(Math.random()*allWords.length)] });
                setTimeout(() => db.update({ bonus: "" }), 7000); // 7초 뒤 자동 소멸
            }

            if(time <= 0) { clearInterval(intr); alert("게임 종료! 최종 오각형 발전을 확인하십시오."); }
        }, 100);
    }
</script>
</body>
</html>
