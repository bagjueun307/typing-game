<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MAFIA: NATION BUILDER</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #D63031; --blue: #0984E3; --yellow: #FDCB6E; --dark: #0A0A0F; --laser: #FF0000; --ai: #00FFDD; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151A; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #timer-disp { font-size: 3rem; color: var(--yellow); }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; padding: 130px 15px 15px 15px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 6px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 12px; position: relative; transition: 0.3s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 120px 20px 20px 20px; z-index: 5000; border-width: 12px; }
        
        .team-indicator { font-size: 1.5rem; padding: 10px; text-align: center; font-weight: bold; }
        .monitor.team-red { border-color: var(--red); }
        .monitor.team-blue { border-color: var(--blue); }
        .monitor.team-red .team-indicator { background: var(--red); color: #fff; }
        .monitor.team-blue .team-indicator { background: var(--blue); color: #fff; }

        .input-wrap { display: flex; height: 90px; border-top: 5px solid var(--yellow); }
        .monitor.team-red .input-wrap { background: #4D0000; }
        .monitor.team-blue .input-wrap { background: #002B4D; }
        .input-box { flex: 1; background: rgba(0,0,0,0.5); color: #fff; border: none; font-size: 3rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        /* Î†àÏù¥Ï†Ä Ïó∞Ï∂ú */
        .laser-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; }
        .monitor.warning .laser-overlay { opacity: 1; background: rgba(253, 203, 110, 0.2); border: 15px solid var(--yellow); animation: warn-blink 0.2s infinite; }
        .monitor.alert .laser-overlay { opacity: 1; background: rgba(0,0,0,0.7); border: 15px solid var(--laser); background-image: linear-gradient(rgba(255,0,0,0.8) 2px, transparent 2px), linear-gradient(90deg, rgba(255,0,0,0.8) 2px, transparent 2px); background-size: 40px 40px; animation: laser-move 0.5s linear infinite; }
        @keyframes laser-move { 0% { background-position: 0 0; } 100% { background-position: 40px 40px; } }
        @keyframes warn-blink { 0% { opacity: 0.3; } 100% { opacity: 0.8; } }

        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; flex: 1; padding: 10px; background: #000; }
        .card { height: 50px; background: #1A1A1A; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #888; }
        .card.owned-red { background: var(--red) !important; color: white; border-color: #fff; }
        .card.owned-blue { background: var(--blue) !important; color: white; border-color: #fff; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        button { padding: 15px 40px; font-family: 'DungGeunMo'; cursor: pointer; background: var(--yellow); border: none; font-size: 1.3rem; margin: 10px; }
        
        /* Í≤∞Í≥ºÏ∞Ω Ï∞®Ìä∏ Í∞ïÌôî */
        .chart-grid { display: flex; gap: 30px; margin-top: 20px; }
        .chart-item { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 2px solid #444; }
        .rank-badge { font-size: 1.5rem; color: var(--ai); margin: 10px 0; border: 1px solid var(--ai); padding: 5px 15px; }
        .ai-tip { font-size: 1rem; color: #ccc; margin-top: 10px; max-width: 300px; line-height: 1.4; }
    </style>
</head>
<body>

<div id="lobby-screen" class="overlay">
    <h1 style="color:var(--yellow); font-size: 3rem;">NATION BUILDER: 5 CITIES</h1>
    <div id="evo-status" style="display:flex; gap:10px; margin-bottom:20px;"></div>
    <button onclick="prepareRound()">ÎèÑÏãú Í±¥ÏÑ§ ÌòÑÏû•ÏúºÎ°ú Ïù¥Îèô</button>
</div>

<div id="result-screen" class="overlay" style="display:none; z-index:11000;">
    <h1 style="color:var(--yellow); font-size: 2.2rem;">[Íµ≠Í∞Ä Î∞úÏ†Ñ Î≥¥Í≥†ÏÑú]</h1>
    <div class="chart-grid">
        <div class="chart-item" style="border-color: var(--red);">
            <h2 style="color:var(--red);">RED TEAM</h2>
            <div id="rank-red" class="rank-badge">ÎØ∏Í∞úÎ∞úÍµ≠</div>
            <canvas id="final-chart-red" width="320" height="320"></canvas>
            <div id="tip-red" class="ai-tip">AI Î∂ÑÏÑù Ï§ë...</div>
        </div>
        <div class="chart-item" style="border-color: var(--blue);">
            <h2 style="color:var(--blue);">BLUE TEAM</h2>
            <div id="rank-blue" class="rank-badge">ÎØ∏Í∞úÎ∞úÍµ≠</div>
            <canvas id="final-chart-blue" width="320" height="320"></canvas>
            <div id="tip-blue" class="ai-tip">AI Î∂ÑÏÑù Ï§ë...</div>
        </div>
    </div>
    <button onclick="closeResult()">Îã§Ïùå ÎùºÏö¥Îìú ÏßÑÌñâ</button>
</div>

<div id="top-bar">
    <div id="timer-disp">120.0s</div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="team-indicator" id="team-text-${i}">Ï†ëÏÜç ÎåÄÍ∏∞</div>
                    <div class="laser-overlay"></div>
                    <div class="monitor-start-layer" id="layer-${i}">
                        <button id="btn-start-${i}" onclick="triggerStart(event, ${i})" style="display:none;">Í±¥ÏÑ§ ÏãúÏûë</button>
                    </div>
                    <div id="cd-${i}" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; font-size:12rem; color:var(--yellow); z-index:4000; background:rgba(0,0,0,0.8);">3</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ÎèÑÏãú ÏÑ†ÌÉù" disabled></div>
                </div>
            `);
        }
    </script>
</div>

<script>
    const cityMap = {
        'Î∞úÏ†ÑÏùò ÎèÑÏãú': ['ÏÑùÌÉÑ','ÌÉúÏñëÍ¥ë','ÏõêÏûêÎ†•','ÏÑùÏú†','Ï†ÑÍ∏∞','ÌíçÎ†•','ÏàòÏÜå','Î∞∞ÌÑ∞Î¶¨','Í∞ÄÏä§','ÌôîÎ†•'],
        'Í∞ïÏ≤†Ïùò ÎèÑÏãú': ['Ï≤†Í∞ï','Í∏àÏÜç','ÏûêÎèôÏ∞®','ÏÑ†Î∞ï','Î∞òÎèÑÏ≤¥','Í∏∞Í≥Ñ','Î°úÎ¥á','ÌôîÏÑù','ÌôîÌïô','Î∂ÄÌíà'],
        'ÏûêÎ≥∏Ïùò ÎèÑÏãú': ['ÏùÄÌñâ','Ï£ºÏãù','Ï±ÑÍ∂å','Ìà¨Ïûê','ÏûêÏÇ∞','ÌôòÏú®','Í∏àÎ¶¨','ÌéÄÎìú','Î≥¥Ìóò','Ï¶ùÍ∂å'],
        'ÎØ∏ÎûòÏùò ÎèÑÏãú': ['AI','ÏÜåÌîÑÌä∏Ïõ®Ïñ¥','ÌÅ¥ÎùºÏö∞Îìú','ÏÑúÎ≤Ñ','Î≥¥Ïïà','ÏΩîÎî©','ÏïåÍ≥†Î¶¨Ï¶ò','ÏñëÏûê','ÏÑºÏÑú','ÌöåÎ°ú'],
        'ÏßÄÌòúÏùò ÎèÑÏãú': ['ÍµêÏú°','ÏùòÎ£å','ÎåÄÌïô','ÌõàÎ†®','Ïó∞Íµ¨','Î∞±Ïã†','ÏûÑÏÉÅ','Ïû•Ìïô','Ïù∏Ïû¨','ÍµêÏàò']
    };

    let persistentCards = {}, activeWords = {}, active = false, isAlert = false, isWarning = false;
    let finalCharts = { red: null, blue: null };
    let currentScores = { red: {}, blue: {} };

    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('nation_builder_v1');

    function prepareRound() {
        document.getElementById('lobby-screen').style.display = 'none';
        const newWords = {};
        Object.keys(cityMap).forEach(cat => newWords[cat] = [...cityMap[cat]].sort(()=>Math.random()-0.5));
        activeWords = newWords;
        const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
        db.update({ state: 'READY', teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
        initBoardUI();
    }

    function initBoardUI() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            Object.values(activeWords).flat().forEach(w => {
                const div = document.createElement('div');
                div.className = `card ${persistentCards[w]? 'owned-'+persistentCards[w].team : ''}`;
                div.id = `card-${i}-${w}`; div.innerText = w;
                b.appendChild(div);
            });
        }
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.querySelectorAll('.monitor-start-layer button').forEach(b => b.style.display = 'none');
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`btn-start-${id}`).style.display = 'block';
    }

    function triggerStart(e, id) {
        e.stopPropagation();
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'flex';
        let count = 3;
        const intr = setInterval(() => {
            count--; if(count > 0) cd.innerText = count;
            else {
                clearInterval(intr); cd.style.display = 'none';
                document.getElementById(`layer-${id}`).style.display = 'none';
                db.update({ state: 'START' });
                document.getElementById(`in-${id}`).disabled = false;
                document.getElementById(`in-${id}`).focus();
            }
        }, 1000);
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            for(let i=1; i<=4; i++) {
                const m = document.getElementById(`mon-${i}`);
                m.className = `monitor team-${d.teams[i]} ${m.classList.contains('focused')?'focused':''} ${isWarning?'warning':''} ${isAlert?'alert':''}`;
                document.getElementById(`team-text-${i}`).innerText = `[ÏÜåÏÜç: ${d.teams[i].toUpperCase()} TEAM]`;
            }
        }
        if(d.cards) {
            persistentCards = d.cards;
            const scores = { red: { 'Î∞úÏ†ÑÏùò ÎèÑÏãú':0,'Í∞ïÏ≤†Ïùò ÎèÑÏãú':0,'ÏûêÎ≥∏Ïùò ÎèÑÏãú':0,'ÎØ∏ÎûòÏùò ÎèÑÏãú':0,'ÏßÄÌòúÏùò ÎèÑÏãú':0 }, blue: { 'Î∞úÏ†ÑÏùò ÎèÑÏãú':0,'Í∞ïÏ≤†Ïùò ÎèÑÏãú':0,'ÏûêÎ≥∏Ïùò ÎèÑÏãú':0,'ÎØ∏ÎûòÏùò ÎèÑÏãú':0,'ÏßÄÌòúÏùò ÎèÑÏãú':0 } };
            Object.keys(persistentCards).forEach(w => {
                const team = persistentCards[w].team;
                const cat = findCat(w);
                if(cat && team !== 'neutral') scores[team][cat]++;
                for(let i=1; i<=4; i++) {
                    const c = document.getElementById(`card-${i}-${w}`);
                    if(c) c.className = `card owned-${team}`;
                }
            });
            currentScores = scores;
            updateEvoStatus(scores);
        }
    });

    function findCat(w) { for(let cat in cityMap) if(cityMap[cat].includes(w)) return cat; return null; }

    function handleInput(e, id) {
        const team = document.getElementById(`mon-${id}`).classList.contains('team-red') ? 'red' : 'blue';
        if(isAlert) {
            db.child('cards').once('value', s => {
                const c = s.val(); if(!c) return;
                const mine = Object.keys(c).filter(k => c[k].team === team);
                if(mine.length > 0) db.child('cards').child(mine[mine.length-1]).remove();
            });
            e.target.value = ""; return;
        }
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(findCat(val)) db.child('cards').child(val).set({ team: team });
            e.target.value = "";
        }
    }

    function startTimer() {
        let time = 1200;
        const intr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            let cycle = time % 100;
            isWarning = (cycle <= 30 && cycle > 20); 
            isAlert = (cycle <= 20 && cycle > 0); 
            document.querySelectorAll('.monitor').forEach(m => {
                m.classList.toggle('warning', isWarning);
                m.classList.toggle('alert', isAlert);
            });
            if(time > 0 && time % 100 === 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
            }
            if(time <= 0) { clearInterval(intr); endRound(); }
        }, 100);
    }

    function endRound() {
        active = false;
        document.getElementById('result-screen').style.display = 'flex';
        renderFinalCharts(currentScores);
    }

    function renderFinalCharts(scores) {
        const cities = Object.keys(cityMap);
        ['red', 'blue'].forEach(team => {
            const data = cities.map(c => scores[team][c]);
            const upgradedCount = data.filter(v => v >= 10).length;
            
            // Îì±Í∏â Î∞è Ï°∞Ïñ∏ Í≤∞Ï†ï
            let rank = "ÎØ∏Í∞úÎ∞úÍµ≠";
            if(upgradedCount === 5) rank = "ÏÑ†ÏßÑÍµ≠ (üèÜ)";
            else if(upgradedCount >= 3) rank = "Í∞úÎ∞úÎèÑÏÉÅÍµ≠";
            
            let weakCity = "";
            let minVal = 10;
            cities.forEach(c => { if(scores[team][c] < minVal) { minVal = scores[team][c]; weakCity = c; } });
            
            let tip = upgradedCount === 5 ? "ÏµúÍ≥†Ïùò Íµ≠Í∞ÄÎ•º Í±¥ÏÑ§ÌñàÏäµÎãàÎã§!" : `${weakCity}Ïóê Îã®Ïñ¥ ${10-minVal}Í∞úÍ∞Ä Îçî ÌïÑÏöîÌï©ÎãàÎã§. Ïù¥Í≥≥ÏùÑ Í≥µÎûµÌïòÏÑ∏Ïöî!`;

            document.getElementById(`rank-${team}`).innerText = rank;
            document.getElementById(`tip-${team}`).innerText = `Ïò§ÎùºÌÅ¥: "${tip}"`;

            const ctx = document.getElementById(`final-chart-${team}`);
            if(finalCharts[team]) finalCharts[team].destroy();
            finalCharts[team] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: cities.map(c => `${c} (Î∂ÄÏ°±:${10-scores[team][c]})`),
                    datasets: [{
                        data: data,
                        backgroundColor: (team==='red'?'#D6303155':'#0984E355'),
                        borderColor: (team==='red'?'#D63031':'#0984E3'),
                        borderWidth: 5
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 10, ticks: { display: false }, grid: { color: '#444' }, pointLabels: { color: '#fff', font: { size: 12, family: 'DungGeunMo' } } } },
                    plugins: { legend: { display: false } }
                }
            });
        });
    }

    function closeResult() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'flex';
        document.querySelectorAll('.monitor-start-layer').forEach(l => l.style.display = 'flex');
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
    }

    function updateEvoStatus(scores) {
        let html = "";
        Object.keys(cityMap).forEach(c => {
            const count = Math.max(scores.red[c], scores.blue[c]);
            html += `<div style="padding:10px; border:2px solid ${count>=10?'var(--yellow)':'#444'}; width:90px; font-size:0.8rem;">${c}<br>${count}/10</div>`;
        });
        document.getElementById('evo-status').innerHTML = html;
    }
</script>
</body>
</html>
