<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WORLD STEALER V97 - MAFIA EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --red: #FF4757; --blue: #2E86DE; --yellow: #FECA57; --dark: #0A0A0F; --alert: #FF0000; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 80px; background: #15151A; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        #shuffle-container { position: fixed; top: 80px; left: 0; width: 100%; height: 8px; background: #222; z-index: 5900; }
        #shuffle-bar { height: 100%; background: var(--yellow); width: 100%; transition: width 0.1s linear; }

        /* ëª¨ë‹ˆí„° ë·° */
        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; padding: 120px 20px 20px 20px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 5px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 15px; position: relative; cursor: pointer; transition: 0.3s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 120px 30px 30px 30px; z-index: 5000; }
        .monitor.team-red.focused { border: 12px solid var(--red); box-shadow: 0 0 40px var(--red); }
        .monitor.team-blue.focused { border: 12px solid var(--blue); box-shadow: 0 0 40px var(--blue); }

        /* ì¹´ë“œ ë° ë³´ë“œ */
        .board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; flex: 1; padding: 10px; background: #050505; }
        .card-container { height: 60px; perspective: 600px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .card-front { background: #1A1A1A; border: 1px solid #333; font-size: 0.9rem; }
        .card-back { transform: rotateY(180deg); color: white; font-weight: bold; border: 2px solid #fff; font-size: 0.8rem; }
        .back-red { background: var(--red); }
        .back-blue { background: var(--blue); }

        /* ì…ë ¥ì°½ */
        .input-wrap { display: flex; height: 70px; background: #000; border-top: 4px solid var(--yellow); }
        .input-box { flex: 1; background: transparent; color: #fff; border: none; font-size: 2rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        /* ì˜¤ë²„ë ˆì´ ë° íŒì—… */
        #round-selector, #result-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #bonus-popup { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: rgba(20, 0, 0, 0.95); border: 4px solid var(--red); padding: 30px; z-index: 9000; text-align: center; display: none; border-radius: 20px; box-shadow: 0 0 50px var(--red); }
        .security-bar { text-align: center; padding: 10px; background: #222; font-size: 1.1rem; }
        .security-bar.alert { background: var(--alert) !important; animation: shake 0.1s infinite; }

        /* ê²°ê³¼ ì°½íŠ¸ */
        .chart-container { display: flex; gap: 40px; margin: 30px 0; }
        canvas { background: #111; border-radius: 10px; padding: 10px; }

        @keyframes shake { 0% { transform: translateX(0); } 50% { transform: translateX(3px); } 100% { transform: translateX(-3px); } }
    </style>
</head>
<body>

<div id="round-selector">
    <h1 style="color:var(--yellow); font-size: 3.5rem;">[ WORLD STEALER: MAFIA ]</h1>
    <p style="color:#aaa;">5ëŒ€ êµ­ê°€ í•µì‹¬ ì‚°ì—…ì„ ì¥ì•…í•˜ì—¬ ì¡°ì§ì„ ì„±ì¥ì‹œí‚¤ì‹­ì‹œì˜¤.</p>
    <button class="round-btn" onclick="startGame()" style="padding:20px 60px; font-size:2rem; cursor:pointer; background:var(--yellow); font-family:'DungGeunMo';">ì‘ì „ ê°œì‹œ</button>
</div>

<div id="top-bar">
    <div style="color:var(--red); font-size: 2rem;">RED MAFIA: <span id="score-red">0</span></div>
    <div id="timer-disp" style="font-size:2.5rem; color:var(--yellow);">60.0s</div>
    <div style="color:var(--blue); font-size: 2rem;">BLUE MAFIA: <span id="score-blue">0</span></div>
</div>
<div id="shuffle-container"><div id="shuffle-bar"></div></div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="security-bar" id="sec-${i}">ğŸ“¡ ì‹œìŠ¤í…œ ì—°ê²° ì¤‘...</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap">
                        <input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ëª¨ë‹ˆí„° ì„ íƒ" disabled>
                    </div>
                </div>
            `);
        }
    </script>
</div>

<div id="bonus-popup">
    <div style="color:var(--red); font-weight:bold;">âš ï¸ CRITICAL HACKING âš ï¸</div>
    <h1 id="bonus-code" style="color:var(--yellow); font-size:2.5rem;">CODE</h1>
    <div style="color:#fff;">ì…ë ¥ ì‹œ ìƒëŒ€ ìì‚° 3ê°œ íƒˆì·¨</div>
</div>

<div id="result-screen" style="display:none;">
    <h1 style="color:var(--yellow); font-size:3rem;">ì „ìŸ ì¢…ë£Œ: ì¡°ì§ ì„±ì¥ ë³´ê³ ì„œ</h1>
    <div class="chart-container">
        <div><h2 style="color:var(--red);">RED MAFIA</h2><canvas id="chart-red" width="400" height="400"></canvas></div>
        <div><h2 style="color:var(--blue);">BLUE MAFIA</h2><canvas id="chart-blue" width="400" height="400"></canvas></div>
    </div>
    <button onclick="location.reload()" style="padding:15px 40px; font-family:'DungGeunMo'; cursor:pointer;">ì¬ì ‘ì†</button>
</div>

<script>
    // 1. ë°ì´í„° ì •ì˜ (5ëŒ€ ìš”ì†Œ)
    const industry = {
        'ì—ë„ˆì§€': ['ì›ìë ¥','íƒœì–‘ê´‘','ì„ìœ ','ê°€ìŠ¤','ë°°í„°ë¦¬','ì „ë ¥ë§','ìˆ˜ì†Œ','í’ë ¥','ì •ìœ ','ì„íƒ„'],
        'ì œì¡°': ['ìë™ì°¨','ë°˜ë„ì²´','ì² ê°•','ì¡°ì„ ','ë¡œë´‡','í•­ê³µ','í™”í•™','ê¸°ê³„','ìƒì‚°ë¼ì¸','ì„¤ë¹„'],
        'ê¸ˆìœµ': ['ì€í–‰','ì¦ê¶Œ','ì£¼ì‹','í€ë“œ','ê¸ˆë¦¬','ë³´í—˜','ìì‚°','ì™¸í™˜','ì±„ê¶Œ','í•€í…Œí¬'],
        'ê¸°ìˆ ': ['AI','í´ë¼ìš°ë“œ','ì„œë²„','ì–‘ì','ë³´ì•ˆ','ì½”ë”©','ë¹…ë°ì´í„°','í†µì‹ ','SW','ë„¤íŠ¸ì›Œí¬'],
        'ì¸ì ìë³¸': ['êµìœ¡','ì˜ë£Œ','ì—°êµ¬','ë°±ì‹ ','ëŒ€í•™','í›ˆë ¨','ì¸ì¬','ì„ìƒ','ë³µì§€','ê³µì¤‘ë³´ê±´']
    };
    const allWords = [];
    Object.keys(industry).forEach(cat => {
        industry[cat].forEach(word => allWords.push({t: word, c: cat}));
    });

    const bonusPool = ["MAIN_FRAME_HACK", "MAFIA_CONNECTION", "CORE_DATABASE", "SYSTEM_OVERRIDE"];
    
    // 2. ì´ˆê¸°í™”
    let active = false, isAlert = false, monTeams = {};
    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_v1');

    function startGame() {
        document.getElementById('round-selector').style.display = 'none';
        const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
        db.set({ state: 'START', cards: {}, teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]}, bonus: "" });
        initBoard();
    }

    function initBoard() {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            allWords.forEach(item => {
                const c = document.createElement('div');
                c.className = 'card-container'; c.id = `c-${i}-${item.t}`;
                c.innerHTML = `<div class="card-inner"><div class="card-front">${item.t}</div><div class="card-back" id="bk-${i}-${item.t}">${item.t}</div></div>`;
                b.appendChild(c);
            });
        }
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
        document.getElementById(`in-${id}`).disabled = false;
        document.getElementById(`in-${id}`).focus();
    }

    // 3. í†µì‹  ë° ë¡œì§
    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            monTeams = d.teams;
            for(let i=1; i<=4; i++) document.getElementById(`mon-${i}`).className = `monitor team-${d.teams[i]} ${document.getElementById(`mon-${i}`).classList.contains('focused')?'focused':''}`;
        }
        if(d.bonus) {
            document.getElementById('bonus-popup').style.display = 'block';
            document.getElementById('bonus-code').innerText = d.bonus;
        } else { document.getElementById('bonus-popup').style.display = 'none'; }
        
        if(d.cards) {
            let rCount = 0, bCount = 0;
            Object.keys(d.cards).forEach(w => {
                const team = d.cards[w].team;
                team === 'red' ? rCount++ : bCount++;
                for(let i=1; i<=4; i++) {
                    const c = document.getElementById(`c-${i}-${w}`);
                    if(c) { c.classList.add('is-flipped'); document.getElementById(`bk-${i}-${w}`).className = `card-back back-${team}`; }
                }
            });
            document.getElementById('score-red').innerText = rCount;
            document.getElementById('score-blue').innerText = bCount;
        }
    });

    function handleInput(e, id) {
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            const team = monTeams[id];
            if(isAlert) { punish(team); }
            else if(val === document.getElementById('bonus-code').innerText) { steal(team); db.update({bonus:""}); }
            else if(allWords.some(w => w.t === val)) { db.child('cards').child(val).set({team: team}); }
            e.target.value = '';
        }
    }

    function punish(team) {
        db.child('cards').once('value', s => {
            const c = s.val(); if(!c) return;
            const mine = Object.keys(c).filter(k => c[k].team === team);
            mine.slice(-5).forEach(k => db.child('cards').child(k).remove());
        });
    }

    function steal(team) {
        db.child('cards').once('value', s => {
            const c = s.val(); if(!c) return;
            const enemy = Object.keys(c).filter(k => c[k].team !== team);
            enemy.slice(-3).forEach(k => db.child('cards').child(k).update({team: team}));
        });
    }

    // 4. íƒ€ì´ë¨¸ ë° ê²°ê³¼ (ì˜¤ê°í˜• ì°¨íŠ¸)
    function startTimer() {
        let time = 600;
        const intr = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            let sLeft = time % 100;
            document.getElementById('shuffle-bar').style.width = sLeft + "%";
            
            isAlert = (sLeft < 20 && sLeft > 0);
            if(time % 100 === 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]}, bonus: bonusPool[Math.floor(Math.random()*4)] });
            }

            for(let i=1; i<=4; i++) {
                const s = document.getElementById(`sec-${i}`);
                if(isAlert) { s.innerText = "ğŸš¨ ë ˆì´ì € ê°€ë™! ì…ë ¥ ì¤‘ì§€! ğŸš¨"; s.classList.add('alert'); }
                else { s.innerText = "ğŸ“¡ ê²½ë¡œ ì•ˆì •: " + monTeams[i].toUpperCase(); s.classList.remove('alert'); }
            }

            if(time <= 0) { clearInterval(intr); showResult(); }
        }, 100);
    }

    function showResult() {
        active = false;
        document.getElementById('result-screen').style.display = 'flex';
        db.child('cards').once('value', snap => {
            const cards = snap.val() || {};
            const scores = { red: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 }, blue: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 } };
            
            Object.keys(cards).forEach(w => {
                const info = allWords.find(item => item.t === w);
                if(info) scores[cards[w].team][info.c]++;
            });

            drawChart('chart-red', scores.red, '#FF4757');
            drawChart('chart-blue', scores.blue, '#2E86DE');
        });
    }

    function drawChart(id, data, color) {
        new Chart(document.getElementById(id), {
            type: 'radar',
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: 'ì¡°ì§ ì¥ì•…ë„',
                    data: Object.values(data),
                    backgroundColor: color + '66',
                    borderColor: color,
                    borderWidth: 3
                }]
            },
            options: {
                scales: { r: { beginAtZero: true, grid: {color: '#333'}, angleLines: {color: '#333'}, ticks: {display: false} } },
                plugins: { legend: { display: false } }
            }
        });
    }
</script>
</body>
</html>
