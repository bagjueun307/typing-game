<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MAFIA: EMPIRE EVOLUTION</title>
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --red: #FF4757; --blue: #2E86DE; --yellow: #FECA57; --dark: #0A0A0F; --alert: #FF0000; }
        body { background: var(--dark); color: #fff; font-family: 'DungGeunMo', sans-serif; margin: 0; overflow: hidden; }
        
        /* ìƒë‹¨ ë°” */
        #top-bar { position: fixed; top: 0; left: 0; right: 0; height: 110px; background: #15151A; border-bottom: 4px solid var(--yellow); display: flex; justify-content: space-around; align-items: center; z-index: 6000; }
        .mini-chart-wrap { width: 140px; height: 100px; display: flex; flex-direction: column; align-items: center; }
        #timer-disp { font-size: 2.8rem; color: var(--yellow); text-shadow: 0 0 10px var(--yellow); }

        #room-view { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; padding: 140px 20px 20px 20px; height: 100vh; box-sizing: border-box; }
        .monitor { border: 5px solid #333; background: #000; display: flex; flex-direction: column; border-radius: 15px; position: relative; transition: 0.5s; overflow: hidden; }
        .monitor.focused { position: fixed !important; inset: 130px 30px 30px 30px; z-index: 5000; }
        
        /* ì˜¤ë²„ë ˆì´ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .guard-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* ì¹´ë“œ ë³´ë“œ */
        .board { display: grid; grid-template-columns: repeat(12, 1fr); gap: 3px; flex: 1; padding: 10px; background: #050505; overflow-y: auto; }
        .card { height: 45px; perspective: 600px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; inset: 0; backface-visibility: hidden; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        .card-front { background: #1A1A1A; border: 1px solid #333; }
        .card-back { transform: rotateY(180deg); color: white; border: 1.5px solid #fff; }
        .back-red { background: var(--red); }
        .back-blue { background: var(--blue); }
        .back-neutral { background: #444; }

        .security-bar { text-align: center; padding: 8px; background: #222; font-size: 0.9rem; }
        .security-bar.alert { background: var(--alert); animation: shake 0.1s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }

        .input-wrap { display: flex; height: 60px; border-top: 3px solid var(--yellow); }
        .input-box { flex: 1; background: #000; color: #fff; border: none; font-size: 1.8rem; text-align: center; outline: none; font-family: 'DungGeunMo'; }

        /* ì§„í™” ì •ë³´ */
        .evolution-status { margin-top: 10px; font-size: 0.8rem; color: #aaa; }
        .upgrade-badge { background: var(--yellow); color: #000; padding: 2px 5px; border-radius: 3px; font-weight: bold; margin-left: 5px; }

        button { padding: 15px 30px; font-family: 'DungGeunMo'; cursor: pointer; background: var(--yellow); border: none; font-size: 1.1rem; margin-top: 10px; }
    </style>
</head>
<body>

<div id="step-selector" class="overlay">
    <h1 id="evo-title" style="color:var(--yellow); font-size: 3rem;">êµ­ê°€ ê¸°ì´ˆ ì„¤ë¦½ ë‹¨ê³„</h1>
    <p id="evo-desc" style="color: #aaa; margin-bottom: 20px;">ê° ì˜ì—­ë‹¹ 20ê°œ ì´ìƒì˜ ë‹¨ì–´ë¥¼ ì ë ¹í•˜ì—¬ ê°œë„êµ­ìœ¼ë¡œ ì§„í™”í•˜ì‹­ì‹œì˜¤.</p>
    <div id="status-container" style="display:flex; gap:10px; margin-bottom:20px;"></div>
    <button id="start-round-btn" onclick="startReady()">í˜„ì¬ ë‹¨ê³„ ì¹¨íˆ¬ ì‹œì‘</button>
</div>

<div id="top-bar">
    <div class="mini-chart-wrap"><canvas id="live-chart-red"></canvas></div>
    <div style="text-align: center;">
        <div id="current-step-disp" style="color:var(--yellow); letter-spacing: 2px;">ê¸°ì´ˆ ë‹¨ê³„</div>
        <div id="timer-disp">120.0s</div>
    </div>
    <div class="mini-chart-wrap"><canvas id="live-chart-blue"></canvas></div>
</div>

<div id="room-view">
    <script>
        for(let i=1; i<=4; i++) {
            document.write(`
                <div class="monitor" id="mon-${i}" onclick="focusMon(${i})">
                    <div class="guard-layer" id="guard-${i}" style="display:none;">
                        <h2>ì‹œìŠ¤í…œ ì ‘ê·¼ ê¶Œí•œ ëŒ€ê¸°</h2>
                        <button onclick="requestStart(event, ${i})">ì¹¨íˆ¬ ê°œì‹œ</button>
                    </div>
                    <div id="cd-${i}" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:8rem; color:var(--yellow); z-index:1100; display:none;">3</div>
                    <div class="security-bar" id="sec-${i}">ì—°ê²° ëŒ€ê¸°</div>
                    <div class="board" id="board-${i}"></div>
                    <div class="input-wrap"><input type="text" id="in-${i}" class="input-box" onkeydown="handleInput(event, ${i})" placeholder="ëª¨ë‹ˆí„° ì„ íƒ" disabled></div>
                </div>
            `);
        }
    </script>
</div>

<div id="result-screen" class="overlay" style="display:none;">
    <h1 style="font-size: 3rem; color: var(--yellow);">ROUND ANALYSIS</h1>
    <p id="next-evo-msg" style="color:#fff; margin-bottom:20px;"></p>
    <div style="display: flex; gap: 40px; margin-bottom: 20px;">
        <canvas id="final-chart-red" width="300" height="300"></canvas>
        <canvas id="final-chart-blue" width="350" height="350"></canvas>
    </div>
    <p id="auto-close-timer">20ì´ˆ í›„ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
</div>

<script>
    // 1. ë‹¨ì–´ ë°ì´í„° (ì˜ì—­ë‹¹ ìµœì†Œ 25~30ê°œ ë°°ì¹˜í•˜ì—¬ 20ê°œ ë‹¬ì„± ê°€ëŠ¥í•˜ê²Œ í•¨)
    const industryData = {
        1: { // ê¸°ì´ˆ
            'ì—ë„ˆì§€': ['ì„íƒ„','ë•”ê°','ì„ìœ ','ë“±ìœ ','ì „ê¸°','ë°œì „ì†Œ','ì „ì„ ','ê°€ìŠ¤','í™”ë ¥','ëŒ','ìœ ì •','íƒ„ê´‘','í’ì°¨','ì¥ì‘','ë‚œë¡œ','ì–‘ì´ˆ','ì„±ëƒ¥','ê¸°ë¦„','ì¶•ì „ì§€','ë³€ì••ê¸°','íšƒë¶ˆ','ì¦ê¸°','ë§¤ì—°','êµ´ëš','êµ¬ë¦¬'],
            'ì œì¡°': ['ì² ê°•','ë°©ì§','ë²½ëŒ','ì‹œë©˜íŠ¸','ëª©ì¬','ê¸ˆì†','ë¹„ë£Œ','í”Œë¼ìŠ¤í‹±','í•©íŒ','ê³ ë¬´','ì„¬ìœ ','ë² í‹€','ë°©ì•—ê°„','ëŒ€ì¥ê°„','ë§ì¹˜','í†±','ë°”ëŠ˜','ë‹¨ì¶”','ê°€ì£½','ì¢…ì´','ê³µêµ¬','ë‚˜ì‚¬','ëª»','íŒì','í¬ëŒ€'],
            'ê¸ˆìœµ': ['í˜„ê¸ˆ','ê¸ˆê³ ','ì‹œì¥','ê±°ë˜','í™”í','ì€í–‰','ì¥ë¶€','ì „í‘œ','ê¸ˆê´´','í™˜ì „','ì£¼í™”','ë™ì „','ìƒì ','ì§€ê°‘','ìˆ˜ì²©','ê³„ì‚°ê¸°','ì£¼íŒ','ë¬¼ë¬¼êµí™˜','ê¸ˆë¦¬','ì˜ˆê¸ˆ','ì¶œê¸ˆ','ì°¨ìš©ì¦','ë‚™ì°°','ë§¤ë§¤','ì €ê¸ˆí†µ'],
            'ê¸°ìˆ ': ['ë¼ë””ì˜¤','íƒ€ìê¸°','ì—”ì§„','ëª¨í„°','ê¸°ì–´','ë²¨ë¸Œ','íšŒë¡œ','ì „êµ¬','ë‚˜ì¹¨ë°˜','ì‹œê³„','ì¸ì‡„ê¸°','ì•ˆê²½','í˜„ë¯¸ê²½','ë§ì›ê²½','ë„ë¥´ë˜','ì§€ë ›ëŒ€','í’€ë¦¬','í”¼ìŠ¤í†¤','ë² ì–´ë§','ë‚©ë•œ','ë Œì¦ˆ','ì „ì‹ ê¸°','ì¶•ìŒê¸°','í•„ë¦„','ì¹´ë©”ë¼'],
            'ì¸ì ìë³¸': ['ë†ë¶€','ê·¼ë¡œì','êµì‹¤','ë³´ê±´ì†Œ','ì˜ì›','ê¸°ëŠ¥ê³µ','ì‹ëŸ‰','ì˜ìš©êµ°','ì‹¬ë¶€ë¦„','ì¥í„°','ë§ˆì„','ì¹ íŒ','êµê³¼ì„œ','ì—°í•„','ì§€ìš°ê°œ','ê³µì±…','ì•½ì´ˆ','ì¹¨ìˆ ','ìš°ì²´ë¶€','ì´ì¥','ì„ ìƒë‹˜','í•™ìƒ','ì˜ì‚¬','ê°„í˜¸ì‚¬','ì¡°ìˆ˜']
        },
        // 2, 3ë‹¨ê³„ë„ ì´ì™€ ê°™ì€ ê·œëª¨ë¡œ í™•ì¥ë˜ì–´ ìˆë‹¤ê³  ê°€ì • (ìƒëµ)
    };

    let currentStep = 1;
    let evolutionProgress = { 'ì—ë„ˆì§€': false, 'ì œì¡°': false, 'ê¸ˆìœµ': false, 'ê¸°ìˆ ': false, 'ì¸ì ìë³¸': false };
    let active = false, isAlert = false, monTeams = {};
    let liveCharts = {}, finalCharts = {};
    let timerInterval;

    const db = firebase.initializeApp({ databaseURL: "https://play1-d0379-default-rtdb.firebaseio.com/" }).database().ref('mafia_empire_v3');

    // ë‹¨ê³„ë³„ UI ì´ˆê¸°í™”
    function startReady() {
        document.getElementById('step-selector').style.display = 'none';
        const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
        db.set({ state: 'READY', cards: {}, teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]}, bonus: "" });
        initBoard(currentStep);
        initLiveCharts();
        for(let i=1; i<=4; i++) document.getElementById(`guard-${i}`).style.display = 'flex';
    }

    function initBoard(step) {
        const stepWords = industryData[step] || industryData[1];
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`board-${i}`);
            b.innerHTML = "";
            Object.keys(stepWords).forEach(cat => {
                stepWords[cat].forEach(word => {
                    const c = document.createElement('div');
                    c.className = 'card'; c.id = `c-${i}-${word}`;
                    c.innerHTML = `<div class="card-inner"><div class="card-front">${word}</div><div class="card-back" id="bk-${i}-${word}">${word}</div></div>`;
                    b.appendChild(c);
                });
            });
        }
    }

    function requestStart(e, id) {
        e.stopPropagation();
        document.getElementById(`guard-${id}`).style.display = 'none';
        const cd = document.getElementById(`cd-${id}`);
        cd.style.display = 'block';
        let c = 3;
        const intr = setInterval(() => {
            c--; if(c > 0) cd.innerText = c;
            else {
                clearInterval(intr); cd.style.display = 'none';
                db.update({ state: 'START' });
                document.getElementById(`in-${id}`).disabled = false;
                document.getElementById(`in-${id}`).focus();
            }
        }, 1000);
    }

    db.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.state === 'START' && !active) { active = true; startTimer(); }
        if(d.teams) {
            monTeams = d.teams;
            for(let i=1; i<=4; i++) document.getElementById(`mon-${i}`).style.borderColor = (d.teams[i] === 'red' ? 'var(--red)' : 'var(--blue)');
        }
        if(d.cards) {
            const scores = { red: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 }, blue: { 'ì—ë„ˆì§€':0,'ì œì¡°':0,'ê¸ˆìœµ':0,'ê¸°ìˆ ':0,'ì¸ì ìë³¸':0 } };
            Object.keys(d.cards).forEach(w => {
                const team = d.cards[w].team;
                const cat = findCategory(w);
                if(cat && team !== 'neutral') scores[team][cat]++;
                for(let i=1; i<=4; i++) {
                    const c = document.getElementById(`c-${i}-${w}`);
                    if(c) c.classList.toggle('is-flipped', team !== 'neutral');
                }
            });
            updateCharts(scores);
            checkEvolution(scores);
        }
    });

    function findCategory(word) {
        const stepWords = industryData[currentStep] || industryData[1];
        for(let cat in stepWords) if(stepWords[cat].includes(word)) return cat;
        return null;
    }

    function handleInput(e, id) {
        const team = monTeams[id];
        if(isAlert) { neutralize(team); e.target.value = ""; return; }
        if(e.key === 'Enter') {
            const val = e.target.value.trim();
            if(findCategory(val)) db.child('cards').child(val).set({ team: team });
            e.target.value = "";
        }
    }

    function neutralize(team) {
        db.child('cards').once('value', s => {
            const c = s.val(); if(!c) return;
            const mine = Object.keys(c).filter(k => c[k].team === team);
            if(mine.length > 0) db.child('cards').child(mine[mine.length-1]).set({ team: 'neutral' });
        });
    }

    function startTimer() {
        let time = 1200;
        timerInterval = setInterval(() => {
            time--;
            document.getElementById('timer-disp').innerText = (time/10).toFixed(1) + "s";
            
            // 10ì´ˆë§ˆë‹¤ íŒ€ ì…”í”Œ
            if(time > 0 && time % 100 === 0) {
                const ts = ['red','red','blue','blue'].sort(()=>Math.random()-0.5);
                db.update({ teams: {1:ts[0], 2:ts[1], 3:ts[2], 4:ts[3]} });
            }

            let cycle = time % 100;
            isAlert = (cycle < 20 && cycle > 0); 

            for(let i=1; i<=4; i++) {
                const s = document.getElementById(`sec-${i}`);
                if(isAlert) { s.innerText = "ğŸš¨ ë³´ì•ˆ ë ˆì´ì €! íƒ€ì ê¸ˆì§€! ğŸš¨"; s.classList.add('alert'); }
                else { s.innerText = "ğŸ“¡ ê²½ë¡œ ì•ˆì •: " + monTeams[i].toUpperCase(); s.classList.remove('alert'); }
            }

            if(time <= 0) { clearInterval(timerInterval); endRound(); }
        }, 100);
    }

    function checkEvolution(scores) {
        // ì–´ëŠ í•œ íŒ€ì´ë¼ë„ ì˜ì—­ë³„ 20ê°œë¥¼ ë‹¬ì„±í•˜ë©´ í•´ë‹¹ ì˜ì—­ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥ ì²˜ë¦¬
        const categories = ['ì—ë„ˆì§€','ì œì¡°','ê¸ˆìœµ','ê¸°ìˆ ','ì¸ì ìë³¸'];
        categories.forEach(cat => {
            if(scores.red[cat] >= 20 || scores.blue[cat] >= 20) evolutionProgress[cat] = true;
        });
    }

    function endRound() {
        active = false;
        document.getElementById('result-screen').style.display = 'flex';
        renderFinalCharts();

        let timeLeft = 20;
        const autoIntr = setInterval(() => {
            timeLeft--;
            document.getElementById('auto-close-timer').innerText = `${timeLeft}ì´ˆ í›„ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤...`;
            if(timeLeft <= 0) {
                clearInterval(autoIntr);
                goToLobby();
            }
        }, 1000);
    }

    function goToLobby() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('step-selector').style.display = 'flex';
        
        // 5ê°œ ì˜ì—­ì´ ëª¨ë‘ ë‹¬ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        const allClear = Object.values(evolutionProgress).every(v => v === true);
        if(allClear) {
            currentStep++;
            evolutionProgress = { 'ì—ë„ˆì§€': false, 'ì œì¡°': false, 'ê¸ˆìœµ': false, 'ê¸°ìˆ ': false, 'ì¸ì ìë³¸': false };
            alert("ì¶•í•˜í•©ë‹ˆë‹¤! êµ­ê°€ ë‹¨ê³„ê°€ ì§„í™”í–ˆìŠµë‹ˆë‹¤!");
        }

        const titles = ["", "êµ­ê°€ ê¸°ì´ˆ ì„¤ë¦½ ë‹¨ê³„", "ê°œë°œ ë„ìƒêµ­ ë‹¨ê³„", "ì„ ì§„êµ­ ë„ì•½ ë‹¨ê³„"];
        document.getElementById('evo-title').innerText = titles[currentStep];
        
        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        let html = "";
        Object.keys(evolutionProgress).forEach(cat => {
            html += `<div style="padding:10px; border:1px solid #555;">${cat}: ${evolutionProgress[cat] ? '<span class="upgrade-badge">UPGRADE!</span>' : 'ì§„í–‰ì¤‘'}</div>`;
        });
        document.getElementById('status-container').innerHTML = html;
    }

    // ì°¨íŠ¸ ë¡œì§ (ì´ì „ê³¼ ë™ì¼í•˜ë˜ 20ì  ê¸°ì¤€ ê°€ì´ë“œ ì¶”ê°€)
    function initLiveCharts() {
        const labels = ['ì—ë„ˆì§€','ì œì¡°','ê¸ˆìœµ','ê¸°ìˆ ','ì¸ì ìë³¸'];
        const cfg = (color) => ({
            type: 'radar',
            data: { labels, datasets: [{ data: [0,0,0,0,0], borderColor: color, backgroundColor: color+'33' }] },
            options: { scales: { r: { min:0, max:25, ticks:{display:false} } }, plugins:{legend:{display:false}} }
        });
        if(liveCharts.red) { liveCharts.red.destroy(); liveCharts.blue.destroy(); }
        liveCharts.red = new Chart(document.getElementById('live-chart-red'), cfg('#FF4757'));
        liveCharts.blue = new Chart(document.getElementById('live-chart-blue'), cfg('#2E86DE'));
    }

    function updateCharts(scores) {
        liveCharts.red.data.datasets[0].data = Object.values(scores.red);
        liveCharts.blue.data.datasets[0].data = Object.values(scores.blue);
        liveCharts.red.update(); liveCharts.blue.update();
    }

    function focusMon(id) {
        document.querySelectorAll('.monitor').forEach(m => m.classList.remove('focused'));
        document.getElementById(`mon-${id}`).classList.add('focused');
    }
</script>
</body>
</html>
